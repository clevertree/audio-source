(function(){class AudioSourceComposerElement extends HTMLElement{constructor(){super(),this.versionString="-1",this.eventHandlers=[],this.saveSongToMemoryTimer=null,this.longPressTimeout=null,this.doubleClickTimeout=500,this.autoSaveTimeout=4e3,this.keyboard=new AudioSourceComposerKeyboard,this.song=new AudioSourceSong({},this),this.shadowDOM=null,this.actions=new AudioSourceComposerActions(this),this.values=new AudioSourceValues(this.song),(new AudioSourceUtilities).loadPackageInfo().then(e=>this.setVersion(e.version)),window.addEventListener("unload",e=>this.saveState(e))}get trackerElm(){return this.shadowDOM.querySelector("asc-tracker")}get containerElm(){return this.shadowDOM.querySelector(".asc-container")}getScriptDirectory(e=null){return(new AudioSourceUtilities).getScriptDirectory(e)}get defaultLibraryURL(){return this.getAttribute("defaultLibraryURL")||this.getScriptDirectory("default.library.json")}set defaultLibraryURL(e){this.setAttribute("defaultLibraryURL",e)}connectedCallback(){this.loadCSS(),this.attachEventHandler(["focus"],e=>this.onInput(e),this.shadowDOM,!0),this.attachEventHandler(["song:loaded","song:play","song:end","song:stop","song:modified","song:seek","group:play","group:seek","note:start","note:end"],this.onSongEvent),this.attachEventHandler(["instrument:instance","instrument:library","instrument:modified","instrument:loaded"],e=>this.onSongEvent(e),document),this.render(),this.focus(),this.loadState(),(new MIDISupport).loadMIDIInterface(e=>this.onInput(e))}disconnectedCallback(){this.eventHandlers.forEach(e=>e[2].removeEventListener(e[0],e[1]))}attachEventHandler(e,t,n,s=null){Array.isArray(e)||(e=[e]);for(let r=0;r<e.length;r++){const o=e[r];(n=n||this).addEventListener(o,t,s),this.eventHandlers.push([o,t,n])}}async loadState(e=null){const t=(new AudioSourceStorage).loadState();console.log("loadState",t),t?(await this.loadDefaultSong(t.songGUID),t.volume&&this.actions.setSongVolume(e,t.volume),this.trackerElm.groupName=t.groupName,t.trackerSegmentLength&&(this.trackerElm.fieldTrackerSegmentLength.value=t.trackerSegmentLength),t.trackerRowLength&&(this.trackerElm.fieldTrackerRowLength.value=t.trackerRowLength),t.trackerInstrument&&(this.trackerElm.fieldTrackerInstrument.value=t.trackerInstrument),t.trackerOctave&&(this.trackerElm.fieldTrackerOctave.value=t.trackerOctave),this.trackerElm.navigateSegment(t.currentRowSegmentID),t.selectedIndicies&&this.trackerElm.selectIndicies(e,t.selectedIndicies)):await this.loadDefaultSong()}async saveState(e){const t={songGUID:this.song.guid,groupName:this.trackerElm.groupName,volume:this.song.getVolumeValue(),currentRowSegmentID:this.trackerElm.currentRowSegmentID,trackerSegmentLength:this.trackerElm.fieldTrackerSegmentLength.value,trackerRowLength:this.trackerElm.fieldTrackerRowLength.value,trackerInstrument:this.trackerElm.fieldTrackerInstrument.value,trackerOctave:this.trackerElm.fieldTrackerOctave.value,selectedIndicies:this.trackerElm.getSelectedIndicies()};(new AudioSourceStorage).saveState(t),console.log("saveState",t)}async loadDefaultSong(e=null){const t=this.getAttribute("src");return t?(await this.actions.loadSongFromSrc(t),!0):e?void await this.actions.loadSongFromMemory(e):(await this.actions.loadNewSongData(),!1)}getAudioContext(){return this.song.getAudioContext()}updateSongPositionValue(e){const t=new AudioSourceValues;this.fieldSongPosition.value=t.formatPlaybackPosition(e)}onInput(e){if(!e.defaultPrevented){switch(e.type){case"focus":break;default:this.song.getAudioContext()}switch(e.type){case"focus":const t=e.path[0].closest("asui-form");t&&(t.getRootNode().querySelectorAll("asui-form.focus").forEach(e=>e.classList.remove("focus")),t.classList.add("focus"))}}}async onSongEvent(e){switch(this.trackerElm&&this.trackerElm.onSongEvent(e),e.type){case"song:seek":this.updateSongPositionValue(e.detail.position);break;case"song:volume":this.fieldSongVolume.value=e.detail.volume;break;case"song:loaded":this.trackerElm.renderDuration=this.song.timeDivision;break;case"song:play":this.classList.add("playing"),this.containerElm.classList.add("playing"),this.fieldSongPlaybackPause.disabled=!1;const t=setInterval(e=>{this.song.isPlaying||(clearInterval(t),this.fieldSongPlaybackPause.disabled=!0,this.containerElm.classList.remove("playing"),this.classList.remove("playing")),this.updateSongPositionValue(this.song.songPlaybackPosition)},10);break;case"song:pause":this.classList.add("paused"),this.containerElm.classList.add("paused");break;case"song:end":this.classList.remove("playing","paused"),this.containerElm.classList.remove("playing","paused");break;case"instrument:instance":this.renderInstrument(e.detail.instrumentID,e.detail.instance);break;case"instrument:modified":case"song:modified":switch(e.type){case"instrument:modified":this.renderInstruments(),this.trackerElm&&this.trackerElm.renderForms()}clearTimeout(this.saveSongToMemoryTimer),this.saveSongToMemoryTimer=setTimeout(e=>this.actions.saveSongToMemory(e),this.autoSaveTimeout);break;case"instrument:loaded":case"instrument:remove":this.renderInstruments(),this.trackerElm&&this.trackerElm.renderForms();break;case"instrument:library":this.renderSongForms(),this.trackerElm&&this.trackerElm.renderForms()}}setStatus(e){this.statusElm.innerHTML=e,console.info.apply(null,arguments)}handleError(e){this.statusElm.innerHTML=`<span style="red">${e}</span>`,console.error(e)}setVersion(e){this.versionString=e,this.versionElm.innerHTML=e}closeAllMenus(){this.shadowDOM.querySelector("asui-menu").closeAllMenus()}get statusElm(){return this.shadowDOM.querySelector(".asc-status-container .status-text")}get versionElm(){return this.shadowDOM.querySelector(".asc-status-container .version-text")}get menuFile(){return this.shadowDOM.querySelector('asui-menu[key="file"]')}get menuEdit(){return this.shadowDOM.querySelector('asui-menu[key="edit"]')}get menuView(){return this.shadowDOM.querySelector('asui-menu[key="view"]')}get menuGroup(){return this.shadowDOM.querySelector('asui-menu[key="group"]')}get menuInstrument(){return this.shadowDOM.querySelector('asui-menu[key="instrument"]')}get menuContext(){return this.shadowDOM.querySelector('asui-menu[key="context"]')}get panelSong(){return this.shadowDOM.querySelector("asui-form[key='song']")}get panelTracker(){return this.shadowDOM.querySelector("asui-form[key='tracker']")}get panelTrackerGroups(){return this.shadowDOM.querySelector("asui-form[key='tracker-groups']")}get panelTrackerRowSegments(){return this.shadowDOM.querySelector("asui-form[key='tracker-row-segments']")}get panelInstruction(){return this.shadowDOM.querySelector("asui-form[key='instruction']")}get panelInstruments(){return this.shadowDOM.querySelector("asui-form[key='instruments']")}render(e=!1){const t=new AudioSourceUtilities,n=t.getScriptDirectory("composer/audio-source-composer.css"),s=t.getScriptDirectory("common/audio-source-common.css");let r=!0;!e&&this.shadowDOM||(r=!1,this.shadowDOM=this.shadowDOM||this.attachShadow({mode:"open"}),this.shadowDOM.innerHTML=`\n            <link rel="stylesheet" href="${n}" />\n            <link rel="stylesheet" href="${s}" />\n            <div class="asc-container">\n                <div class="asui-menu-container">\n                    <asui-menu key="file" caption="File"></asui-menu>\n                    <asui-menu key="edit" caption="Edit"></asui-menu>\n                    <asui-menu key="group" caption="Group"></asui-menu>\n                    <asui-menu key="instrument" caption="Instrument"></asui-menu>\n                    <asui-menu key="view" caption="View"></asui-menu>\n                    <asui-menu key="context" caption=""></asui-menu>\n                </div>\n                <asui-form key="song" caption="Song" class="panel"></asui-form>\x3c!--\n                --\x3e<asui-form key="instruments" caption="Song Instruments" class="panel"></asui-form>\n                <asui-form key="instruction" caption="Selected Instruction(s)" class="panel"></asui-form>\x3c!--\n                --\x3e<asui-form key="tracker" caption="Tracker" class="panel"></asui-form>\x3c!--\n                --\x3e<asui-form key="tracker-groups" caption="Tracker Groups" class="panel"></asui-form>\x3c!--\n                --\x3e<asui-form key="tracker-row-segments" caption="Tracker Segments" class="panel"></asui-form>\n                <asc-tracker group="root"></asc-tracker>\n            </div>\n            <div class="asc-status-container">\n                <span class="status-text"></span>\n                <a href="https://github.com/clevertree/audio-source-composer" target="_blank" class="version-text">${this.versionString}</a>\n            </div>\n            `),this.containerElm.classList.toggle("fullscreen",this.classList.contains("fullscreen")),this.renderMenu(),this.renderSongForms(),this.renderInstruments(),r&&this.trackerElm.render()}renderSongForms(){const e=this.panelSong;e.hasInput("playback")||(this.formSongPlayback=e.getOrCreateForm("playback","Playback"),this.formSongPosition=e.getOrCreateForm("position","Position"),this.formSongVolume=e.getOrCreateForm("volume","Volume"),this.formSongFile=e.getOrCreateForm("file","File"),this.formSongName=e.getOrCreateForm("name","Name"),this.formSongVersion=e.getOrCreateForm("version","Version")),this.formSongPlayback.hasInput("play")||(this.fieldSongPlaybackPlay=this.formSongPlayback.addButton("play",e=>this.actions.songPlay(e),this.formSongPlayback.createIcon("play"),"Play Song"),this.fieldSongPlaybackPause=this.formSongPlayback.addButton("pause",e=>this.actions.songPause(e),this.formSongPlayback.createIcon("pause"),"Pause Song"),this.fieldSongPlaybackStop=this.formSongPlayback.addButton("pause",e=>this.actions.songStop(e),this.formSongPlayback.createIcon("stop"),"Stop Song"),this.fieldSongFileLoad=this.formSongFile.addFileInput("file-load",e=>this.actions.loadSongFromFileInput(e),this.formSongPlayback.createIcon("file-load"),".json,.mid,.midi","Load Song from File"),this.fieldSongFileSave=this.formSongFile.addButton("file-save",e=>this.actions.saveSongToFile(e),this.formSongPlayback.createIcon("file-save"),"Save Song to File"),this.fieldSongVolume=this.formSongVolume.addRangeInput("volume",(e,t)=>this.actions.setSongVolume(e,t),1,100,"Song Volume",this.song.getVolumeValue()),this.fieldSongPosition=this.formSongPosition.addTextInput("position",e=>this.actions.setSongPosition(e),"Song Position","00:00:000"),this.fieldSongName=this.formSongName.addTextInput("name",(e,t)=>this.actions.setSongName(e,t),"Song Name"),this.fieldSongVersion=this.formSongVersion.addTextInput("version",(e,t)=>this.actions.setSongVersion(e,t))),this.fieldSongPlaybackPause.disabled=!0,this.fieldSongName.value=this.song.getName(),this.fieldSongVersion.value=this.song.getVersion(),this.fieldSongVolume.value=this.song.getVolumeValue()}renderInstrument(e,t=null){let n=this.panelInstruments.getOrCreateForm(e);const s=(e<10?"0":"")+e;if(n.clearInputs(),n.classList.add("instrument-container"),t||(n.addSelectInput("instrument-add-url",(e,t)=>this.actions.songAddInstrument(e,t),async e=>{e("","Add Instrument"),(await AudioSourceLibrary.loadURL(this.defaultLibraryURL)).eachInstrument(t=>{e(t.url,t.name)})},"Add Instrument"),n.addBreak()),t)try{if(n.addButton("instrument-id",null,s+":").classList.add("show-on-focus"),t instanceof HTMLElement)t.setAttribute("data-id",e+""),n.appendChild(t);else if("function"==typeof t.render){const e=t.render(n);e&&(n.innerHTML=e)}else n.innerHTML="No Renderer"}catch(e){n.innerHTML=e}}renderInstruments(){this.panelInstruments.clearInputs();const e=this.song.getInstrumentList();for(let t=0;t<e.length;t++){let e=this.song.getInstrument(t,!1);this.renderInstrument(t,e)}this.renderInstrument(e.length,null)}renderMenu(){this.menuFile.populate=(e=>{const t=e.menuElement;t.getOrCreateSubMenu("new","New song").action=(e=>this.actions.loadNewSongData(e));const n=t.getOrCreateSubMenu("open","Open song ►");n.populate=(e=>{n.getOrCreateSubMenu("memory","from Memory ►").populate=(async e=>{const t=e.menuElement,n=new AudioSourceStorage,s=await n.getRecentSongList();for(let e=0;e<s.length;e++){const n=s[e];t.getOrCreateSubMenu(n.guid,n.title).action=(e=>{this.actions.loadSongFromMemory(n.guid)})}}),n.getOrCreateSubMenu("file","from File").action=(e=>this.fieldSongFileLoad.inputElm.click()),n.getOrCreateSubMenu("url","from URL").disabled=!0});const s=t.getOrCreateSubMenu("save","Save song ►");s.populate=(e=>{s.getOrCreateSubMenu("memory","to Memory").action=(e=>this.actions.saveSongToMemory(e)),s.getOrCreateSubMenu("file","to File").action=(e=>this.actions.saveSongToFile(e))});const r=t.getOrCreateSubMenu("import","Import song ►");r.populate=(e=>{r.getOrCreateSubMenu("midi","from MIDI File").action=(e=>this.fieldSongFileLoad.inputElm.click())});const o=t.getOrCreateSubMenu("export","Export song ►");o.disabled=!0,o.populate=(e=>{o.getOrCreateSubMenu("midi","to MIDI File").disabled=!0})}),this.menuView.populate=(e=>{const t=e.menuElement;t.getOrCreateSubMenu("fullscreen",`${this.classList.contains("fullscreen")?"Disable":"Enable"} Fullscreen`).action=(e=>this.actions.toggleFullscreen(e)),t.getOrCreateSubMenu("forms-song",`${this.containerElm.classList.contains("hide-panel-song")?"Show":"Hide"} Song Forms `).action=(e=>this.actions.togglePanelSong(e)),t.getOrCreateSubMenu("forms-tracker",`${this.containerElm.classList.contains("hide-panel-tracker")?"Show":"Hide"} Track Forms`).action=(e=>this.actions.togglePanelTracker(e)),t.getOrCreateSubMenu("forms-instruments",`${this.containerElm.classList.contains("hide-panel-instruments")?"Show":"Hide"} Instrument Forms`).action=(e=>this.actions.togglePanelInstruments(e))}),this.menuInstrument.populate=(e=>{const t=e.menuElement;t.getOrCreateSubMenu("instrument","Add Instrument To Song ►").populate=(async e=>{const t=e.menuElement;(await AudioSourceLibrary.loadURL(this.defaultLibraryURL)).eachInstrument(e=>{t.getOrCreateSubMenu(e.url,`${e.name}`).action=(t=>{this.actions.songAddInstrument(t,e)})})});let n=0;this.values.getValues("song-instruments",(e,s)=>{const r=this.song.isInstrumentLoaded(e),o=t.getOrCreateSubMenu(e,`${s} ►`);o.populate=(t=>{const n=t.menuElement;n.getOrCreateSubMenu("change","Replace ►").populate=(async t=>{const n=t.menuElement;(await AudioSourceLibrary.loadURL(this.defaultLibraryURL)).eachInstrument(t=>{n.getOrCreateSubMenu(t.url,`${t.name}`).action=(n=>{this.actions.songReplaceInstrument(n,e,t)})})});const s=n.getOrCreateSubMenu("remove","Remove From Song");s.action=(t=>{this.actions.songRemoveInstrument(t,e)}),s.disabled=!r}),0===n&&(o.hasBreak=!0),n++})}),this.menuGroup.populate=(e=>{const t=e.menuElement;t.getOrCreateSubMenu("new","Add Group To Song").action=(e=>{this.actions.songGroupAddNew(e)});let n=0;this.values.getValues("song-groups",e=>{const s=t.getOrCreateSubMenu(e,`${e} ►`);s.populate=(t=>{const n=t.menuElement;n.getOrCreateSubMenu("change","Rename").action=(t=>{this.actions.songGroupRename(t,e)}),n.getOrCreateSubMenu("remove","Remove From Song").action=(t=>{this.actions.songGroupRemove(t,e)})}),0===n&&(s.hasBreak=!0),n++})})}get sources(){return{MidiParser:[this.getScriptDirectory("assets/3rdparty/MidiParser/main.js"),"https://cdn.jsdelivr.net/gh/colxi/midi-parser-js/src/main.js"],LZString:[this.getScriptDirectory("assets/3rdparty/LZString/lz-string.min.js"),"https://cdn.jsdelivr.net/gh/pieroxy/lz-string/libs/lz-string.min.js"]}}async loadJSLibrary(e,t=null){if(t||(t=(()=>void 0!==window[e])),t())return!0;const n=this.sources[e];for(let e=0;e<n.length;e++)if(await this.loadScript(n[e]),t())return!0;throw new Error(`Failed to load ${e} Library`)}async getMidiParser(){return void 0===window.MidiParser&&await this.loadJSLibrary("MidiParser"),window.MidiParser}async getLZString(){return void 0===window.LZString&&await this.loadJSLibrary("LZString"),window.LZString}async loadPackageInfo(e=!1){const t=(new AudioSourceUtilities).getScriptDirectory("package.json");let n=AudioSourceLibrary.packageInfo;if(!e&&n)return n;if(!(n=await this.loadJSON(t)).version)throw new Error("Invalid package version: "+t);return console.log("Package Version: ",n.version,n),AudioSourceLibrary.packageInfo=n,n}getScriptElement(){return document.head.querySelector('script[src$="audio-source-composer-element.js"],script[src$="audio-source-composer.min.js"]')}getScriptDirectory(e=""){return this.getScriptElement().src.split("/").slice(0,-2).join("/")+"/"+e}async loadScript(e){await new Promise((t,n)=>{const s=document.createElement("script");s.src=e,s.onload=(e=>t()),document.head.appendChild(s)})}async loadJSON(e){return e=new URL(e,document.location)+"",new Promise((t,n)=>{const s=new XMLHttpRequest;s.open("GET",e,!0),s.responseType="json",s.onload=(()=>{if(200!==s.status)return n("JSON file not found: "+e);t(s.response)}),s.send()})}loadCSS(){const e=this.shadowDOM||document.head;if(e.querySelector('link[href$="audio-source-composer.css"]'))return;const t=(new AudioSourceUtilities).getScriptDirectory("composer/audio-source-composer.css");let n=document.createElement("link");n.setAttribute("rel","stylesheet"),n.setAttribute("type","text/css"),n.setAttribute("href",t),e.appendChild(n),console.info("Appending "+t)}}customElements.define("audio-source-composer",AudioSourceComposerElement);class AudioSourceComposerTracker extends HTMLElement{constructor(){super(),this.editor=null,this.eventHandlers=[],this.currentRowSegmentID=0,this.mousePosition={},this.hasAttribute("tabindex")||this.setAttribute("tabindex","0")}get groupName(){return this.getAttribute("group")}set groupName(e){if(!this.editor.song.hasGroup(e))throw new Error("Group not found in song: "+e);this.setAttribute("group",e),this.currentRowSegmentID=0,this.render()}get isConnected(){return this.editor.containerElm.contains(this)}connectedCallback(){this.attachEventHandler(["scroll","keydown","mousedown","mouseup","mousemove","mouseout","touchstart","touchend","touchmove","dragstart","drag","dragend","contextmenu"],e=>this.onInput(e)),this.editor=this.getRootNode().host,this.render()}disconnectedCallback(){this.eventHandlers.forEach(e=>e[2].removeEventListener(e[0],e[1]))}attachEventHandler(e,t,n,s=null){Array.isArray(e)||(e=[e]);for(let r=0;r<e.length;r++){const i=e[r];(n=n||this).addEventListener(i,t,s),this.eventHandlers.push([i,t,n])}}clearSelection(e=[]){this.fieldTrackerSelection.value="",Array.isArray(e)||(e=[e]),this.parentNode.querySelectorAll("asct-instruction-add").forEach(t=>-1!==e.indexOf(t)?null:t.parentNode.removeChild(t)),this.querySelectorAll("asct-instruction.selected").forEach(t=>-1!==e.indexOf(t)?null:t.select(!1))}playSelectedInstructions(){this.editor.song.isPlaying&&this.editor.song.stopPlayback();const e=this.getSelectedIndicies();for(let t=0;t<e.length;t++)this.editor.song.playInstructionAtIndex(this.groupName,e[t])}getInstruction(e){return this.editor.song.getInstruction(this.groupName,e)}getInstructionFormValues(e=null){e||(e=this.fieldInstructionCommand.value);let t=new SongInstruction;(this.fieldInstructionInstrument.value||0===this.fieldInstructionInstrument.value)&&(t.instrument=parseInt(this.fieldInstructionInstrument.value)),this.fieldInstructionDuration.value&&(t.duration=parseFloat(this.fieldInstructionDuration.value));const n=parseInt(this.fieldInstructionVelocity.value);return(n||0===n)&&(t.velocity=n),e=this.replaceFrequencyAlias(e,t.instrument),t.command=e,t}render(){this.renderForms(),this.renderMenu(),this.renderRows()}navigateGroup(e){let t=this.findRowElement(e);if(t)return t;const n=this.getSegmentIDFromPositionInTicks(e);if(n!==this.currentRowSegmentID){this.navigateSegment(n);let t=this.findRowElement(e);if(t)return t}throw new Error("Shouldn't happen: Row not found for position: "+e)}getSegmentIDFromPositionInTicks(e){this.editor.song.timeDivision;const t=this.fieldTrackerSegmentLength.value;return Math.floor(e/t)}navigateSegment(e){this.currentRowSegmentID=e,this.renderRows()}renderForms(){const e=this.editor.panelInstruction;if(!e.hasInput("command")){this.formInstructionCommand=e.getOrCreateForm("command","Command"),this.formInstructionInstrument=e.getOrCreateForm("instrument","Instrument"),this.formInstructionVelocity=e.getOrCreateForm("velocity","Velocity"),this.formInstructionDuration=e.getOrCreateForm("duration","Duration");const t=this.editor.panelTracker;this.formTrackerRowLength=t.getOrCreateForm("row-length","Row &#120491;"),this.formTrackerSegmentLength=t.getOrCreateForm("segment-length","Seg &#120491;"),this.formTrackerInstrument=t.getOrCreateForm("instrument","Instrument"),this.formTrackerSelection=t.getOrCreateForm("selection","Selection"),this.formTrackerOctave=t.getOrCreateForm("octave","Octave")}this.formInstructionCommand.hasInput("command")||(this.fieldInstructionCommand=this.formInstructionCommand.addSelectInput("command",(e,t)=>this.editor.actions.setInstructionCommand(e,t),(e,t)=>{e("","Select"),t("Frequencies"),this.editor.values.getValues("note-frequency-all",e),t("Custom Frequencies"),this.editor.values.getValues("note-frequency-named",e),t("Groups"),this.editor.values.getValues("command-group-execute",e)},"Instruction Instrument"),this.fieldInstructionInsert=this.formInstructionCommand.addButton("insert",e=>this.editor.actions.insertInstructionCommand(e),this.formInstructionCommand.createIcon("insert"),"Insert Instruction"),this.fieldInstructionDelete=this.formInstructionCommand.addButton("delete",e=>this.editor.actions.deleteInstructionCommand(e),this.formInstructionCommand.createIcon("delete"),"Delete Instruction"),this.fieldInstructionInstrument=this.formInstructionInstrument.addSelectInput("instrument",e=>this.editor.actions.setInstructionInstrument(e),(e,t)=>{e("","Select"),t("Song Instruments"),this.editor.values.getValues("song-instruments",e)},"Instruction Instrument"),this.fieldInstructionVelocity=this.formInstructionVelocity.addRangeInput("velocity",(e,t)=>this.editor.actions.setInstructionVelocity(e,t),1,127),this.fieldInstructionDuration=this.formInstructionDuration.addSelectInput("duration",e=>this.editor.actions.setInstructionDuration(e),(e,t)=>{e("","No Duration"),this.editor.values.getValues("durations",e)},"Instruction Duration"),this.fieldTrackerInstrument=this.formTrackerInstrument.addSelectInput("filter-instrument",e=>this.editor.actions.setTrackerFilterInstrument(e),(e,t)=>{e("","No Filter"),t("Filter By Instrument"),this.editor.values.getValues("song-instruments",e)},"Filter By Instrument"),this.fieldTrackerRowLength=this.formTrackerRowLength.addSelectInput("row-length",e=>this.editor.actions.setTrackerRowLength(e),e=>{this.editor.values.getValues("durations",e)},"Select Row Length",this.editor.song.timeDivision),this.fieldTrackerSegmentLength=this.formTrackerSegmentLength.addSelectInput("segment-length",e=>this.editor.actions.setTrackerSegmentLength(e),e=>{this.editor.values.getValues("segment-lengths",e)},"Select Segment Length",16*this.editor.song.timeDivision),this.fieldTrackerSelection=this.formTrackerSelection.addTextInput("selection",e=>this.editor.actions.setTrackerSelection(e),"Selection","","No selection"),this.fieldTrackerOctave=this.formTrackerOctave.addSelectInput("octave",e=>this.editor.actions.setTrackerOctave(e),e=>{this.editor.values.getValues("note-frequency-octaves",e)},"Select Octave",3));let t=this.getSelectedIndicies();let n=this.editor.song.getInstructions(this.groupName,t)[0];n&&(this.fieldInstructionCommand.value=n.command,this.fieldInstructionInstrument.addOrSetValue(n.instrument,n.instrument+": Unknown Instrument"),this.fieldInstructionVelocity.value=n.velocity,this.fieldInstructionDuration.value=n.duration),this.fieldInstructionDelete.disabled=0===t.length,this.fieldTrackerRowLength.value||this.fieldTrackerRowLength.setValue(this.editor.song.timeDivision),!this.fieldInstructionDuration.value&&this.fieldTrackerRowLength.value&&this.fieldInstructionDuration.setValue(parseInt(this.fieldTrackerRowLength.value))}renderRows(e=null){null===e&&(e=this.getSelectedIndicies()),console.time("tracker.renderRows()");const t=this.editor.song.timeDivision;this.innerHTML="";let n=this.editor.song.getIterator(this.groupName);const s=parseInt(this.fieldTrackerRowLength.value)||t,r=parseInt(this.fieldTrackerSegmentLength.value)||16*t,i=this.fieldTrackerInstrument.value?parseInt(this.fieldTrackerInstrument.value):null;let o=null,c=0,a=0,l=0,u=null;for(;o=n.nextInstructionQuantizedRow(s,i);)null!==u&&(u.renderDelta(n.groupPositionInTicks-c),u=null),l=Math.floor(n.groupPositionInTicks/r),this.currentRowSegmentID===l&&(a=o.length>0?o[0].index:n.groupIndex,u=new AudioSourceComposerTrackerRow(n.groupPositionInTicks),this.appendChild(u),u.renderInstructions(o)),c=n.groupPositionInTicks;const d=this.editor.panelTrackerGroups;d&&(d.clearInputs(),Object.keys(this.editor.song.data.instructions).forEach((e,t)=>{d.addButton(e,t=>this.groupName=e,e).classList.toggle("selected",e===this.groupName)}),d.addButton("+",e=>this.editor.actions.songGroupAddNew(e),"+"));const h=this.editor.panelTrackerRowSegments;if(h){h.clearInputs(),l<this.currentRowSegmentID+1&&(l=this.currentRowSegmentID+1);for(let e=0;e<=l;e++){const t=h.addButton(e,t=>this.navigateSegment(e),e);h.classList.toggle("selected",e===this.currentRowSegmentID),t.classList.toggle("selected",e===this.currentRowSegmentID)}}this.selectSegmentIndicies(e),console.timeEnd("tracker.renderRows()")}renderMenu(){const e=this.editor,t=this.editor.menuEdit,n=this.editor.menuContext;t.populate=n.populate=(t=>{const n=t.menuElement,s=this.getSelectedIndicies();if(n.getOrCreateSubMenu("insert","Insert Command ►").populate=(t=>{const n=t.menuElement;n.getOrCreateSubMenu("frequency","Frequency ►").populate=(t=>{const n=t.menuElement;e.values.getValues("note-frequency-octaves",(t,s)=>{n.getOrCreateSubMenu(t,`Octave ${s} ►`).populate=(n=>{const s=n.menuElement;e.values.getValues("note-frequency",(n,r)=>{const i=n+t;s.getOrCreateSubMenu(i,`${r}${t}`).action=(t=>{e.trackerElm.fieldInstructionCommand.value=i,this.editor.actions.insertInstructionCommand(t,i)})})})})}),n.getOrCreateSubMenu("named","Named ►").populate=(t=>{const n=t.menuElement;e.values.getValues("note-frequency-named",(t,s,r)=>{n.getOrCreateSubMenu(t,t).action=(n=>{e.trackerElm.fieldInstructionCommand.value=t,this.editor.actions.insertInstructionCommand(n,t,!1,r)})})}),n.getOrCreateSubMenu("group","Group ►").populate=(t=>{const n=t.menuElement;e.values.getValues("song-groups",(t,s)=>{if(t===this.groupName)return;n.getOrCreateSubMenu(t,`${s}`).action=(n=>{const s="@"+t;e.trackerElm.fieldInstructionCommand.value=s,this.editor.actions.insertInstructionCommand(n,s)})});const s=n.getOrCreateSubMenu("new","Create New Group");s.action=(e=>this.editor.actions.songGroupAddNew(e)),s.hasBreak=!0});const s=n.getOrCreateSubMenu("custom","Custom Command");s.action=(e=>this.editor.actions.insertInstructionCommand(e,null,!0)),s.hasBreak=!0}),s.length>0){const t=n.getOrCreateSubMenu("set-command","Set Command ►");t.populate=(t=>{const n=t.menuElement;n.getOrCreateSubMenu("frequency","Frequency ►").populate=(t=>{const n=t.menuElement;e.values.getValues("note-frequency-octaves",(t,s)=>{n.getOrCreateSubMenu(t,`Octave ${s} ►`).populate=(n=>{const s=n.menuElement;e.values.getValues("note-frequency",(n,r)=>{const i=n+t;s.getOrCreateSubMenu(i,`${r}${t}`).action=(t=>{e.trackerElm.fieldInstructionCommand.value=i,this.editor.actions.setInstructionCommand(t,i)})})})})}),n.getOrCreateSubMenu("named","Named ►").populate=(t=>{const n=t.menuElement;e.values.getValues("note-frequency-named",(t,s,r)=>{n.getOrCreateSubMenu(t,t).action=(n=>{e.trackerElm.fieldInstructionCommand.value=t,this.editor.actions.setInstructionCommand(n,t,!1,r)})})}),n.getOrCreateSubMenu("group","Group ►").populate=(t=>{const n=t.menuElement;e.values.getValues("song-groups",(t,s)=>{if(t===this.groupName)return;n.getOrCreateSubMenu(t,`${s}`).action=(n=>{const s="@"+t;e.trackerElm.fieldInstructionCommand.value=s,this.editor.actions.setInstructionCommand(n,s)})});const s=n.getOrCreateSubMenu("new","Create New Group");s.action=(e=>this.editor.actions.songGroupAddNew(e)),s.hasBreak=!0});const s=n.getOrCreateSubMenu("custom","Custom Command");s.action=(e=>this.editor.actions.setInstructionCommand(e,null,!0)),s.hasBreak=!0}),t.disabled=0===s.length;const r=n.getOrCreateSubMenu("set-instrument","Set Instrument ►");r.populate=(t=>{const n=t.menuElement;e.values.getValues("song-instruments",(t,s)=>{n.getOrCreateSubMenu(t,`${s}`).action=(n=>{e.trackerElm.fieldInstructionInstrument.value=t,this.editor.actions.setInstructionInstrument(n,t)})})}),r.disabled=0===s.length;const i=n.getOrCreateSubMenu("set-duration","Set Duration ►");i.populate=(t=>{const n=t.menuElement;e.values.getValues("durations",(t,s)=>{n.getOrCreateSubMenu(t,`${s}`).action=(n=>{e.trackerElm.fieldInstructionDuration.value=t,this.editor.actions.setInstructionDuration(n,t)})});const s=n.getOrCreateSubMenu("custom","Custom Duration");s.action=(e=>this.editor.actions.setInstructionDuration(e,null,!0)),s.hasBreak=!0}),i.disabled=0===s.length;const o=n.getOrCreateSubMenu("set-velocity","Set Velocity ►");o.populate=(t=>{const n=t.menuElement;e.values.getValues("velocities",(t,s)=>{n.getOrCreateSubMenu(t,`${s}`).action=(n=>{e.trackerElm.fieldInstructionVelocity.value=t,this.editor.actions.setInstructionVelocity(n,t)})});const s=n.getOrCreateSubMenu("custom","Custom Velocity");s.action=(e=>this.editor.actions.setInstructionVelocity(e,null,!0)),s.hasBreak=!0}),o.disabled=0===s.length;const c=n.getOrCreateSubMenu("delete","Delete Instruction(s)");c.action=(e=>this.editor.actions.deleteInstructionCommand(e)),c.disabled=0===s.length}const r=n.getOrCreateSubMenu("select","Select ►");r.hasBreak=!0,r.populate=(e=>{const t=e.menuElement;t.getOrCreateSubMenu("segment","Select Segment Instructions").action=(e=>this.editor.actions.setTrackerSelection(e,"segment")),t.getOrCreateSubMenu("all","Select All Song Instructions").action=(e=>this.editor.actions.setTrackerSelection(e,"all")),t.getOrCreateSubMenu("none","Select No Instructions").action=(e=>this.editor.actions.setTrackerSelection(e,"none")),t.getOrCreateSubMenu("batch","Batch Select ►").populate=(e=>{const t=e.menuElement;t.getOrCreateSubMenu("new","New Selection Command").action=(e=>this.editor.actions.batchSelect(e));const n=(new AudioSourceStorage).getBatchRecentSearches();for(let e=0;e<n.length;e++){const s=n[e];t.getOrCreateSubMenu(e,s).action=(e=>{this.editor.actions.batchSelect(e,s,!0)})}})});const i=n.getOrCreateSubMenu("batch","Batch ►");i.hasBreak=!0,i.populate=(e=>{const t=e.menuElement;t.getOrCreateSubMenu("new","New Batch Command").action=(e=>this.editor.actions.batchRunCommand(e));const n=(new AudioSourceStorage).getBatchRecentCommands();for(let e=0;e<n.length;e++){const s=n[e];t.getOrCreateSubMenu(e,s).populate=(e=>{const t=e.menuElement;t.getOrCreateSubMenu("run","Execute on Group").action=(e=>{this.editor.actions.batchRunCommand(e,s,!0)}),t.getOrCreateSubMenu("search","Execute using Search").populate=(e=>{const t=e.menuElement;t.getOrCreateSubMenu("new","New Search").action=(e=>this.editor.actions.batchRunCommand(e,s,null,!0));const n=(new AudioSourceStorage).getBatchRecentSearches();for(let e=0;e<n.length;e++){const r=n[e];t.getOrCreateSubMenu(e,r).action=(e=>{this.editor.actions.batchRunCommand(e,s,r)})}})})}})})}onInput(e){if(e.defaultPrevented)return;switch(e.type){case"mouseup":this.isSelectionRectActive()&&this.commitSelectionRect()}if(e.target instanceof Node&&!this.contains(e.target))return;let t=this.getSelectedIndicies();switch(e.type){case"midimessage":switch(e.data[0]){case 144:e.preventDefault();let t=(new MIDISupport).getCommandFromMIDINote(e.data[1]),n=Math.round(e.data[2]/128*100);console.log("MIDI ",t,n),this.insertOrUpdateCommand(e,t),this.playSelectedInstructions(e),this.focus()}break;case"keydown":this.editor.closeAllMenus();let n=e.key;switch(!e.ctrlKey&&this.editor.keyboard.getKeyboardCommand(e.key,this.fieldTrackerOctave.value)&&(n="PlayFrequency"),"Enter"===n&&e.altKey&&(n="ContextMenu"),n){case"Delete":e.preventDefault();const s=t.sort((e,t)=>t-e);for(let e=0;e<s.length;e++)this.editor.song.deleteInstructionAtIndex(this.groupName,t[e]);this.renderRows();break;case"Escape":case"Backspace":throw new Error("TODO: navigate pop");case"Enter":if(this.contains(e.target)){e.preventDefault(),this.insertOrUpdateCommand(e);let t=this.cursorInstruction;if(t.isGroupCommand()){const e=t.command.substr(1);this.editor.selectGroup(e)}else this.playSelectedInstructions(e)}break;case"Play":e.preventDefault(),this.playSelectedInstructions(e);break;case"ArrowRight":e.preventDefault(),this.selectNextCell(e),this.playSelectedInstructions(e),this.focus();break;case"ArrowLeft":e.preventDefault(),this.selectPreviousCell(e),this.playSelectedInstructions(e),this.focus();break;case"ArrowDown":e.preventDefault(),this.selectNextRowCell(e),this.playSelectedInstructions(e),this.focus();break;case"ArrowUp":e.preventDefault(),this.selectPreviousRowCell(e),this.playSelectedInstructions(e),this.focus();break;case" ":e.preventDefault(),this.editor.song.isPlaybackActive()?this.editor.song.stopPlayback():this.editor.song.play();break;case"PlayFrequency":let r=this.editor.keyboard.getKeyboardCommand(e.key,this.fieldTrackerOctave.value);if(null===r)break;e.preventDefault(),this.insertOrUpdateCommand(e,r),this.playSelectedInstructions(e),this.focus()}break;case"touchstart":case"mousedown":if(this.editor.closeAllMenus(),this.mousePosition.isDown=!0,this.mousePosition.isDragging=!1,this.mousePosition.lastDown=e,delete this.mousePosition.lastDrag,e.target.matches("asct-instruction"))return this.onCellInput(e);if(e.target.matches("asct-instruction > *"))return this.onCellInput(e,e.target.instruction);if(e.target.matches("asct-instruction-add"))return this.onRowInput(e,e.target.row);if(e.target.matches("asct-row"))return this.onRowInput(e);break;case"touchmove":case"mousemove":1===e.which&&this.mousePosition.isDown&&(this.mousePosition.isDragging=!0,this.mousePosition.lastDrag=e),this.mousePosition.isDown&&this.mousePosition.lastDrag&&this.mousePosition.lastDown.path[0].matches("asct-row");break;case"touchend":case"mouseup":this.mousePosition.isDown=!1,this.mousePosition.isDragging&&this.mousePosition.lastDown.path[0].matches("asct-row"),this.mousePosition.isDragging=!1;const s=this.mousePosition.lastUp;if(e.t=new Date,this.mousePosition.lastUp=e,s&&s.t.getTime()+this.editor.doubleClickTimeout>(new Date).getTime()){e.preventDefault();const t=e.path[0],n=s.path[0];if(n===t||n.contains(t)||t.contains(n)){const n=new CustomEvent("doubleclick",{detail:{firstMouseEvent:s.e,secondMouseEvent:e,clientX:e.clientX,clientY:e.clientY},cancelable:!0,bubbles:!0});t.dispatchEvent(n)}}break;case"mouseout":e.target.matches("asc-tracker")&&this.isSelectionRectActive()&&this.commitSelectionRect();break;case"click":break;case"doubleclick":case"longpress":e.preventDefault(),this.contains(e.target)&&this.editor.menuContext.openContextMenu(e);break;case"contextmenu":e.altKey||(e.preventDefault(),this.editor.menuContext.openContextMenu(e,this.cursorCell));break;case"scroll":break;case"dragstart":case"drag":case"dragend":console.info(e.type);break;default:throw new Error("Unhandled type: "+e.type)}}updateSelectionRect(e,t){t||(t=this.mousePosition.lastDrag||this.mousePosition.lastDrag);var n=e.clientX-t.clientX,s=e.clientY-t.clientY;if(Math.sqrt(n*n+s*s)<30)return console.warn("Skipping selection rect");let r,i,o,c,a=this.querySelector("div.selection-rect");return a||((a=document.createElement("div")).classList.add("selection-rect"),this.appendChild(a)),e.clientX<t.clientX?(r=e.clientX,o=t.clientX-e.clientX):(r=t.clientX,o=e.clientX-t.clientX),e.clientY<t.clientY?(i=e.clientY,c=t.clientY-e.clientY):(i=t.clientY,c=e.clientY-t.clientY),a.style.left=r+"px",a.style.width=o+"px",a.style.top=i+"px",a.style.height=c+"px",this.querySelectorAll("asct-instruction").forEach(e=>{const t=e.getBoundingClientRect(),n=t.x+t.width>r&&t.x<r+o&&t.y+t.height>i&&t.y<i+c;e.classList.toggle("selecting",n)}),{x:r,y:i,w:o,h:c}}isSelectionRectActive(){return!!this.querySelector("div.selection-rect")}commitSelectionRect(e=null,t=null){e||(e=this.mousePosition.lastDown);let n=this.querySelector("div.selection-rect");if(!n)return console.warn("No selection rect");const s=n.getBoundingClientRect();n.parentNode.removeChild(n),this.clearSelection();const r=this.querySelectorAll("asct-instruction,asct-row"),i=[];r.forEach(e=>{const t=e.getBoundingClientRect();t.x+t.width>s.x&&t.x<s.x+s.width&&t.y+t.height>s.y&&t.y<s.y+s.height&&(i.push(e),e.select(!0,!1))}),console.log("Selection ",i,s)}setPlaybackPositionInTicks(e){let t=this.navigateGroup(e);this.querySelectorAll("asct-row.position").forEach(e=>e.classList.remove("position")),t.classList.add("position")}async onSongEvent(e){switch(e.type){case"song:seek":this.setPlaybackPositionInTicks(e.detail.positionInTicks);break;case"group:seek":e.detail.groupName===this.groupName&&this.setPlaybackPositionInTicks(e.detail.positionInTicks);break;case"group:play":break;case"note:start":if(e.detail.groupName===this.groupName){let t=this.findInstructionElement(e.detail.instruction.index);t&&t.classList.add("playing")}break;case"note:end":if(e.detail.groupName===this.groupName){let t=this.findInstructionElement(e.detail.instruction.index);t&&t.classList.remove("playing")}}}get selectedCells(){return this.querySelectorAll("asct-instruction.selected")}get cursorCell(){return this.querySelector("asct-instruction.cursor,asct-instruction-add.cursor")}get cursorPosition(){return(e=>e?e.parentNode.position:null)(this.cursorCell)}get cursorInstruction(){return this.getInstruction(this.cursorCell.index)}getCursorCell(){return this.querySelector(".cursor")}getCursorIndex(){const e=this.querySelector(".cursor");return e?e.index:null}getSelectedIndicies(){const e=this.fieldTrackerSelection.value;return""===e?[]:e.split(/\D+/).map(e=>parseInt(e))}selectIndicies(e,t){if("string"==typeof t)switch(t){case"all":t=[];const e=this.editor.song.getInstructionGroupLength(this.groupName);for(let n=0;n<e;n++)t.push(n);break;case"segment":t=[].map.call(this.querySelectorAll("asct-instruction"),e=>e.index);break;case"row":throw new Error("TODO");case"none":t=[];break;default:throw new Error("Invalid selection: "+t)}"number"==typeof t&&(t=[t]),this.clearSelection();for(let n=0;n<t.length;n++)this.selectIndex(e,t[n]);this.fieldTrackerSelection.value=t.join(",")}selectIndex(e,t,n=!1){const s=this.findInstructionElement(t);return!!s&&(this.selectCell(e,s,n),!0)}selectNextCell(e){let t=this.querySelector(".cursor")||this.querySelector("asct-instruction");return t?t instanceof AudioSourceComposerTrackerInstructionAdd?this.selectNextRowCell(e,0):t.nextInstructionSibling?this.selectCell(e,t.nextInstructionSibling):this.selectNextRowCell(e):this.selectRow(e,this.querySelector("asct-row"))}selectPreviousCell(e){let t=this.querySelector(".cursor")||this.querySelector("asct-instruction:last-child");return t?t.previousInstructionSibling?this.selectCell(e,t.previousInstructionSibling):this.selectPreviousRowCell(e):this.selectRow(e,this.querySelector("asct-row:last-child"))}selectNextRowCell(e,t=null){let n=this.querySelector(".cursor")||this.querySelector("asct-instruction");const s=n.parentNode;if(null===t&&(t=[].indexOf.call(n.parentNode.children,n)),!s.nextElementSibling)return this.currentRowSegmentID++,this.renderRows(),this.focus(),this.selectNextCell(e);const r=s.nextElementSibling;let i=r.querySelector("asct-instruction");return r.children[t]&&r.children[t].matches("asct-instruction")&&(i=r.children[t]),i?this.selectCell(e,i):this.selectRow(e,s.nextElementSibling),i}selectPreviousRowCell(e,t=null){let n=this.querySelector(".cursor")||this.querySelector("asct-instruction:last-child");const s=n.parentNode;if(null===t&&(t=[].indexOf.call(n.parentNode.children,n)),!s.previousElementSibling){if(0===this.currentRowSegmentID)throw new Error("TODO: reached beginning of song");return this.currentRowSegmentID--,this.renderRows(),this.focus(),this.selectPreviousCell(e)}let r,i=s.previousElementSibling;return i.children[t]&&i.children[t].matches("asct-instruction,asct-instruction-add")&&(r=i.children[t]),r?this.selectCell(e,r):this.selectRow(e,i),r}updateSelectedIndicies(){const e=this.getSelectedIndicies(),t=[].map.call(this.selectedCells,e=>e.index);for(let n=0;n<t.length;n++){const s=t[n];-1===e.indexOf(s)&&e.push(s)}e.sort(),this.fieldTrackerSelection.value=e.join(",")}selectSegmentIndicies(e,t=!1){Array.isArray(e)||(e=[e]),t&&this.clearSelection();for(let t=0;t<e.length;t++){const n=e[t],s=this.findInstructionElement(n);s&&(s.select(!0,!1),0===t&&s.setCursor())}this.updateSelectedIndicies()}selectRow(e,t){return e.ctrlKey||this.clearSelection(),t.createAddInstructionElement().setCursor(),this.renderForms(),this.focus(),t.parentNode.scrollTo(),this.editor.song.setPlaybackPositionInTicks(t.position),t.scrollTo(),t}selectCell(e,t,n=null){let s=!0;return null===n&&(n=!(e&&e.ctrlKey)),e&&e.shiftKey&&(s=!t.selected),n&&this.clearSelection(),this.editor.closeAllMenus(),t.select(s),this.updateSelectedIndicies(),t.setCursor(),this.renderForms(),this.focus(),this.editor.song.setPlaybackPositionInTicks(t.parentNode.position),t.parentNode.scrollTo(),t}onRowInput(e,t=null){e.preventDefault(),t=t||e.target,this.selectRow(e,t)}onCellInput(e,t){e.preventDefault(),t=t||e.target,this.selectCell(e,t,!e.shiftKey),this.playSelectedInstructions(e)}increaseTrackerSize(e,t=!0){if(this.renderMinimumRows+=1,this.render(),t){this.querySelector("asc-tracker > asct-row:last-child").setCursor()}}insertInstructionAtIndex(e,t){return this.editor.song.insertInstructionAtIndex(this.groupName,t,e)}insertInstructionAtPosition(e,t){return this.editor.song.insertInstructionAtPosition(this.groupName,e,t)}deleteInstructionAtIndex(e){return this.editor.song.deleteInstructionAtIndex(this.groupName,e,1)}replaceInstructionCommand(e,t){return this.editor.song.replaceInstructionCommand(this.groupName,e,t)}replaceInstructionVelocity(e,t){return this.editor.song.replaceInstructionVelocity(this.groupName,e,t)}insertOrUpdateCommand(e,t=null){let n=this.getSelectedIndicies();if(this.cursorCell.matches("asct-instruction-add")){let e=this.getInstructionFormValues(t);if(!e)return this.fieldInstructionCommand.focus(),console.info("Insert canceled");const n=this.cursorPosition,s=this.insertInstructionAtPosition(n,e);this.renderRows(),this.selectSegmentIndicies(s,!0)}else{for(let e=0;e<n.length;e++){const s=this.getInstruction(n[e]),r=this.replaceFrequencyAlias(t,s.instrument);this.replaceInstructionCommand(n[e],r)}this.renderRows(),this.selectSegmentIndicies(n)}}replaceFrequencyAlias(e,t){const n=this.editor.song.getInstrument(t,!1);if(!n||!n.getFrequencyAliases)return e;const s=n.getFrequencyAliases(e);return void 0===s[e]?e:s[e]}findRowElement(e){return this.querySelector(`asct-row[p='${e}']`)}findInstructionElement(e){return this.querySelector(`asct-instruction[i='${e}']`)}}customElements.define("asc-tracker",AudioSourceComposerTracker);const VISIBLE_BUFFER=100;class AudioSourceComposerTrackerRow extends HTMLElement{constructor(e){super(),this.setAttribute("p",e)}get trackerElm(){return this.closest("asc-tracker")}get selected(){return this.classList.contains("selected")}get position(){return parseInt(this.getAttribute("p"))}get duration(){return this.nextElementSibling?this.nextElementSibling.position-this.position:"N/A"}set index(e){this.setAttribute("i",e)}get index(){return parseInt(this.getAttribute("i"))}get visible(){const e=this.parentNode.scrollTop+this.parentNode.offsetHeight,t=this.offsetTop+this.offsetHeight;return!(this.offsetTop-e>VISIBLE_BUFFER)&&!(t<this.parentNode.scrollTop-VISIBLE_BUFFER)}connectedCallback(){}createAddInstructionElement(){let e=this.querySelector("asct-instruction-add");if(!e){this.parentNode.querySelectorAll("asct-instruction-add").forEach(e=>e.parentNode.removeChild(e));const t=document.createElement("asct-instruction-add");e=t,t.innerHTML="+"}let t=this.querySelector("asct-delta");return t?this.insertBefore(e,t):this.appendChild(e),e}clearAddInstructionElement(){this.parentNode.querySelectorAll("asct-instruction-add").forEach(e=>e.parentNode.removeChild(e))}select(e=!0){if(e){if(this.selected)return void console.warn("Already selected ",this);this.classList.add("selected")}else{if(!this.selected)return void console.warn("Already unselected ",this);this.classList.remove("selected")}}clearAllCursors(){this.trackerElm.querySelectorAll(".cursor").forEach(e=>e.classList.remove("cursor"))}scrollTo(){const e=this.parentNode;e.scrollTop<this.offsetTop-e.offsetHeight&&(e.scrollTop=this.offsetTop),e.scrollTop>this.offsetTop&&(e.scrollTop=this.offsetTop-e.offsetHeight)}renderDelta(e){let t=this.querySelector("asct-delta");return t||(t=document.createElement("asct-delta"),this.appendChild(t)),t.render(e),this}renderInstructions(e=[]){const t=this.querySelectorAll("asct-instruction");let n=0;for(;n<t.length;n++){const s=e[n],r=t[n];n>=e.length?r.parentNode.removeChild(r):(r.index=s.index,r.render(e[n]))}let s=this.querySelector("asct-delta");for(;n<e.length;n++){const t=e[n],r=document.createElement("asct-instruction");r.index=t.index,s?this.insertBefore(r,s):this.appendChild(r),r.render(e[n])}return this}}customElements.define("asct-row",AudioSourceComposerTrackerRow);class AudioSourceComposerTrackerInstruction extends HTMLElement{constructor(){super()}get row(){return this.parentNode}get trackerElm(){if(!this.parentNode)throw new Error("Invalid tracker");return this.parentNode.trackerElm}get editor(){return this.trackerElm.editor}set index(e){this.setAttribute("i",e)}get index(){return parseInt(this.getAttribute("i"))}get selected(){return this.classList.contains("selected")}get nextInstructionSibling(){return this.nextElementSibling&&this.nextElementSibling.matches("asct-instruction")?this.nextElementSibling:null}get previousInstructionSibling(){return this.previousElementSibling&&this.previousElementSibling.matches("asct-instruction")?this.previousElementSibling:null}getInstruction(){return this.row.trackerElm.getInstruction(this.index)}play(){return this.editor.song.playInstructionAtIndex(this.trackerElm.groupName,this.index,this.editor.song.getAudioContext().currentTime,{groupPositionInTicks:this.row.position,currentIndex:this.index}),this}connectedCallback(){}scrollTo(){return this.row.scrollTo()}clearAllCursors(){return this.row.clearAllCursors()}setCursor(){return this.clearAllCursors(),this.classList.add("cursor"),this}select(e=!0){return e?this.classList.add("selected"):this.classList.remove("selected","cursor"),this.render(),this}render(e=null){e=e||this.getInstruction();let t=this.querySelector("ascti-command");if(t||this.appendChild(t=document.createElement("ascti-command")),t.render(e),this.classList.contains("selected")){let t=this.querySelector("ascti-instrument");t||this.appendChild(t=document.createElement("ascti-instrument")),t.render(e);let n=this.querySelector("ascti-velocity");n||this.appendChild(n=document.createElement("ascti-velocity")),n.render(e);let s=this.querySelector("ascti-duration");s||this.appendChild(s=document.createElement("ascti-duration")),s.render(e)}else{let e=this.querySelector("ascti-instrument");e&&e.parentNode.removeChild(e);let t=this.querySelector("ascti-velocity");t&&t.parentNode.removeChild(t);let n=this.querySelector("ascti-duration");n&&n.parentNode.removeChild(n)}return this}}customElements.define("asct-instruction",AudioSourceComposerTrackerInstruction);class AudioSourceComposerTrackerInstructionAdd extends AudioSourceComposerTrackerInstruction{render(e=null){if(e)throw new Error("Invalid");return this.innerHTML="+",this}}customElements.define("asct-instruction-add",AudioSourceComposerTrackerInstructionAdd);class AudioSourceComposerTrackerParameter extends HTMLElement{constructor(){super()}get instruction(){return this.parentNode}get trackerElm(){return this.parentNode.parentNode.trackerElm}get editor(){return this.trackerElm.editor}connectedCallback(){}render(){this.innerHTML=this.editor.values.format(this.row.duration,"duration")}}class AudioSourceComposerParamCommand extends AudioSourceComposerTrackerParameter{render(e=null){e=e||this.instruction.getInstruction(),this.innerHTML=this.editor.values.format(e.command,"command")}}customElements.define("ascti-command",AudioSourceComposerParamCommand);class AudioSourceComposerParamInstrument extends AudioSourceComposerTrackerParameter{render(e=null){e=e||this.instruction.getInstruction(),this.innerHTML=this.editor.values.format(e.instrument,"instrument")}}customElements.define("ascti-instrument",AudioSourceComposerParamInstrument);class AudioSourceComposerParamVelocity extends AudioSourceComposerTrackerParameter{render(e=null){e=e||this.instruction.getInstruction(),this.innerHTML=this.editor.values.format(e.velocity,"velocity")}}customElements.define("ascti-velocity",AudioSourceComposerParamVelocity);class AudioSourceComposerTrackerDuration extends AudioSourceComposerTrackerParameter{render(e=null){e=e||this.instruction.getInstruction(),this.innerHTML=this.editor.values.format(e.duration,"duration")}}customElements.define("ascti-duration",AudioSourceComposerTrackerDuration);class AudioSourceComposerTrackerDelta extends HTMLElement{constructor(){super()}get editor(){return this.trackerElm.editor}get trackerElm(){return this.parentNode.trackerElm}get row(){return this.parentNode}connectedCallback(){}render(e){e=e||(this.row?this.row.duration:-1),this.innerHTML=this.editor.values.format(e,"duration")}}customElements.define("asct-delta",AudioSourceComposerTrackerDelta);class AudioSourceComposerKeyboard{constructor(){}getKeyboardLayout(e=null){switch(e){default:case"2octave":return{"@":"C#4","#":"D#4","%":"F#4","^":"G#4","&":"A#4","*":"C#3",")":"D#3",Q:"C4",W:"D4",E:"E4",R:"F4",T:"G4",Y:"A4",U:"B4",I:"C3",O:"D3",P:"E3",S:"C#3",D:"D#3",G:"F#3",H:"G#3",J:"A#3",L:"C#4",":":"D#4",Z:"C3",X:"D3",C:"E3",V:"F3",B:"G3",N:"A3",M:"B3","<":"C4",">":"D4","?":"E4",2:"C#2",3:"D#2",5:"F#2",6:"G#2",7:"A#2",9:"C#3",0:"D#3",q:"C2",w:"D2",e:"E2",r:"F2",t:"G2",y:"A2",u:"B2",i:"C3",o:"D3",p:"E3",s:"C#1",d:"D#1",g:"F#1",h:"G#1",j:"A#1",l:"C#2",";":"D#2",z:"C1",x:"D1",c:"E1",v:"F1",b:"G1",n:"A1",m:"B1",",":"C2",".":"D2","/":"E2"};case"4octave":return{Q:"C6",W:"C#6",E:"D6",R:"D#6",T:"E6",Y:"F6",U:"F#6",I:"G6",O:"G#6",P:"A6","{":"A#6","}":"B6",A:"C5",S:"C#5",D:"D5",F:"D#5",G:"E5",H:"F5",J:"F#5",K:"G5",L:"G#5",":":"A5",'"':"A#5",Z:"C4",X:"C#4",C:"D4",V:"D#4",B:"E4",N:"F4",M:"F#4","<":"G4",">":"G#4","?":"A4",q:"C3",w:"C#3",e:"D3",r:"D#3",t:"E3",y:"F3",u:"F#3",i:"G3",o:"G#3",p:"A3","[":"A#3","]":"B3",a:"C2",s:"C#2",d:"D2",f:"D#2",g:"E2",h:"F2",j:"F#2",k:"G2",l:"G#2",";":"A2","'":"A#2",z:"C1",x:"C#1",c:"D1",v:"D#1",b:"E1",n:"F1",m:"F#1",",":"G1",".":"G#1","/":"A1"}}}getKeyboardCommand(e,C=3,D=null){if(!Number.isInteger(C))throw new Error("Octave value must be an integer");const r=this.getKeyboardLayout(D);if(void 0===r[e])return null;let t=r[e];for(let e=6;e>=1;e--)t=t.replace(e,C+e-1);return t}}class AudioSourceComposerActions{constructor(t){this.editor=t}getDefaultInstrumentURL(){return(new AudioSourceUtilities).getScriptDirectory("instrument/audio-source-synthesizer.js")}setInstrumentName(t,e,n){this.editor.song.setInstrumentName(e,n),this.editor.setStatus(`Instrument name updated: ${n}`)}setSongName(t,e){this.editor.song.setName(e),this.editor.setStatus(`Song name updated: ${e}`)}setSongVersion(t,e){this.editor.song.setVersion(e),this.editor.setStatus(`Song version updated: ${e}`)}setSongVolume(t,e){this.editor.song.setVolume(e),this.editor.fieldSongVolume.value=e,this.editor.setStatus(`Volume modified: ${e}`)}async loadNewSongData(){const t=new AudioSourceStorage,e=this.getDefaultInstrumentURL()+"";let n=t.generateDefaultSong(e);await this.editor.song.loadSongData(n),this.editor.render(),this.editor.setStatus("Loaded new song",n)}async loadRecentSongData(){const t=new AudioSourceStorage;let e=await t.getRecentSongList();return!(!e[0]||!e[0].guid)&&(this.editor.setStatus("Loading recent song: "+e[0].guid),await this.loadSongFromMemory(e[0].guid),!0)}async saveSongToMemory(){const t=this.editor.song,e=t.data,n=t.history,o=new AudioSourceStorage;this.editor.setStatus("Saving song to memory..."),await o.saveSongToMemory(e,n),this.editor.setStatus("Saved song to memory: "+e.guid)}saveSongToFile(){const t=this.editor.song.data,e=new AudioSourceStorage;this.editor.setStatus("Saving song to file"),e.saveSongToFile(t)}async loadSongFromMemory(t){const e=this.editor.song,n=new AudioSourceStorage,o=await n.loadSongFromMemory(t);0===o.instruments.length&&console.warn("Song contains no instruments");const r=await n.loadSongHistoryFromMemory(t);await e.loadSongData(o),await e.loadSongHistory(r),this.editor.render(!0),this.editor.setStatus("Song loaded from memory: "+t,o)}async loadSongFromFileInput(t,e=null){if(!(e=e||this.editor.fieldSongFileLoad.inputElm)||!e.files||0===e.files.length)throw new Error("Invalid file input");if(e.files.length>1)throw new Error("Invalid file input: only one file allowed");const n=e.files[0],o=n.name.split(".").pop().toLowerCase();switch(o){case"mid":case"midi":await this.loadSongFromMIDIFile(n);break;case"json":await this.loadSongFromJSONFile(n);break;default:throw new Error("Unknown file type: "+o)}}async loadSongFromJSONFile(t){const e=new AudioSourceStorage,n=await e.loadJSONFile(t);0===n.instruments.length&&console.warn("Song contains no instruments"),await this.editor.song.loadSongData(n),this.editor.render(),this.editor.setStatus("Song loaded from file: ",n)}async loadSongFromMIDIFile(t,e=null){e=e||this.getDefaultInstrumentURL();const n=new MIDISupport,o=await n.loadSongFromMidiFile(t,e);await this.editor.song.loadSongData(o),this.editor.render(),this.editor.setStatus("Song loaded from midi: ",o)}async loadSongFromSrc(t){t=new URL(t,document.location)+"";const e=await new Promise((e,n)=>{const o=new XMLHttpRequest;o.open("GET",t+"",!0),o.responseType="json",o.onload=(()=>{if(200!==o.status)return n("Song file not found: "+url);e(o.response)}),o.send()});0===e.instruments.length&&console.warn("Song contains no instruments"),await this.editor.song.loadSongData(e),this.editor.setStatus("Song loaded from src: "+t),console.info(this.editor.song.data),this.editor.render()}async songPlay(){await this.editor.song.play()}async songPause(){this.editor.song.stopPlayback()}async songStop(){this.editor.song.stopPlayback(),this.editor.song.setPlaybackPositionInTicks(0)}setSongPosition(t,e=null){const n=this.editor.song;if(null===e){e=(new AudioSourceValues).parsePlaybackPosition(this.editor.fieldSongPosition.value)}n.setPlaybackPosition(e)}insertInstructionCommand(t,e=null,n=!1,o=null){const r=this.editor.trackerElm,s=this.editor.song;if(null===e&&(e=r.fieldInstructionCommand.value||null),n&&(e=prompt("Set custom command:",e||"")),!e)throw new Error("Invalid Instruction command");let i=r.getInstructionFormValues(e);null!==o&&(i.instrument=o);const a=s.getSongPositionInTicks();console.log(a);let l=s.insertInstructionAtPosition(r.groupName,a,i);r.renderRows(),r.selectIndicies(t,l),r.playSelectedInstructions()}setInstructionCommand(t,e=null,n=!1,o=null){const r=this.editor.trackerElm,s=this.editor.song;let i=r.getSelectedIndicies();if(0===i.length)throw new Error("No selection");if(null===e&&(e=r.fieldInstructionCommand.value||null),n&&(e=prompt("Set custom command:",e||"")),!e)throw new Error("Invalid Instruction command");for(let t=0;t<i.length;t++)s.replaceInstructionCommand(r.groupName,i[t],e),null!==o&&s.replaceInstructionInstrument(r.groupName,i[t],o),r.findInstructionElement(i[t]).render();r.playSelectedInstructions()}setInstructionInstrument(t,e=null){const n=this.editor.trackerElm,o=this.editor.song;let r=n.getSelectedIndicies();if(e=null!==e?e:parseInt(n.fieldInstructionInstrument.value),!Number.isInteger(e))throw new Error("Invalid Instruction ID");for(let t=0;t<r.length;t++)o.replaceInstructionInstrument(n.groupName,r[t],e),n.findInstructionElement(r[t]).render();n.fieldInstructionInstrument.value=e,n.playSelectedInstructions()}setInstructionDuration(t,e=null,n=!1){const o=this.editor.trackerElm,r=this.editor.song;let s=o.getSelectedIndicies();if(e||(e=parseFloat(o.fieldInstructionDuration.value)),n&&(e=parseInt(prompt("Set custom duration in ticks:",e))),isNaN(e))throw new Error("Invalid duration: "+typeof e);for(let t=0;t<s.length;t++)r.replaceInstructionDuration(o.groupName,s[t],e),o.findInstructionElement(s[t]).render();o.playSelectedInstructions()}setInstructionVelocity(t,e=null,n=!1){const o=this.editor.trackerElm,r=this.editor.song;let s=o.getSelectedIndicies();if(null===e&&(e=o.fieldInstructionVelocity.value),e=parseFloat(e),n&&(e=parseInt(prompt("Set custom velocity (0-127):",o.fieldInstructionVelocity.value))),null===e||isNaN(e))throw new Error("Invalid velocity: "+typeof e);for(let t=0;t<s.length;t++)r.replaceInstructionVelocity(o.groupName,s[t],e),o.findInstructionElement(s[t]).render();o.playSelectedInstructions()}deleteInstructionCommand(t){const e=this.editor.trackerElm,n=this.editor.song;let o=e.getSelectedIndicies();for(let t=0;t<o.length;t++)n.deleteInstructionAtIndex(e.groupName,o[t]);e.renderRows()}songGroupAddNew(t){this.editor.trackerElm;const e=this.editor.song;let n=e.generateInstructionGroupName();(n=prompt("Create new instruction group?",n))?(e.addInstructionGroup(n,[]),this.editor.render()):this.editor.setStatus("<span class='error'>Create instruction group canceled</span>")}songGroupRename(t,e,n=null){const o=this.editor.song;(n=prompt(`Rename instruction group (${e})?`,e))!==e?(o.renameInstructionGroup(e,n),this.editor.render()):this.editor.setStatus("<span class='error'>Rename instruction group canceled</span>")}songGroupRemove(t,e){const n=this.editor.song;confirm(`Remove instruction group (${e})?`)?(n.removeInstructionGroup(e),this.editor.render()):this.editor.setStatus("<span class='error'>Remove instruction group canceled</span>")}songAddInstrument(t,e,n={}){if(!e)return this.editor.handleError("Empty URL");if(n.url=e,n.libraryURL=this.editor.defaultLibraryURL,confirm(`Add Instrument to Song?\nURL: ${e}`)){const t=this.editor.song.addInstrument(n);this.editor.setStatus("New instrument Added to song: "+e),this.editor.trackerElm.fieldInstructionInstrument.value=t}else this.editor.handleError(`New instrument canceled: ${e}`)}async songReplaceInstrument(t,e,n,o={}){return Number.isInteger(e)?n?(o.url=n,o.libraryURL=this.editor.libraryURL,void(confirm(`Change Instrument (${e}) to ${n}`)?(await this.editor.song.replaceInstrument(e,o),await this.editor.song.loadInstrument(e,!0),this.editor.setStatus(`Instrument (${e}) changed to: ${n}`),this.editor.trackerElm.fieldInstructionInstrument.value=e):this.editor.handleError(`Change instrument canceled: ${n}`))):this.editor.handleError("Empty URL"):this.editor.handleError("Invalid Instrument ID: Not an integer")}songRemoveInstrument(t,e=null){null===e&&(e=parseInt(t.target.form.elements.instrumentID.value)),confirm(`Remove Instrument ID: ${e}`)?(this.editor.song.removeInstrument(e),this.editor.setStatus(`Instrument (${e}) removed`)):this.editor.handleError("Remove instrument canceled")}setTrackerChangeGroup(t,e=null){const n=this.editor.trackerElm;e=e||t.target.form.getAttribute("data-group"),n.groupName=e}setTrackerOctave(t,e=null){null!==e&&(this.editor.trackerElm.fieldTrackerOctave.value=e)}setTrackerRowLength(t,e=null){const n=this.editor.trackerElm;null!==e&&n.fieldTrackerRowLength.value,n.renderRows()}setTrackerSegmentLength(t,e=null){const n=this.editor.trackerElm;null!==e&&(n.fieldTrackerSegmentLength.value=e),n.renderRows()}setTrackerFilterInstrument(t){this.editor.trackerElm.renderRows()}setTrackerSelection(t,e=null){const n=this.editor.trackerElm;e||(e=n.fieldTrackerSelection.value.split(/\D+/).map(t=>parseInt(t))),n.selectIndicies(t,e),n.fieldTrackerSelection.focus()}togglePanelInstruments(t){this.editor.containerElm.classList.toggle("hide-panel-instruments")}togglePanelTracker(t){this.editor.containerElm.classList.toggle("hide-panel-tracker")}togglePanelSong(t){this.editor.containerElm.classList.toggle("hide-panel-song")}toggleFullscreen(t){this.editor.containerElm.classList.toggle("fullscreen"),this.editor.classList.toggle("fullscreen")}batchSelect(e,searchCallbackString=null,promptUser=!1){if(!promptUser&&searchCallbackString||(searchCallbackString=prompt("Run custom search:",searchCallbackString||'/** Example Search **/ i.command === "C3"   &&   i.instrument === 0')),!searchCallbackString)throw new Error("Batch command canceled: Invalid search");const storage=new AudioSourceStorage;storage.addBatchRecentSearches(searchCallbackString);const tracker=this.editor.trackerElm;tracker.clearSelection();const groupName=tracker.groupName,g=groupName;try{const stats={count:0},iterator=this.editor.song.getIterator(groupName);let instruction;const window=null,document=null;for(;instruction=iterator.nextConditionalInstruction(instruction=>{const i=instruction;return eval(searchCallbackString)});)stats.count++,tracker.selectIndex(e,iterator.groupIndex);this.editor.setStatus("Batch Search Completed: "+JSON.stringify(stats),stats)}catch(t){this.editor.setStatus("Batch Search Failed: "+t.message,t)}}batchRunCommand(e,commandCallbackString=null,searchCallbackString=null,promptUser=!1){const storage=new AudioSourceStorage;if(!promptUser&&searchCallbackString||(searchCallbackString=prompt("Run custom search:",searchCallbackString||'/** Example Search **/ i.command === "C3"   &&   i.instrument === 0')),!searchCallbackString)throw new Error("Batch command canceled: Invalid search");if(storage.addBatchRecentSearches(searchCallbackString),!promptUser&&commandCallbackString||(commandCallbackString=prompt("Run custom command:",commandCallbackString||"/** Example Command **/ i.command='C4';")),!commandCallbackString)throw new Error("Batch command canceled: Invalid command");storage.addBatchRecentCommands(commandCallbackString);const instructionList=[],tracker=this.editor.trackerElm,groupName=tracker.groupName,g=groupName;try{const stats={count:0,modified:0},iterator=this.editor.song.getIterator(groupName);let instruction;const window=null,document=null;for(;instruction=iterator.nextConditionalInstruction(instruction=>{const i=instruction;return eval(searchCallbackString)});){const instructionString=JSON.stringify(instruction.data),i=instruction;eval(commandCallbackString),instructionString!==JSON.stringify(instruction.data)&&stats.modified++,stats.count++,tracker.selectIndex(e,iterator.groupIndex)}return this.editor.setStatus("Batch Command Completed: "+JSON.stringify(stats),stats),instructionList}catch(t){return this.editor.setStatus("Batch Command Failed: "+t.message,t),[]}}}class AudioSourceUIMenu extends HTMLElement{constructor(){super(),this.action=null,this.populate=null,this.mouseTimeout=null,this.caption=null}get key(){return this.getAttribute("key")}set key(e){this.setAttribute("key",e),this.render()}get disabled(){return"true"==this.getAttribute("disabled")}set disabled(e){e?this.setAttribute("disabled","true"):this.removeAttribute("disabled")}get hasBreak(){return this.getAttribute("hasBreak")}set hasBreak(e){this.setAttribute("hasBreak",e),this.render()}get editor(){const e=this.closest("div.asc-container").parentNode.host;if(!e)throw new Error("Editor not found");return e}connectedCallback(){const e=this.getAttribute("caption");e&&(this.caption=e),this.addEventListener("mouseenter",this.onInputEvent),this.addEventListener("mouseleave",this.onInputEvent),this.addEventListener("click",this.onInputEvent),this.addEventListener("change",this.onInputEvent),this.addEventListener("keydown",this.onInputEvent),this.render()}disconnectedCallback(){this.removeEventListener("mouseenter",this.onInputEvent),this.removeEventListener("mouseleave",this.onInputEvent),this.removeEventListener("click",this.onInputEvent),this.removeEventListener("change",this.onInputEvent),this.removeEventListener("keydown",this.onInputEvent)}onInputEvent(e){if(!this.contains(e.target))return;if(this===e.target.closest("asui-menu"))switch(e.type){case"mouseenter":clearTimeout(this.mouseTimeout),this.hasSubMenu&&!this.disabled&&this.renderSubMenu(e);break;case"mouseleave":this.classList.contains("stick")||(clearTimeout(this.mouseTimeout),this.mouseTimeout=setTimeout(e=>{this.clearSubMenu()},200));break;case"click":if(e.defaultPrevented)return;if(this.hasAction)e.preventDefault(),this.doAction(e);else{if(!this.hasSubMenu)return console.warn("Menu has no submenu or action: ",this);e.preventDefault(),this.toggleSubMenu(e)}break;case"keydown":if(e.defaultPrevented)return;e.preventDefault();const t=this.getSubMenuContainer(),n=t.querySelector("asui-menu.selected")||t.firstElementChild;if(!n)throw new Error("No selected menu item found");switch(e.key){case"Escape":case"Backspace":this.closeMenu(e);break;case"Enter":if(n.hasAction)n.doAction(e);else{if(!n.hasSubMenu)return console.warn("Menu has no submenu or action: ",n);n.toggleSubMenu(e)}break;case"ArrowRight":if(!n.hasSubMenu)return console.warn("Menu has no submenu: ",n);n.toggleSubMenu(e);break;case"ArrowLeft":this.closeMenu(e);break;case"ArrowDown":this.selectNextSubMenuItem();break;case"ArrowUp":this.selectPreviousSubMenuItem()}}}get hasAction(){return!!this.action}doAction(e){if(!this.hasAction)throw new Error("No .action callback set");e.menuElement=this,this.action(e),this.closeAllMenus()}get hasSubMenu(){return!!this.populate}toggleSubMenu(e){if(this.classList.contains("stick"))this.clearSubMenu(e);else{this.renderSubMenu(e),this.classList.add("stick");let t=this;for(;t=t.parentNode.closest("asui-menu");)t.classList.add("stick")}}clearSubMenu(e){this.classList.remove("stick","open","open-context-menu"),this.getSubMenuContainer().innerHTML=""}async renderSubMenu(e){if(!this.populate)throw new Error("Menu has no .populate callback");let t=this.getSubMenuContainer();this.classList.add("open"),e.menuElement=this;const n=this.populate(e);n instanceof Promise&&await n,t.focus();const u=t.querySelectorAll("asui-menu:not([disabled])");u[0]&&u[0].classList.add("selected")}getSubMenuContainer(){let e=this.querySelector(".dropdown-container");return e||((e=document.createElement("div")).classList.add("dropdown-container"),e.setAttribute("tabindex","0"),this.appendChild(e)),e}getOrCreateSubMenu(e,t=null){e=e.toString();let n=this.getSubMenuContainer();for(let t=0;t<n.childNodes.length;t++){const u=n.childNodes[t];if(u.matches("asui-menu")&&u.key===e)return u}const u=document.createElement("asui-menu");return u.key=e,t&&(u.caption=t),n.appendChild(u),u}selectNextSubMenuItem(){const e=this.getSubMenuContainer(),t=e.querySelector("asui-menu.selected");e.querySelectorAll("asui-menu.selected").forEach(e=>e.classList.remove("selected"));const n=e.querySelectorAll("asui-menu:not([disabled])");let u=[].indexOf.call(n,t);(u>-1&&u<n.length-1?n[u+1]:n[0]).classList.add("selected")}selectPreviousSubMenuItem(){const e=this.getSubMenuContainer(),t=e.querySelector("asui-menu.selected");e.querySelectorAll("asui-menu.selected").forEach(e=>e.classList.remove("selected"));const n=e.querySelectorAll("asui-menu:not([disabled])");let u=[].indexOf.call(n,t);(u>0?n[u-1]:n[n.length-1]).classList.add("selected")}openContextMenu(e,t=null){const n=(t=t||e.target).getBoundingClientRect();let u,s,i=this.getSubMenuContainer();if(e.clientX&&e.clientY)u=e.clientX,s=e.clientY;else{const e=this.editor.getBoundingClientRect();u=n.x+n.width-e.x,s=n.y+n.height-e.y}this.clearSubMenu(),this.renderSubMenu(e),console.info("Context menu ",t,i,u,s),this.classList.add("open","stick","open-context-menu"),this.style.left=u+"px",this.style.top=s+"px"}closeAllMenus(){let e=this;for(;e.parentElement&&e.parentElement.closest("asui-menu");)e=e.parentElement.closest("asui-menu");e.parentElement.querySelectorAll("asui-menu.open,asui-menu.stick").forEach(e=>e.classList.remove("open","stick"))}closeMenu(e){this.clearSubMenu(e);let t=this.parentElement.closest("asui-menu");this.querySelectorAll("asui-menu.open,asui-menu.stick").forEach(e=>e.classList.remove("open","stick")),t&&t!==this&&t.renderSubMenu(e)}render(){const e=this.caption;if(e){let t=this.querySelector("div");t||((t=document.createElement("div")).classList.add("caption"),this.firstElementChild?this.insertBefore(t,this.firstElementChild):this.appendChild(t)),t.innerHTML="","string"==typeof e?t.innerHTML=e:t.appendChild(e)}if(this.hasBreak){let e=this.querySelector("hr");e||(e=document.createElement("hr"),this.firstElementChild?this.insertBefore(e,this.firstElementChild):this.appendChild(e))}}}customElements.define("asui-menu",AudioSourceUIMenu);class AudioSourceUIForm extends HTMLElement{constructor(e=null,t=null){super(),null!==e&&this.setAttribute("key",e),null===t&&this.hasAttribute("caption")&&(t=this.getAttribute("caption"),this.removeAttribute("caption")),this.caption=t}connectedCallback(){}disconnectedCallback(){}get caption(){const e=this.querySelector(".header");return e?e.innerText:null}set caption(e){let t=this.querySelector(".header");e||"0"===e?(t||((t=document.createElement("div")).classList.add("header"),this.insertBefore(t,this.firstChild)),t.innerHTML=e):t&&t.parentNode.removeChild(t)}get parentForm(){return this.parentNode.closest("asui-form")}get key(){return this.getAttribute("key")}get editor(){return this.closest("audio-source-composer")||this.getRootNode().host}clearInputs(){const e=this.caption;this.innerHTML="",this.caption=e}hasInput(e){return!!this.querySelector(`[key="${e}"]`)}getInput(e,t=!0){const n=this.querySelector(`[key="${e}"]`);if(n)return n;if(t)throw new Error("Input key not found: "+e);return null}getOrCreateForm(e,t=null){let n=this.getInput(e,!1);if(n?null!==t&&(n.caption=t):n=this.addForm(e,t),!n instanceof AudioSourceUIForm)throw new Error("Input is not a form: "+e);return n}getForm(e,t=!0){const n=this.getInput(e,t);if(null===n&&!1===t)return n;if(!n instanceof AudioSourceUIForm)throw new Error("Input is not a form: "+e);return e}addInput(e){if(!e.hasAttribute("key"))throw new Error("Form Inputs require a key attribute");return this.appendChild(e),e}addForm(e,t=null){return this.addInput(new AudioSourceUIForm(e,t))}addGrid(e){return this.addInput(new AudioSourceUIGrid(e))}addBreak(e="break"){return this.addText(e,"<br/>")}addText(e,t=null){return this.addInput(new AudioSourceUIText(e,t))}addButton(e,t,n,u=null){return this.addInput(new AudioSourceUIButton(e,t,n,u))}addSelectInput(e,t,n,u=null,s=null){return this.addInput(new AudioSourceUISelectInput(e,t,n,u,s))}addRangeInput(e,t,n=1,u=100,s=null,i=null){return this.addInput(new AudioSourceUIRangeInput(e,t,n,u,s,i))}addTextInput(e,t,n=null,u="",s=null){return this.addInput(new AudioSourceUIInputText(e,t,n,u,s))}addCheckBoxInput(e,t,n=null,u=!1){return this.addInput(new AudioSourceUIInputCheckBox(e,t,n,u))}addFileInput(e,t,n,u=null,s=null){return this.addInput(new AudioSourceUIFileInput(e,t,n,u,s))}createIcon(e,t="icon"){return new AudioSourceUIIcon(t,e)}}customElements.define("asui-form",AudioSourceUIForm);class AudioSourceUIGrid extends HTMLElement{constructor(e=null){super(),null!==e&&this.setAttribute("key",e)}get parentForm(){return this.parentNode.closest("asui-form")}get key(){return this.getAttribute("key")}get editor(){return this.closest("audio-source-composer")||this.getRootNode().host}clearInputs(){this.innerHTML=""}getInput(e,t,n=!0){const u=this.getOrCreateRow(e).querySelector(`[key="${t}"]`);if(u)return u;if(n)throw new Error("Input key not found: "+t);return null}getOrCreateRow(e){let t=this.querySelector(`asuig-row[key="${e}"]`);return t||(t=new AudioSourceUIGridRow(e),this.appendChild(t)),t}addInput(e,t){if(!t.hasAttribute("key"))throw new Error("Form Inputs require a key attribute");return this.getOrCreateRow(e).addInput(t),t}addText(e,t,n=null){return this.getOrCreateRow(e).addText(t,n)}addButton(e,t,n,u,s=null){return this.getOrCreateRow(e).addButton(t,n,u,s)}addSelectInput(e,t,n,u,s=null,i=null){return this.getOrCreateRow(e).addSelectInput(t,n,u,s,i)}addRangeInput(e,t,n,u=1,s=100,i=null,r=null){return this.getOrCreateRow(e).addRangeInput(e,t,n,u,s,i,r)}addTextInput(e,t,n,u=null,s="",i=null){return this.getOrCreateRow(e).addTextInput(e,t,n,u,s,i)}addCheckBoxInput(e,t,n,u=null,s=!1){return this.getOrCreateRow(e).addCheckBoxInput(e,t,n,u,s)}addFileInput(e,t,n,u,s=null,i=null){return this.getOrCreateRow(e).addFileInput(e,t,n,u,s,i)}createIcon(e,t="icon"){return new AudioSourceUIIcon(t,e)}}customElements.define("asui-grid",AudioSourceUIGrid);class AudioSourceUIGridRow extends HTMLElement{constructor(e=null){super(),null!==e&&this.setAttribute("key",e)}get grid(){return this.parentNode}get key(){return this.getAttribute("key")}clearInputs(){this.innerHTML=""}getInput(e,t=!0){const n=this.querySelector(`[key="${e}"]`);if(n)return n;if(t)throw new Error("Input key not found: "+e);return null}addInput(e){if(!e.hasAttribute("key"))throw new Error("Form Inputs require a key attribute");return this.appendChild(e),e}addText(e,t=null){return this.addInput(new AudioSourceUIText(e,t))}addButton(e,t,n,u=null){return this.addInput(new AudioSourceUIButton(e,t,n,u))}addSelectInput(e,t,n,u=null,s=null){return this.addInput(new AudioSourceUISelectInput(e,t,n,u,s))}addRangeInput(e,t,n=1,u=100,s=null,i=null){return this.addInput(new AudioSourceUIRangeInput(e,t,n,u,s,i))}addTextInput(e,t,n=null,u="",s=null){return this.addInput(new AudioSourceUIInputText(e,t,n,u,s))}addCheckBoxInput(e,t,n=null,u=!1){return this.addInput(new AudioSourceUIInputCheckBox(e,t,null,u))}addFileInput(e,t,n,u=null,s=null){return this.addInput(new AudioSourceUIFileInput(e,t,n,u,s))}createIcon(e,t="icon"){return new AudioSourceUIIcon(t,e)}}customElements.define("asuig-row",AudioSourceUIGridRow);class AudioSourceUIInputAbstract extends HTMLElement{constructor(e,t){super(),this.listeners=[],this.callback=t||function(){console.warn("No callback set")},this.setAttribute("key",e)}get key(){return this.getAttribute("key")}get inputElm(){throw new Error("Not implemented")}get disabled(){return this.inputElm.disabled}set disabled(e){this.inputElm.disabled=e}get value(){return this.inputElm.value}set value(e){this.inputElm.value=e}setContent(e,t=null){(t=t||this.inputElm).innerHTML="",e instanceof HTMLElement?t.appendChild(e):t.innerHTML=e}addEventListener(e,t,n){this.listeners.push([e,t,n])}connectedCallback(){this.listeners.forEach(e=>this.inputElm.addEventListener(e[0],e[1],e[2]))}disconnectedCallback(){this.listeners.forEach(e=>this.inputElm.removeEventListener(e[0],e[1]))}}class AudioSourceUIButton extends AudioSourceUIInputAbstract{constructor(e,t=null,n=null,u=null){super(e,t),this.setAttribute("key",e);const s=document.createElement("button");s.classList.add("themed"),u&&s.setAttribute("title",u),this.setContent(n,s),this.appendChild(s),this.addEventListener("click",e=>this.onClick(e))}get inputElm(){return this.querySelector("button")}onClick(e){this.callback(e,this.value)}}customElements.define("asui-input-button",AudioSourceUIButton);class AudioSourceUISelectInput extends AudioSourceUIInputAbstract{constructor(e,t=null,n=null,u=null,s=null){super(e,t),this.selectedValue=null,this.optionsCallback=n||function(){throw new Error("No options callback set")},this.setAttribute("key",e);const i=document.createElement("select");i.classList.add("themed"),u&&i.setAttribute("title",u),this.appendChild(i),null!==s?this.setValue(s):this.setDefaultValue(),this.addEventListener("focus",e=>this.renderOptions(e)),this.addEventListener("change",e=>this.onChange(e))}get inputElm(){return this.querySelector("select")}get value(){return this.selectedValue?this.selectedValue.value:null}set value(e){this.setValue(e)}async setDefaultValue(){let e=!1;await this.eachOption((t,n)=>{e||(e={value:t,title:n})}),this.addOrSetValue(e.value,e.title)}async setValue(e){let t=!1;if(this.selectedValue={value:e,title:"*"},await this.eachOption((n,u)=>{n===e&&(t={value:n,title:u})}),!t){let t=[];throw this.eachOption(function(e){t.push(e)}),console.log(`Value not found: (${typeof e}) ${e}`,t),new Error(`Value not found: (${typeof e}) ${e}`)}this.selectedValue=t,this.addOrSetValue(t.value,t.title)}getOrCreateOption(e,t){const n=this.inputElm;let u=n.querySelector(`option[value="${e}"]`);return u||((u=document.createElement("option")).setAttribute("value",e),u.innerText=t||"Unknown value",n.insertBefore(u,n.firstChild)),u}async eachOption(e,t=null){t=t||function(){};const n=this.optionsCallback((t,n=null)=>e(t,n=null!==n?n:t),t);n instanceof Promise&&await n}async addOrSetValue(e,t=null){this.selectedValue={value:e,title:t||"Unknown value"},this.getOrCreateOption(e,this.selectedValue.title).selected=!0}async onChange(e){const t=this.inputElm.value;let n=!1;if(await this.eachOption((e,u)=>{e+""===t&&(n={value:e,title:u})}),!n)throw new Error("Value not found: ",t,this);this.selectedValue=n,this.callback(e,this.selectedValue.value)}async renderOptions(){const e=this.inputElm;e.innerHTML="";let t=e;await this.eachOption((e,n)=>{let u=document.createElement("option");u.setAttribute("value",e),u.innerText=n,this.selectedValue&&this.selectedValue.value===e&&(u.selected=!0),t.appendChild(u)},n=>{null!==n?((t=document.createElement("optgroup")).setAttribute("label",n),e.appendChild(t)):t=e})}}customElements.define("asui-input-select",AudioSourceUISelectInput);class AudioSourceUIRangeInput extends AudioSourceUIInputAbstract{constructor(e,t=null,n=1,u=100,s=null,i=null){super(e,t),this.setAttribute("key",e);const r=document.createElement("input");r.classList.add("themed"),r.setAttribute("type","range"),r.setAttribute("min",n+""),r.setAttribute("max",u+""),null!==i&&r.setAttribute("value",i),null!==s&&r.setAttribute("title",s),this.appendChild(r),this.addEventListener("change",e=>this.onChange(e))}get inputElm(){return this.querySelector("input")}get value(){return parseInt(this.inputElm.value)}set value(e){this.inputElm.value=e}onChange(e){this.callback(e,this.value)}}customElements.define("asui-input-range",AudioSourceUIRangeInput);class AudioSourceUIInputText extends AudioSourceUIInputAbstract{constructor(e,t=null,n=null,u=null,s=null){super(e,t),this.setAttribute("key",e);const i=document.createElement("input");i.classList.add("themed"),i.setAttribute("type","text"),n&&i.setAttribute("title",n),u&&i.setAttribute("value",u),s&&i.setAttribute("placeholder",s),this.appendChild(i),this.addEventListener("change",e=>this.onChange(e))}get inputElm(){return this.querySelector("input")}onChange(e){this.callback(e,this.value)}}customElements.define("asui-input-text",AudioSourceUIInputText);class AudioSourceUIInputCheckBox extends AudioSourceUIInputAbstract{constructor(e,t=null,n=null,u=!1){super(e,t),this.setAttribute("key",e);const s=document.createElement("input");s.classList.add("themed"),s.setAttribute("type","checkbox"),n&&s.setAttribute("title",n),u&&(s.checked=u),this.appendChild(s),this.addEventListener("change",e=>this.onChange(e))}get inputElm(){return this.querySelector("input")}get checked(){return this.inputElm.checked}onChange(e){this.callback(e,this.checked)}}customElements.define("asui-input-checkbox",AudioSourceUIInputCheckBox);class AudioSourceUIFileInput extends AudioSourceUIInputAbstract{constructor(e,t,n,u=null,s=null){super(e,t),this.setAttribute("key",e);const i=document.createElement("label");this.appendChild(i),this.setContent(n,i);const r=document.createElement("input");r.classList.add("themed"),r.setAttribute("type","file"),r.setAttribute("style","display: none;"),u&&r.setAttribute("accepts",u),s&&r.setAttribute("title",s),i.appendChild(r),i.classList.add("button-style"),this.addEventListener("change",e=>this.onChange(e))}get inputElm(){return this.querySelector("input")}onChange(e){try{this.callback(e,this.value)}catch(e){console.error(e)}this.value=""}}customElements.define("asui-input-file",AudioSourceUIFileInput);class AudioSourceUIText extends HTMLElement{constructor(e,t){super(),null!==e&&this.setAttribute("key",e),this.innerHTML=t}get key(){return this.getAttribute("key")}}customElements.define("asui-text",AudioSourceUIText);class AudioSourceUIIcon extends HTMLElement{constructor(e,t){super(),null!==e&&this.setAttribute("key",e),this.classList.add(t)}get key(){return this.getAttribute("key")}}customElements.define("asui-icon",AudioSourceUIIcon);class AudioSourceUtilities{constructor(){}get sources(){return{MidiParser:[this.getScriptDirectory("assets/3rdparty/MidiParser/main.js"),"https://cdn.jsdelivr.net/gh/colxi/midi-parser-js/src/main.js"],LZString:[this.getScriptDirectory("assets/3rdparty/LZString/lz-string.min.js"),"https://cdn.jsdelivr.net/gh/pieroxy/lz-string/libs/lz-string.min.js"]}}async loadJSLibrary(i,r=null){if(r||(r=(()=>void 0!==window[i])),r())return!0;const e=this.sources[i];for(let i=0;i<e.length;i++)if(await this.loadScript(e[i]),r())return!0;throw new Error(`Failed to load ${i} Library`)}async getMidiParser(){return void 0===window.MidiParser&&await this.loadJSLibrary("MidiParser"),window.MidiParser}async getLZString(){return void 0===window.LZString&&await this.loadJSLibrary("LZString"),window.LZString}async loadPackageInfo(i=!1){const r=this.getScriptDirectory("package.json");let e=AudioSourceUtilities.packageInfo;if(!i&&e)return e;if(!(e=await this.loadJSON(r)).version)throw new Error("Invalid package version: "+r);return console.log("Package Version: ",e.version,e),AudioSourceUtilities.packageInfo=e,e}getScriptElement(){return document.head.querySelector('script[src$="audio-source-composer-element.js"],script[src$="audio-source-composer.min.js"]')}getScriptDirectory(i=""){return this.getScriptElement().src.split("/").slice(0,-2).join("/")+"/"+i}async loadScript(i){await new Promise((r,e)=>{const t=document.createElement("script");t.src=i,t.onload=(i=>r()),document.head.appendChild(t)})}async loadJSON(i){return i=new URL(i,document.location)+"",new Promise((r,e)=>{const t=new XMLHttpRequest;t.open("GET",i,!0),t.responseType="json",t.onload=(()=>{if(200!==t.status)return e("JSON file not found: "+i);r(t.response)}),t.send()})}}AudioSourceUtilities.instrumentLibrary=null,AudioSourceUtilities.packageInfo=null,"undefined"!=typeof module&&(module.exports={AudioSourceUtilities:AudioSourceUtilities});class AudioSourceValues{constructor(e=null){this.song=e}get noteFrequencies(){return["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"]}get valueTypes(){return["beats-per-measure","beats-per-minute","command-group-execute","note-frequency-named","durations","groups","named-durations","note-frequency","note-frequency-all","note-frequency-octaves","song-groups","song-instruments","song-recent-list","velocities"]}getValues(e,t){let s,n=[],r=null;const o=e=>{null!=e&&n.push(e)},a=this.song?this.song.data:null,u=this.song?this.song.timeDivision:384;switch(e){case"song-recent-list":break;case"song-instruments":if(this.song&&a.instruments){const e=a.instruments;for(let s=0;s<e.length;s++){const n=e[s]||{name:"No Instrument Loaded"};r=t(s,this.format(s,"instrument")+": "+(n.name?n.name:n.url.split("/").pop())),o(r)}}break;case"note-frequency-named":if(a)for(let e=0;e<a.instruments.length;e++)if(this.song.isInstrumentLoaded(e)){const s=this.song.getInstrument(e);if(s.getFrequencyAliases){const n=s.getFrequencyAliases();for(const s in n)if(n.hasOwnProperty(s)){const a=n[s];r=t(s,a,e),o(r)}}}break;case"note-frequency":s=this.noteFrequencies;for(let e=0;e<s.length;e++){const n=s[e];r=t(n,n),o(r)}break;case"note-frequency-all":s=this.noteFrequencies;for(let e=1;e<=8;e++)for(let n=0;n<s.length;n++){const a=s[n]+e;r=t(a,a),o(r)}break;case"note-frequency-octaves":for(let e=1;e<=7;e+=1)r=t(e,""+e),o(r);break;case"velocities":for(let e=100;e>=0;e-=10)r=t(e,e),o(r);break;case"durations":for(let e=64;e>1;e/=2){let s=`1/${e}`;r=t(1/e/1.5*u,`${s}t`),o(r),r=t(1/e*u,`${s}`),o(r),r=t(1/e*1.5*u,`${s}d`),o(r)}for(let e=1;e<=16;e++)r=t(e*u,e+"B"),o(r);break;case"named-durations":for(let e=64;e>1;e/=2){let s=`1/${e}`;r=t(`${s}t`,`${s}t`),o(r),r=t(`${s}`,`${s}`),o(r),r=t(`${s}d`,`${s}d`),o(r)}for(let e=1;e<=16;e++)r=t(e+"B",e+"B"),o(r);break;case"beats-per-measure":for(let e=1;e<=12;e++)r=t(e,e+` beat${e>1?"s":""} per measure`),o(r);break;case"beats-per-minute":for(let e=40;e<=300;e+=10)r=t(e,e+` beat${e>1?"s":""} per minute`),o(r);break;case"segment-lengths":[4,5,6,7,8,10,12,16,24,32,48,64,96,128].forEach(e=>{r=t(u*e,e+"B"),o(r)});break;case"song-groups":case"groups":a&&a.instructions&&Object.keys(a.instructions).forEach(function(e,s){r=t(e,e),o(r)});break;case"command-group-execute":a&&a.instructions&&Object.keys(a.instructions).forEach(function(e,s){r=t("@"+e,"@"+e),o(r)});break;default:throw new Error("Invalid Value type: "+e)}return n}format(e,t){switch(t){case"duration":let s;return this.getValues("durations",(t,n)=>{e!==t&&e!==n||(s=n)}),s?s:(e=parseFloat(e).toFixed(2)).replace(".00","t");case"instrument":return"number"!=typeof e?"N/A":e<10?"0"+e:""+e;case"velocity":return"number"!=typeof e?"N/A":100===e?"Max":e+"";case"command":return e;default:throw new Error("Unknown format: "+t)}}formatPlaybackPosition(e){let t=Math.floor(e/60);e%=60;let s=Math.round(1e3*(e-Math.floor(e)));return e=Math.floor(e),`${t=(t+"").padStart(2,"0")}:${e=(e+"").padStart(2,"0")}:${s=(s+"").padStart(3,"0")}`}parsePlaybackPosition(e){const t=e.split(":");return 60*parseInt(t[0])+parseInt(t[1])+parseInt(t[2])/1e3}}"undefined"!=typeof module&&(module.exports={AudioSourceValues:AudioSourceValues}),"undefined"!=typeof global&&void 0===global.AudioSourceUtilities&&(global.AudioSourceUtilities=require("./audio-source-utilities.js").AudioSourceUtilities);"undefined"==typeof HTMLElement&&(global.HTMLElement=class{});class AudioSourceLibrary extends HTMLElement{constructor(e){super(),this.url=null,this.urlPrefix=null,this.name="Loading...",this.samples={},this.libraries={},this.presets={},this.instruments={},Object.assign(this,e)}eachLibrary(e){this.processItemList(this.libraries,r=>{r.url=new URL(this.urlPrefix+(r.url||r.name),this.url)+"",e(r)})}eachSample(e){this.processItemList(this.samples,r=>{r.url=new URL(this.urlPrefix+(r.url||r.name),this.url)+"",e(r)})}eachPreset(e){this.processItemList(this.presets,r=>(r.url=this.url+"#"+r.name,e(r)))}eachInstrument(e){this.processItemList(this.instruments,r=>{r.url=new URL(this.urlPrefix+(r.url||r.name),this.url)+"",e(r)})}getPresetConfig(e){let r=null;if(this.processItemList(this.presets,s=>{if(s.name===e)return r=s,!1}),!r)throw new Error("Preset not found: "+e);r.samples||(r.samples={}),0===Object.keys(r.samples).length&&(r.samples[e]={});const s={};return s.preset=e,s.samples=[],this.processItemList(r.samples,e=>{void 0!==this.samples[e.name]&&Object.assign(e,this.samples[e.name]),e.url=new URL(this.urlPrefix+(e.url||e.name),this.url)+"",s.samples.push(e)}),s.libraryURL=this.url,s.preset=e,s}processItemList(e,r,s="url"){const i=(e,i=null)=>{if("string"==typeof e){const r={};r[s]=e,e=r}void 0===(e=Object.assign({},e)).name&&i&&(e.name=i),r(e)};if(Array.isArray(e))for(let r=0;r<e.length&&!1!==i(e[r]);r++);else{if("object"!=typeof e)throw new Error("Unknown array or object");for(let r in e)if(e.hasOwnProperty(r)&&!1===i(e[r],r))break}}}AudioSourceLibrary.eachHistoricLibrary=(async e=>{for(let r in AudioSourceLibrary.cache)if(AudioSourceLibrary.cache.hasOwnProperty(r)){let s=AudioSourceLibrary.cache[r];s instanceof Promise&&(s=await s);let i=s.name||s.url.split("/").pop();if(!1===e(s.url,i))return}}),AudioSourceLibrary.loadURL=async function(e){if(!e)throw new Error("Invalid url");let r;return e=new URL((e+"").split("#")[0],document.location)+"",AudioSourceLibrary.cache[e]?(r=AudioSourceLibrary.cache[e])instanceof Promise&&(r=await r):(AudioSourceLibrary.cache[e]=new Promise((r,s)=>{const i=new XMLHttpRequest;i.open("GET",e+"",!0),i.responseType="json",i.onload=(()=>{if(200!==i.status)return s("Sample library not found: "+e);const t=i.response;t.url=e+"",Object.keys(AudioSourceLibrary.cache).forEach(e=>{Object.values(AudioSourceLibrary.cache)>5&&delete AudioSourceLibrary.cache[e]}),AudioSourceLibrary.cache[e]=t,console.info("Sample Library Loaded: ",e,AudioSourceLibrary.cache),r(t)}),i.send()}),r=await AudioSourceLibrary.cache[e]),new AudioSourceLibrary(r)},AudioSourceLibrary.cache={},"undefined"!=typeof customElements&&customElements.define("audio-source-library",AudioSourceLibrary),"undefined"!=typeof module&&(module.exports={AudioSourceLibrary:AudioSourceLibrary});class AudioSourceSong{constructor(t={},n=null){this.dispatchElement=n,this.audioContext=null,this.instruments={loaded:[],class:{},classPromises:{},promises:{}},this.seekLength=.5,this.playbackPosition=0,this.volumeGain=null,this.activeGroups={},this.data=null,this.loadSongData(t),this.history=[],"undefined"!=typeof document&&document.addEventListener("instrument:loaded",t=>this.onSongEvent(t))}dispatchEvent(t){this.dispatchElement&&this.dispatchElement.dispatchEvent(t)}getAudioContext(){if(this.audioContext)return"suspended"===this.audioContext.state&&this.audioContext.resume(),this.audioContext;this.audioContext=new(window.AudioContext||window.webkitAudioContext);this.audioContext.createGain();return this.audioContext}get guid(){return this.data.guid}get timeDivision(){return this.data.timeDivision}get startingBeatsPerMinute(){return this.data.beatsPerMinute}get rootGroup(){return this.data.root}getVolumeGain(){if(!this.volumeGain){const t=this.getAudioContext();let n=t.createGain();n.gain.value=AudioSourceSong.DEFAULT_VOLUME,n.connect(t.destination),this.volumeGain=n}return this.volumeGain}getVolumeValue(){return this.volumeGain?100*this.volumeGain.gain.value:100*AudioSourceSong.DEFAULT_VOLUME}setVolume(t){const n=this.getVolumeGain();n.gain.value!==t&&(n.gain.value=t/100,this.dispatchEvent(new CustomEvent("song:volume",{detail:{volume:t}})))}async loadSongData(t,n=null){t=Object.assign({},{name:this.generateName(),guid:this.generateGUID(),version:"0.0.1",root:"root",created:(new Date).getTime(),timeDivision:384,beatsPerMinute:120,beatsPerMeasure:4,instruments:[],instructions:{root:[]}},t),this.data=t,Object.keys(t.instructions).map((t,n)=>this.processAllInstructionData(t)),await this.loadAllInstruments(),this.dispatchEvent(new CustomEvent("song:loaded",{detail:this}))}loadSongHistory(t){this.history=t}processAllInstructionData(t){const n=this.data.instructions[t];for(let t=0;t<n.length;t++){const i=n[t];n[t]=this.processInstructionData(i)}}processInstructionData(t){return SongInstruction.parse(t).data}getInstructions(t,n=null){let i=this.data.instructions[t];if(!i)throw new Error("Instruction group not found: "+t);return n&&("number"==typeof n&&(n=[n]),i=i.filter((t,i)=>-1!==n.indexOf(i))),i.map(t=>new SongInstruction(t))}getInstructionIndex(t,n){n instanceof SongInstruction&&(n=n.data);const i=this.data.instructions[t].indexOf(n);if(-1===i)throw new Error("Instruction not found in instruction list");return i}getInstruction(t,n,i=!0){let e=this.data.instructions[t];if(!Number.isInteger(n)){if(i)throw new Error("Invalid Index: "+typeof n);return null}if(n>=e.length){if(i)throw new Error(`Instruction index is greater than group length: ${n} >= ${e.length} for groupName: ${t}`);return null}if(!e[n]){if(i)throw new Error(`Instruction not found at index: ${n} for groupName: ${t}`);return null}return new SongInstruction(e[n],n)}getInstructionGroupLength(t){return this.data.instructions[t].length}getIterator(t,n=null){return new AudioSourceInstructionIterator(this,t,n?n.currentBPM:this.startingBeatsPerMinute,n?n.groupPositionInTicks:0)}eachGroupInstruction(t,n,i=null){if(!this.data.instructions[t])throw new Error("Invalid group: "+t);const e=this.getIterator(t,i);let r=e.nextInstruction();for(;r;){if(!1===n(r,e))break;r=e.nextInstruction()}return e.groupPlaybackTime}eachSongInstruction(t){return Object.keys(this.data.instructions).forEach(n=>{const i=this.getIterator(n);let e;for(;e=i.nextInstruction();){if(!1===t(e,i))break}}),[]}getSongLength(){return this.getGroupLength(this.rootGroup)}getGroupLength(t){const n=this.getIterator(t);let i;for(;i=n.nextInstruction(););return n.groupPlaybackTime}getSongPositionFromTicks(t){return this.getGroupPositionFromTicks(this.rootGroup,t)}getGroupPositionFromTicks(t,n){let i=null;if(this.eachGroupInstruction(t,(t,e)=>{if(i=e,e.groupPositionInTicks>=n)return!1}),!i)return 0;let e=i.groupPlaybackTime;if(n>i.groupPositionInTicks){const t=n-i.groupPositionInTicks;e+=this.ticksToSeconds(t,i.currentBPM)}else if(n<i.groupPositionInTicks){const t=i.groupPositionInTicks-n;e-=this.ticksToSeconds(t,i.currentBPM)}return e}getSongPositionInTicks(t=null){return null===t&&(t=this.songPlaybackPosition),this.getGroupPositionInTicks(this.rootGroup,t)}getGroupPositionInTicks(t,n){let i=null;if(this.eachGroupInstruction(t,(t,e)=>{if(i=e,e.groupPlaybackTime>=n)return!1}),!i)return 0;let e=i.groupPositionInTicks;if(n>i.groupPlaybackTime){const t=n-i.groupPlaybackTime;e+=this.secondsToTicks(t,i.currentBPM)}else if(n<i.groupPlaybackTime){const t=i.groupPlaybackTime-n;e-=this.secondsToTicks(t,i.currentBPM)}return e}ticksToSeconds(t,n){return t/this.timeDivision*(60/n)}secondsToTicks(t,n){return Math.round(t*this.timeDivision/(60/n))}async play(){this.playback&&(this.stopPlayback(),this.setPlaybackPosition(0)),await this.initAllInstruments(this.getAudioContext());const t=new AudioSourceInstructionPlayback(this,this.rootGroup,this.getAudioContext().currentTime-this.playbackPosition);this.playback=t,console.log("Start playback:",this.playbackPosition),this.dispatchEvent(new CustomEvent("song:play",{detail:{playback:this.playback}})),await this.playback.playGroup(),this.dispatchEvent(new CustomEvent("song:end",{detail:{playback:this.playback}})),t.isPlaybackActive&&t.stopPlayback()}stopPlayback(){if(!this.playback)throw new Error("Playback is already stopped");this.playbackPosition=this.getAudioContext().currentTime-this.playback.startTime,this.playback.stopPlayback(),this.playback=null,console.log("End playback:",this.playbackPosition)}get isPlaying(){return!!this.playback}get songPlaybackPosition(){return this.playback?this.getAudioContext().currentTime-this.playback.startTime:this.playbackPosition}setPlaybackPositionInTicks(t){if(!Number.isInteger(t))throw new Error("Invalid start position in ticks");const n=this.getSongPositionFromTicks(t);return this.setPlaybackPosition(n)}setPlaybackPosition(t){if(t=parseFloat(t),Number.isNaN(t))throw new Error("Invalid start position");this.playbackPosition=t;const n=this.getSongPositionInTicks(this.playbackPosition),i={position:this.playbackPosition,positionInTicks:n};this.dispatchEvent(new CustomEvent("song:seek",{detail:i}))}isPlaybackActive(){for(const t in this.activeGroups)if(this.activeGroups.hasOwnProperty(t)&&!0===this.activeGroups[t])return!0;return!1}async playInstructionAtIndex(t,n,i=null){this.getAudioContext();const e=this.getInstruction(t,n,!1);e?await this.playInstruction(e,i):console.warn("No instruction at index")}async playInstruction(t,n=null,i=null){if(!t instanceof SongInstruction)throw new Error("Invalid instruction");if(t.isGroupCommand()){const i=new AudioSourceInstructionPlayback(this,t.getGroupFromCommand(),n);return await i.playGroup()}let e=this.startingBeatsPerMinute,r=this.timeDivision;const s=t.getDurationAsTicks(r)/r/(e/60);let o=this.getAudioContext().currentTime;n||0===n||(n=o),this.playInstrument(t.instrument,t.command,n,s,t.velocity),n>o&&(setTimeout(()=>{this.dispatchEvent(new CustomEvent("note:start",{detail:{groupName:i,instruction:t}}))},1e3*(n-this.getAudioContext().currentTime)),s&&setTimeout(()=>{this.dispatchEvent(new CustomEvent("note:end",{detail:{groupName:i,instruction:t}}))},1e3*(n+s-this.getAudioContext().currentTime)))}onSongEvent(t){switch(t.type){case"instrument:loaded":const n=t.detail.class,i=t.detail.url;this.instruments.class[i]=n,this.loadAllInstruments()}}isInstrumentLoaded(t){return!!this.instruments.loaded[t]}async playInstrument(t,n,i,e,r){if(t||0===t||(console.warn("No instrument set for instruction. Using instrument 0"),t=0),!this.data.instruments[t])return void console.error(`Instrument ${t} is not loaded. Playback skipped. `);let s=this.getInstrument(t);const o=this.getVolumeGain();return await s.play(o,n,i,e,r)}getInstrumentConfig(t,n=!0){const i=this.getInstrumentList();if(i[t])return i[t];if(n)throw new Error("Instrument ID not found: "+t);return null}getInstrument(t,n=!0){if(this.instruments.loaded[t])return this.instruments.loaded[t];if(n)throw new Error("Instrument not yet loaded: "+t);return null}getInstrumentList(){return this.data.instruments.slice()}async loadInstrumentClass(t){t=new URL(t)+"";let n=this.instruments.class[t];if(n)return n;const i=document.createElement("script");i.src=t;const e=new Promise((n,e)=>{i.onload=n,i.onerror=(n=>{i.parentNode.removeChild(i),e("Error loading: "+t)})});if(document.head.appendChild(i),await e,!this.instruments.class[t])throw new Error("Failed to load instrument class: "+t);return this.instruments.class[t]}async loadInstrument(t,n=!1){if(t=parseInt(t),!n&&this.instruments.loaded[t])return!0;this.instruments.loaded[t]=null;const i=this.getInstrumentConfig(t);if(!i.url)throw new Error("Invalid instrument URL");let e=new URL(i.url,document.location.origin);const r=new(await this.loadInstrumentClass(e))(i,this,t);return this.instruments.loaded[t]=r,this.dispatchEvent(new CustomEvent("instrument:instance",{detail:{instance:r,instrumentID:t},bubbles:!0})),this.audioContext&&await this.initInstrument(t,this.audioContext),!0}async loadAllInstruments(){const t=this.getInstrumentList();for(let n=0;n<t.length;n++)t[n]&&await this.loadInstrument(n)}async initInstrument(t,n){const i=this.getInstrument(t);await i.init(n)}async initAllInstruments(t){console.time("initAllInstruments");const n=this.getInstrumentList();for(let i=0;i<n.length;i++){const n=this.getInstrument(i,!1);n&&await n.init(t)}console.timeEnd("initAllInstruments")}hasGroup(t){return void 0!==this.data.instructions[t]}getName(){return this.data.name}setName(t){return this.replaceDataPath(["name"],t)}getVersion(){return this.data.version}setVersion(t){return this.replaceDataPath(["version"],t)}addInstrument(t){if("object"!=typeof t&&(t={url:t}),!t.url)throw new Error("Invalid Instrument URL");const n=this.data.instruments.length;return this.replaceDataPath(["instruments",n],t),this.loadInstrument(n),this.dispatchEvent(new CustomEvent("instrument:modified",{bubbles:!0,detail:{instrumentID:n,config:t,oldConfig:null}}),1),n}async replaceInstrument(t,n){let i=this.data.instruments[t]||{};return"object"!=typeof n&&(n={url:n}),i&&i.name&&!n.name&&(n.name=i.name),i=this.replaceDataPath(["instruments",t],n),this.dispatchEvent(new CustomEvent("instrument:modified",{bubbles:!0,detail:{instrumentID:t,config:n,oldConfig:i}}),1),i}removeInstrument(t){if(!this.data.instruments[t])throw new Error("Invalid instrument ID: "+t);delete this.instruments.loaded[t];const n=this.deleteDataPath(["instruments",t]);return this.dispatchEvent(new CustomEvent("instrument:modified",{bubbles:!0,detail:{instrumentID:t,config:null,oldConfig:n}}),1),n}replaceInstrumentParam(t,n,i){if(t=parseInt(t),!this.data.instruments[t])throw new Error("Invalid instrument ID: "+t);return Array.isArray(n)||(n=[n]),n.unshift(t),n.unshift("instruments"),this.replaceDataPath(n,i)}deleteInstrumentParam(t,n){if(t=parseInt(t),!this.data.instruments[t])throw new Error("Invalid instrument ID: "+t);return Array.isArray(n)||(n=[n]),n.unshift(t),n.unshift("instruments"),this.deleteDataPath(n)}setInstrumentName(t,n){return this.replaceInstrumentParam(t,"name",n)}generateName(){return`Untitled (${(new Date).toJSON().slice(0,10).replace(/-/g,"/")})`}generateGUID(){var t=(new Date).getTime();return"undefined"!=typeof performance&&"function"==typeof performance.now&&(t+=performance.now()),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){var i=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"===n?i:3&i|8).toString(16)})}generateInstructionGroupName(t="group"){const n=this.data;for(let i=0;i<=999;i++){const e=t+i;if(!n.instructions.hasOwnProperty(e))return e}throw new Error("Failed to generate group name")}findDataPath(t){if(!Array.isArray(t))throw new Error("Path list must be an array");if("*"===t[0])return{value:this.data,parent:{key:this.data},key:"key"};let n,i=this.data,e=null;for(let r=0;r<t.length;r++){if(e=t[r],/^\d+$/.test(e)&&(e=parseInt(e)),n=i,void 0===i)throw new Error("Invalid path key: "+e);i=i[e]}if(!n)throw new Error("Invalid path: "+t.join("."));return{value:i,parent:n,key:e}}insertDataPath(t,n){const i=this.findDataPath(t);if(n=AudioSourceSong.sanitizeInput(n),"number"!=typeof i.key)throw new Error("Insert action requires numeric key");if(i.parent.length<i.key)throw new Error(`Insert position out of index: ${i.parent.length} < ${i.key} for path: ${t}`);return i.parent.splice(i.key,0,n),this.queueHistoryAction(t,n),null}deleteDataPath(t){const n=this.findDataPath(t),i=n.parent[n.key];if("number"==typeof n.key){if(n.parent.length<n.key)throw new Error(`Delete position out of index: ${n.parent.length} < ${n.key} for path: ${t}`);n.parent.splice(n.key,1)}else delete n.parent[n.key];return this.queueHistoryAction(t,null,i),i}replaceDataPath(t,n){const i=this.findDataPath(t);if(void 0===n)return this.deleteDataPath(t);let e=null;return n=AudioSourceSong.sanitizeInput(n),void 0!==i.parent[i.key]&&(e=i.parent[i.key]),i.parent[i.key]=n,this.queueHistoryAction(t,n,e),e}queueHistoryAction(t,n=null,i=null){const e=[t];return null===n&&null===i||e.push(n),null!==i&&e.push(i),this.history.push(e),this.dispatchEvent(new CustomEvent("song:modified",{detail:e}),1),e}insertInstructionAtPosition(t,n,i){if("string"==typeof n&&(n=SongInstruction.parseDurationAsTicks(n,this.timeDivision)),!Number.isInteger(n))throw new Error("Invalid integer: "+typeof n);if(!i)throw new Error("Invalid insert instruction");const e=SongInstruction.parse(i);let r=this.data.instructions[t];const s=this.getIterator(t);let o=s.nextInstruction();for(;;){if(s.groupPositionInTicks>n){const i=[n-(s.groupPositionInTicks-o.deltaDuration),s.groupPositionInTicks-n],r=s.groupIndex;return this.replaceInstructionDeltaDuration(t,r,i[1]),e.deltaDuration=i[0],this.insertInstructionAtIndex(t,r,e),r}if(s.groupPositionInTicks===n){let n;for(n=s.groupIndex+1;n<r.length&&!(new SongInstruction(r[n]).deltaDuration>0);n++);return e.deltaDuration=0,this.insertInstructionAtIndex(t,n,e),n}if(!o)break;o=s.nextInstruction()}if(s.groupPositionInTicks>=n)throw new Error("Something went wrong");let a=r.length;return e.deltaDuration=n-s.groupPositionInTicks,this.insertInstructionAtIndex(t,a,e),a}insertInstructionAtIndex(t,n,i){if(!i)throw new Error("Invalid insert instruction");i=SongInstruction.parse(i).data,this.insertDataPath(["instructions",t,n],i)}deleteInstructionAtIndex(t,n){const i=this.getInstruction(t,n);if(i.deltaDuration>0){const e=this.getInstruction(t,n+1,!1);e&&this.replaceInstructionDeltaDuration(t,n+1,e.deltaDuration+i.deltaDuration)}return this.deleteDataPath(["instructions",t,n])}replaceInstructionDeltaDuration(t,n,i){return this.replaceInstructionParam(t,n,0,i)}replaceInstructionCommand(t,n,i){return this.replaceInstructionParam(t,n,1,i)}replaceInstructionInstrument(t,n,i){return this.replaceInstructionParam(t,n,2,i)}replaceInstructionDuration(t,n,i){return this.replaceInstructionParam(t,n,3,i)}replaceInstructionVelocity(t,n,i){if(!Number.isInteger(i))throw new Error("Velocity must be an integer: "+i);if(i<0)throw new Error("Velocity must be a positive integer: "+i);return this.replaceInstructionParam(t,n,4,i)}replaceInstructionParam(t,n,i,e){return null===e?this.deleteDataPath(["instructions",t,n,i]):this.replaceDataPath(["instructions",t,n,i],e)}addInstructionGroup(t,n){if(this.data.instructions.hasOwnProperty(t))throw new Error("New group already exists: "+t);this.replaceDataPath(["instructions",t],n||[])}removeInstructionGroup(t){if("root"===t)throw new Error("Cannot remove root instruction group, n00b");if(!this.data.instructions.hasOwnProperty(t))throw new Error("Existing group not found: "+t);return this.replaceDataPath(["instructions",t])}renameInstructionGroup(t,n){if("root"===t)throw new Error("Cannot rename root instruction group, n00b");if(!this.data.instructions.hasOwnProperty(t))throw new Error("Existing group not found: "+t);if(this.data.instructions.hasOwnProperty(n))throw new Error("New group already exists: "+n);const i=this.replaceDataPath(["instructions",t]);this.replaceDataPath(["instructions",n],i)}applyHistoryActions(t){for(let n=0;n<t.length;n++){const i=t[n];switch(i.action){case"reset":Object.assign(this.data,i.data);break;case"insert":this.insertDataPath(i.path,i.data);break;case"delete":this.deleteDataPath(i.path);break;case"replace":this.replaceDataPath(i.path,i.data)}}this.history=[],this.processAllInstructionData()}static sanitizeInput(t){if(Array.isArray(t)){for(let n=0;n<t.length;n++)t[n]=AudioSourceSong.sanitizeInput(t[n]);return t}if("object"==typeof t){for(const n in t)t.hasOwnProperty(n)&&(t[n]=AudioSourceSong.sanitizeInput(t[n]));return t}if("string"!=typeof t)return t;if("undefined"!=typeof require){var n=new(require("bad-words"));if(n.isProfane(t))throw new Error("Swear words are forbidden");t=n.clean(t)}var i={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};return t.replace(/[&<>'"]/g,function(t){return i[t]})}onInput(t){t.defaultPrevented||t.type}}AudioSourceSong.DEFAULT_VOLUME=.7;class AudioSourceInstructionPlayback{constructor(t,n,i=null,e=1){i=i||t.getAudioContext().currentTime,this.song=t,this.groupName=n,this.seekLength=e,this.iterator=null,this.subGroups=[],this.startTime=i,this.quantizationInTicks=t.timeDivision}get groupPositionInTicks(){return this.iterator.groupPositionInTicks}get isPlaybackActive(){return!!this.iterator}async playGroup(){const t=this.song.getIterator(this.groupName);for(this.iterator=t,this.song.dispatchEvent(new CustomEvent("group:play",{detail:{playback:this,iterator:t}}));this.isPlaybackActive;)await this.playNextInstructionRow();this.song.dispatchEvent(new CustomEvent("group:end",{detail:{playback:this,iterator:t}}));let n=this.song.getAudioContext().currentTime-this.startTime;console.info("Group finished: ",this.groupName,n)}stopPlayback(t=!0){const n=this.iterator;if(this.iterator=null,this.song.dispatchEvent(new CustomEvent("group:stop",{detail:{playback:this,iterator:n}})),t){const t=this.song.getInstrumentList();for(let n=0;n<t.length;n++){const t=this.song.getInstrument(n,!1);t&&t.stopPlayback&&t.stopPlayback()}}this.subGroups.forEach(n=>n.stopPlayback(t))}async playNextInstructionRow(){if(!this.isPlaybackActive)throw new Error("Playback is not active");const t=this.iterator.nextInstructionQuantizedRow(this.quantizationInTicks);if(this.iterator.hasReachedEnd)return this.stopPlayback(!1),0;const n=this.song.getAudioContext(),i=this.startTime+this.iterator.groupPlaybackTime,e=i-n.currentTime;if(e>0&&await new Promise((t,n)=>setTimeout(t,1e3*e)),!this.isPlaybackActive)return;for(let n=0;n<t.length;n++){const e=t[n];if(e.isGroupCommand()){let t=e.getGroupFromCommand();if(t===this.iterator.groupName)return void console.error("Recursive group call. Skipping group '"+t+"'");const n=new AudioSourceInstructionPlayback(this.song,t,i);this.subGroups.push(n),n.playGroup()}else this.song.playInstruction(e,i,this.groupName)}const r={groupName:this.groupName,position:this.iterator.groupPlaybackTime,positionInTicks:this.iterator.groupPositionInTicks};this.song.dispatchEvent(new CustomEvent("group:seek",{detail:r}))}}class AudioSourceInstructionIterator{constructor(t,n,i=null,e=0){if(!t.data.instructions[n])throw new Error("Song group not found: "+n);this.song=t,this.groupName=n,this.currentBPM=i||t.startingBeatsPerMinute,this.groupPositionInTicks=e,this.lastInstructionGroupPositionInTicks=e,this.groupPlaybackTime=0,this.lastInstructionGroupPlaybacktime=0,this.groupIndex=-1,this.nextQuantizationBreakInTicks=0}get hasReachedEnd(){return void 0===this.instructionList[this.groupIndex+1]}get instructionList(){return this.song.data.instructions[this.groupName]}getInstruction(t,n=!0){const i=this.instructionList[t];if(!i){if(n)throw new Error("");return null}const e=new SongInstruction(i);return e.index=t,e.positionInTicks=this.groupPositionInTicks,e}currentInstruction(){const t=-1===this.groupIndex?0:this.groupIndex;return this.getInstruction(t,!1)}nextConditionalInstruction(t){let n,i=0;for(;n=this.nextInstruction();){if(i+=n.deltaDuration,!0===t(n))return n.deltaDuration=i,n}return null}nextInstruction(){if(this.hasReachedEnd)return null;this.groupIndex++;const t=this.instructionList[this.groupIndex],n=new SongInstruction(t);if(n.deltaDuration){this.groupPositionInTicks=this.lastInstructionGroupPositionInTicks+n.deltaDuration,this.lastInstructionGroupPositionInTicks=this.groupPositionInTicks;const t=n.deltaDuration/this.song.timeDivision/(this.currentBPM/60);this.groupPlaybackTime=this.lastInstructionGroupPlaybacktime+t,this.lastInstructionGroupPlaybacktime=this.groupPlaybackTime}return this.getInstruction(this.groupIndex)}nextInstructionRow(t=null){let n=this.nextInstruction();if(!n)return null;let i=[];for(n&&i.push(n);;){let t=this.getInstruction(this.groupIndex+1,!1);if(!t)break;if(t.deltaDuration)break;t=this.nextInstruction(),i.push(t)}return null!==t&&(i=i.filter(n=>n.instrument===t)),i}nextInstructionQuantizedRow(t,n=null){if(!t)throw new Error("Invalid Quantization value: "+typeof t);let i=this.getInstruction(this.groupIndex+1,!1);if(!i)return null;let e=this.lastInstructionGroupPositionInTicks+i.deltaDuration;if(-1!==this.groupIndex)for(;this.nextQuantizationBreakInTicks<=this.groupPositionInTicks;)this.nextQuantizationBreakInTicks+=t;if(e>this.nextQuantizationBreakInTicks){const n=this.nextQuantizationBreakInTicks-this.groupPositionInTicks;this.groupPositionInTicks=this.nextQuantizationBreakInTicks;const i=n/this.song.timeDivision/(this.currentBPM/60);return this.groupPlaybackTime+=i,this.nextQuantizationBreakInTicks+=t,[]}return this.nextInstructionRow(n)}*[Symbol.iterator](){let t;for(;t=this.nextInstruction();)yield t}}class AudioSourceConditionalInstructionIterator extends AudioSourceInstructionIterator{constructor(t,n,i=null,e=null,r=0){if(super(t,n,e,r),"function"!=typeof i)throw new Error("Invalid conditional callback");this.conditionalCallback=i}nextInstruction(){let t,n=0;for(;t=super.nextInstruction();){if(n+=t.deltaDuration,!0===this.conditionalCallback(t))return t.deltaDuration=n,t}return null}}class SongInstruction{constructor(t,n=null,i=null){this.data=t||[0,"",0],this.index=n,this.positionInTicks=i}get deltaDuration(){return this.data[0]}set deltaDuration(t){this.data[0]=SongInstruction.parseDurationAsTicks(t)}get command(){return this.data[1]||null}set command(t){this.data[1]=t}get instrument(){return void 0===this.data[2]?null:this.data[2]}set instrument(t){if(t=parseInt(t),Number.isNaN(t))throw new Error("Invalid Instrument ID");this.data[2]=t}get duration(){return void 0===this.data[3]?null:this.data[3]}set duration(t){if(t=parseFloat(t),Number.isNaN(t))throw new Error("Invalid Duration");this.data[3]=t}getDurationAsTicks(t){return SongInstruction.parseDurationAsTicks(this.duration,t)}get velocity(){return void 0===this.data[4]?null:this.data[4]}set velocity(t){if(t=parseInt(t),Number.isNaN(t))throw new Error("Invalid Velocity");this.data[4]=t}get panning(){return void 0===this.data[5]?null:this.data[5]}set panning(t){if(t=parseInt(t),Number.isNaN(t))throw new Error("Invalid Panning");this.data[5]=t}isGroupCommand(){return this.command&&"@"===this.command[0]}getGroupFromCommand(){return this.command.substr(1)}static parse(t){return t instanceof SongInstruction?t:("number"==typeof t?t=[t]:"string"==typeof t&&(t=t.split(":")).length>=2&&(t[1]=parseInt(t[1])),"string"==typeof t[0]&&t.unshift(0),new SongInstruction(t))}static parseDurationAsTicks(t,n){if(null===t||"number"==typeof t)return t;switch(t[t.length-1].toLowerCase()){case"t":return parseInt(t.substr(0,t.length-1));case"b":return n*parseFloat(t.substr(0,t.length-1))}throw new Error("Invalid Duration: "+t)}}if("undefined"!=typeof module&&(module.exports={AudioSourceSong:AudioSourceSong,AudioSourceInstructionIterator:AudioSourceInstructionIterator,AudioSourceInstructionPlayback:AudioSourceInstructionPlayback}),"undefined"!=typeof global&&void 0===global.CustomEvent){class t{constructor(t,n){}}global.CustomEvent=t}class AudioSourceStorage{constructor(){}async getRecentSongList(){return await this.decodeForStorage(localStorage.getItem("song-recent-list")||"[]")}generateName(){return`Untitled (${(new Date).toJSON().slice(0,10).replace(/-/g,"/")})`}generateGUID(){var e=(new Date).getTime();return"undefined"!=typeof performance&&"function"==typeof performance.now&&(e+=performance.now()),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var o=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?o:3&o|8).toString(16)})}generateDefaultSong(e=null){const t={name:this.generateName(),guid:this.generateGUID(),version:"0.0.1",root:"root",created:(new Date).getTime(),timeDivision:384,beatsPerMinute:120,beatsPerMeasure:4,instruments:[],instructions:{root:[]}};return e&&t.instruments.push({url:e}),t}async encodeForStorage(e,t=null,o=null){let r=JSON.stringify(e,t,o);const a=new AudioSourceUtilities;return(await a.getLZString()).compress(r)}async decodeForStorage(e){if(!e)return null;const t=new AudioSourceUtilities;return e=(await t.getLZString()).decompress(e)||e,JSON.parse(e)}saveState(e){localStorage.setItem("audio-source-state",JSON.stringify(e))}loadState(){let e=localStorage.getItem("audio-source-state");return e&&(e=JSON.parse(e)),e}async saveSongToMemory(e,t){e.guid||(e.guid=this.generateGUID());let o=[];try{o=await this.decodeForStorage(localStorage.getItem("song-recent-list")||"[]")}catch(e){console.error(e)}(o=o.filter(t=>t.guid!==e.guid)).unshift({guid:e.guid,title:e.name}),localStorage.setItem("song-recent-list",await this.encodeForStorage(o)),localStorage.setItem("song:"+e.guid,await this.encodeForStorage(e)),localStorage.setItem("song-history:"+e.guid,await this.encodeForStorage(t)),console.info("Song saved to memory: "+e.guid,e)}saveSongToFile(e,t=!0){const o="/** INSTRUCTIONS-"+this.generateGUID()+" **/";let r=JSON.stringify(e.instructions),a=JSON.stringify(Object.assign({},e,{instructions:o}),null,"\t");a=a.replace('"'+o+'"',r);const n="data:text/json;charset=utf-8,"+encodeURIComponent(a),s=document.createElement("a");s.setAttribute("href",n);let i=(e.name||"untitled").replace(/\s+/g,"_")+".json";if(t&&(i=window.prompt("Download as file?",i)),!i)return console.warn("Download canceled");s.setAttribute("download",i),document.body.appendChild(s),s.click(),s.remove()}async loadSongFromMemory(e){let t=localStorage.getItem("song:"+e);if(!t)throw new Error("Song Data not found for guid: "+e);let o=await this.decodeForStorage(t);if(!o)throw new Error("Invalid Song Data: "+t);return o}async loadSongHistoryFromMemory(e){let t=localStorage.getItem("song-history:"+e);return t?await this.decodeForStorage(t):null}async loadJSONFile(e){const t=await new Promise((t,o)=>{let r=new FileReader;r.readAsText(e),r.onload=(e=>{t(e.target.result)})});return JSON.parse(t)}getBatchRecentCommands(){let e=localStorage.getItem("batch-recent-commands");return e?e=JSON.parse(e):[]}addBatchRecentCommands(e){let t=this.getBatchRecentCommands();-1===t.indexOf(e)&&t.unshift(e),localStorage.setItem("batch-recent-commands",JSON.stringify(t))}getBatchRecentSearches(){let e=localStorage.getItem("batch-recent-searches");return e?e=JSON.parse(e):[]}addBatchRecentSearches(e){let t=this.getBatchRecentSearches();-1===t.indexOf(e)&&t.unshift(e),localStorage.setItem("batch-recent-searches",JSON.stringify(t))}}"undefined"!=typeof module&&(module.exports={AudioSourceStorage:AudioSourceStorage});class MIDISupport{constructor(){}loadMIDIInterface(e){navigator.requestMIDIAccess&&navigator.requestMIDIAccess().then(t=>{console.info("MIDI initialized",t);const o=[];t.inputs.forEach(t=>{o.push(t),t.addEventListener("midimessage",e)}),console.log("MIDI input devices detected: "+o.map(e=>e.name).join(", "))},e=>{throw new Error("error initializing MIDI: "+e)})}getCommandFromMIDINote(e){const t=Math.floor(e/12),o=e%12;return(new AudioSourceValues).noteFrequencies[o]+t}async loadMIDIFile(e){const t=new AudioSourceUtilities,o=await t.getMidiParser(),n=await new Promise((t,o)=>{let n=new FileReader;n.readAsArrayBuffer(e),n.onload=(e=>{t(e.target.result)})}),a=o.parse(new Uint8Array(n));return console.info("MIDI Data Loaded: ",a),a}async loadSongFromMidiFile(e,t=null){const o=await this.loadMIDIFile(e);return this.loadSongFromMIDIData(o,t)}loadSongFromMIDIData(e,t=null){const o={root:[]};let n=(new AudioSourceStorage).generateDefaultSong();n.instructions=o,n.timeDivision=e.timeDivision;const a=new AudioSourceSong(n);let i=0;for(let o=0;o<e.track.length;o++){const r="root",s={},c=e.track[o].event;let l=0,d=0,u=!1,I="Track "+o;for(let e=0;e<c.length;e++){const t=c[e];switch(t.type){case 8:case 9:u=!0;break;case 255:switch(t.metaType){case 3:I=t.data.trim()}}}if(!u){console.info("Skipping empty track: ",o,c);continue}const m=i++;t&&(n.instruments[m]={url:t+"",name:I});for(let e=0;e<c.length;e++){const t=c[e];switch(l+=t.deltaTime,t.type){case 8:let e=this.getCommandFromMIDINote(t.data[0]);if(s[e]){const o=s[e][0],n=s[e][1];let i=l-o;delete s[e],a.replaceInstructionDuration(r,n,i),console.log("OFF",o,t.deltaTime,e,i)}break;case 9:let o=this.getCommandFromMIDINote(t.data[0]),n=t.data[1];if(0===n&&s[o]){const e=s[o][1];let n=l-d;a.replaceInstructionDuration(r,e,n),console.log("OFF",d,t.deltaTime,o,n),delete s[o];break}d=l;const i=[0,o,m,0,n],c=a.insertInstructionAtPosition(r,l,i);s[o]=[l,c],console.log("ON ",l,o,n)}}}return a.data}}})();