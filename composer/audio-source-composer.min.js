(function(){class AudioSourceComposerElement extends AudioSourceComposerActions{constructor(){super(),this.versionString="-1",this.eventHandlers=[],this.saveSongToMemoryTimer=null,this.longPressTimeout=null,this.doubleClickTimeout=500,this.autoSaveTimeout=4e3,this.keyboard=new AudioSourceComposerKeyboard,this.song=new AudioSourceSong({},this),this.trackerElm=new AudioSourceComposerTracker,this.values=new AudioSourceValues(this.song),(new AudioSourceUtilities).loadPackageInfo().then(e=>this.setVersion(e.version)),window.addEventListener("unload",e=>this.saveState(e)),this.ui={}}getScriptDirectory(e=null){return(new AudioSourceUtilities).getScriptDirectory(e,'script[src$="audio-source-composer-element.js"],script[src$="audio-source-composer.min.js"]')}get defaultLibraryURL(){return this.getAttribute("defaultLibraryURL")||this.getScriptDirectory("default.library.json")}set defaultLibraryURL(e){this.setAttribute("defaultLibraryURL",e)}connectedCallback(){this.loadCSS(),this.attachEventHandler(["focus"],e=>this.onInput(e),this.shadowDOM,!0),this.attachEventHandler(["song:loaded","song:play","song:end","song:stop","song:modified","song:seek","group:play","group:seek","note:start","note:end"],this.onSongEvent),this.attachEventHandler(["instrument:instance","instrument:library","instrument:modified","instrument:loaded"],e=>this.onSongEvent(e),document),this.render(),this.focus(),this.loadState(),(new MIDISupport).loadMIDIInterface(e=>this.onInput(e))}disconnectedCallback(){this.eventHandlers.forEach(e=>e[2].removeEventListener(e[0],e[1]))}attachEventHandler(e,t,s,i=null){Array.isArray(e)||(e=[e]);for(let n=0;n<e.length;n++){const r=e[n];(s=s||this).addEventListener(r,t,i),this.eventHandlers.push([r,t,s])}}async loadState(e=null){const t=(new AudioSourceStorage).loadState();console.log("loadState",t),t?(await this.loadDefaultSong(t.songUUID),void 0!==t.volume&&this.setSongVolume(e,t.volume),void 0!==t.groupName&&(this.trackerElm.groupName=t.groupName),void 0!==t.trackerSegmentLength&&(this.fieldTrackerSegmentLength.value=t.trackerSegmentLength),void 0!==t.trackerRowLength&&(this.fieldTrackerRowLength.value=t.trackerRowLength),void 0!==t.trackerInstrument&&(this.fieldTrackerFilterInstrument.value=t.trackerInstrument),void 0!==t.trackerOctave&&(this.fieldTrackerOctave.value=t.trackerOctave),void 0!==t.currentRowSegmentID&&this.trackerElm.navigateSegment(t.currentRowSegmentID),void 0!==t.selectedIndicies&&this.selectIndicies(t.selectedIndicies)):await this.loadDefaultSong()}async saveState(e){const t={songUUID:this.song.uuid,groupName:this.trackerElm.groupName,currentRowSegmentID:this.trackerElm.currentRowSegmentID,volume:this.song.getVolumeValue(),trackerSegmentLength:this.fieldTrackerSegmentLength.value,trackerRowLength:this.fieldTrackerRowLength.value,trackerInstrument:this.fieldTrackerFilterInstrument.value,trackerOctave:this.fieldTrackerOctave.value,selectedIndicies:this.getSelectedIndicies()};(new AudioSourceStorage).saveState(t),console.log("saveState",t)}async loadDefaultSong(e=null){const t=this.getAttribute("src");if(t)return await this.loadSongFromSrc(t),!0;if(e)try{return void await this.loadSongFromMemory(e)}catch(e){console.error(e)}return await this.loadNewSongData(),!1}getAudioContext(){return this.song.getAudioContext()}updateSongPositionValue(e){const t=new AudioSourceValues;this.fieldSongPosition.value=t.formatPlaybackPosition(e)}onInput(e){if(console.log(e.type),!e.defaultPrevented){switch(e.type){case"focus":break;default:this.song.getAudioContext()}switch(e.type){default:case"midimessage":this.trackerElm&&this.trackerElm.onInput(e)}}}async onSongEvent(e){switch(this.trackerElm&&this.trackerElm.onSongEvent(e),e.type){case"song:seek":this.updateSongPositionValue(e.detail.position);break;case"song:volume":this.fieldSongVolume.value=e.detail.volume;break;case"song:loaded":this.trackerElm.renderDuration=this.song.timeDivision;break;case"song:play":this.classList.add("playing"),this.containerElm.classList.add("playing"),this.fieldSongPlaybackPause.disabled=!1;const t=setInterval(e=>{this.song.isPlaying||(clearInterval(t),this.fieldSongPlaybackPause.disabled=!0,this.containerElm.classList.remove("playing"),this.classList.remove("playing")),this.updateSongPositionValue(this.song.songPlaybackPosition)},10);break;case"song:pause":this.classList.add("paused"),this.containerElm.classList.add("paused");break;case"song:end":this.classList.remove("playing","paused"),this.containerElm.classList.remove("playing","paused");break;case"instrument:instance":this.renderInstrument(e.detail.instrumentID);break;case"instrument:modified":case"song:modified":switch(e.type){case"instrument:modified":e.detail.instrumentID&&this.renderInstrument(e.detail.instrumentID),this.panelInstructions.render()}clearTimeout(this.saveSongToMemoryTimer),this.saveSongToMemoryTimer=setTimeout(e=>this.saveSongToMemory(e),this.autoSaveTimeout);break;case"instrument:loaded":case"instrument:remove":this.renderInstruments(),this.panelInstructions.render();break;case"instrument:library":this.updateForms(),this.panelInstructions.render()}}setStatus(e){this.statusElm.innerHTML=e,console.info.apply(null,arguments)}handleError(e){this.statusElm.innerHTML=`<span style="red">${e}</span>`,console.error(e)}setVersion(e){this.versionString=e,this.versionElm.innerHTML=e}closeAllMenus(){this.shadowDOM.querySelector("asui-menu").closeAllMenus()}get statusElm(){return this.shadowDOM.querySelector("asui-div[key=asc-status-container] asui-div[key=status-text]")}get versionElm(){return this.shadowDOM.querySelector("asui-div[key=asc-status-container] asui-div[key=version-text]")}selectIndicies(e){if("string"==typeof e)switch(e){case"all":e=[];const t=this.song.getInstructionGroupLength(this.groupName);for(let s=0;s<t;s++)e.push(s);break;case"segment":e=[].map.call(this.querySelectorAll("asct-instruction"),e=>e.index);break;case"row":throw new Error("TODO");case"none":e=[];break;default:throw new Error("Invalid selection: "+e)}if("number"==typeof e&&(e=[e]),!Array.isArray(e))throw new Error("Invalid selection");this.fieldTrackerSelection.value=e.join(","),this.trackerElm.updateSelection()}getSelectedIndicies(){const e=this.fieldTrackerSelection.value;return""===e?[]:e.split(/\D+/).map(e=>parseInt(e))}clearSelectedIndicies(){this.fieldTrackerSelection.value=""}removeSelectedIndex(e){const t=this.getSelectedIndicies(),s=t.indexOf(e);-1!==s&&t.splice(s,1),this.fieldTrackerSelection.value=t.join(",")}addSelectedIndex(e){const t=this.getSelectedIndicies();-1===t.indexOf(e)&&(t.push(e),t.sort()),this.fieldTrackerSelection.value=t.join(",")}loadCSS(){const e=this.shadowDOM||document.head;if(e.querySelector('link[href$="audio-source-composer.css"]'))return;const t=(new AudioSourceUtilities).getScriptDirectory("composer/audio-source-composer.css");let s=document.createElement("link");s.setAttribute("rel","stylesheet"),s.setAttribute("type","text/css"),s.setAttribute("href",t),e.appendChild(s),console.info("Appending "+t)}}customElements.define("audio-source-composer",AudioSourceComposerElement);class AudioSourceComposerTracker extends HTMLElement{constructor(e="root"){super(),this.editorElm=null,this.eventHandlers=[],this.currentRowSegmentID=0,this.mousePosition={},e&&this.setAttribute("group",e),this.hasAttribute("tabindex")||this.setAttribute("tabindex","0")}get groupName(){return this.getAttribute("group")}set groupName(e){if(!this.editorElm.song.hasGroup(e))throw new Error("Group not found in song: "+e);this.setAttribute("group",e),this.currentRowSegmentID=0,this.render()}get isConnected(){return this.editorElm.containerElm.contains(this)}connectedCallback(){this.attachEventHandler(["scroll","keydown","mousedown","mouseup","mousemove","mouseout","touchstart","touchend","touchmove","dragstart","drag","dragend","contextmenu"],e=>this.onInput(e)),this.editorElm=this.getRootNode().host,this.render()}disconnectedCallback(){this.eventHandlers.forEach(e=>e[2].removeEventListener(e[0],e[1]))}attachEventHandler(e,t,s,i=null){Array.isArray(e)||(e=[e]);for(let r=0;r<e.length;r++){const n=e[r];(s=s||this).addEventListener(n,t,i),this.eventHandlers.push([n,t,s])}}playSelectedInstructions(){this.editorElm.song.isPlaying&&this.editorElm.song.stopPlayback();const e=this.editorElm.getSelectedIndicies();for(let t=0;t<e.length;t++)this.editorElm.song.playInstructionAtIndex(this.groupName,e[t])}getInstruction(e){return this.editorElm.song.getInstruction(this.groupName,e)}getInstructionFormValues(e=null){e||(e=this.editorElm.fieldInstructionCommand.value);let t=new SongInstruction;(this.editorElm.fieldInstructionInstrument.value||0===this.editorElm.fieldInstructionInstrument.value)&&(t.instrument=parseInt(this.editorElm.fieldInstructionInstrument.value)),this.editorElm.fieldInstructionDuration.value&&(t.duration=parseFloat(this.editorElm.fieldInstructionDuration.value));const s=parseInt(this.editorElm.fieldInstructionVelocity.value);return(s||0===s)&&(t.velocity=s),e=this.replaceFrequencyAlias(e,t.instrument),t.command=e,t}render(){this.renderRows()}navigateGroup(e){let t=this.findRowElement(e);if(t)return t;const s=this.getSegmentIDFromPositionInTicks(e);if(s!==this.currentRowSegmentID){this.navigateSegment(s);let t=this.findRowElement(e);if(t)return t}throw new Error("Shouldn't happen: Row not found for position: "+e)}getSegmentIDFromPositionInTicks(e){const t=this.editorElm.fieldTrackerSegmentLength.value;return Math.floor(e/t)}navigateSegment(e){if(!Number.isInteger(e))throw new Error("Invalid segment ID");this.currentRowSegmentID=e,this.renderRows()}renderRows(e=null){null===e&&(e=this.editorElm.getSelectedIndicies()),console.time("tracker.renderRows()");const t=this.editorElm.song.timeDivision;this.innerHTML="";let s=this.editorElm.song.getIterator(this.groupName);const i=parseInt(this.editorElm.fieldTrackerRowLength.value)||t,r=parseInt(this.editorElm.fieldTrackerSegmentLength.value)||16*t,n=Number.isInteger(this.editorElm.fieldTrackerFilterInstrument.value)?this.editorElm.fieldTrackerFilterInstrument.value:null,o=null===n?null:e=>e.instrument===n;let l=0,c=null,a=0;for(;c=s.nextInstructionQuantizedRow(i,o);)if(0!==c.length||s.groupPositionInTicks%i==0){if(l=Math.floor(s.groupPositionInTicks/r),this.currentRowSegmentID===l){const e=new AudioSourceComposerTrackerRow(s.groupPositionInTicks);this.appendChild(e),e.renderInstructions(c)}a=s.groupPositionInTicks}if(a<r)for(a=Math.ceil(a/i)*i;a<r;){const e=new AudioSourceComposerTrackerRow(a);this.appendChild(e),a+=i}const u=this.editorElm.panelTrackerRowSegments;u&&u.render(),this.selectSegmentIndicies(e),console.timeEnd("tracker.renderRows()")}onInput(e){if(e.defaultPrevented)return;switch(e.type){case"mouseup":this.isSelectionRectActive()&&this.commitSelectionRect()}if(e.target instanceof Node&&!this.contains(e.target))return;let t=this.editorElm.getSelectedIndicies();switch(e.type){case"midimessage":switch(e.data[0]){case 144:e.preventDefault();let t=(new MIDISupport).getCommandFromMIDINote(e.data[1]),s=Math.round(e.data[2]/128*100);console.log("MIDI ",t,s),this.insertOrUpdateCommand(e,t),this.playSelectedInstructions(e)}break;case"keydown":this.editorElm.closeAllMenus();let s=e.key;switch(!e.ctrlKey&&this.editorElm.keyboard.getKeyboardCommand(e.key,this.editorElm.fieldTrackerOctave.value)&&(s="PlayFrequency"),"Enter"===s&&e.altKey&&(s="ContextMenu"),s){case"Delete":e.preventDefault();const i=t.sort((e,t)=>t-e);for(let e=0;e<i.length;e++)this.editorElm.song.deleteInstructionAtIndex(this.groupName,t[e]);this.renderRows();break;case"Escape":case"Backspace":throw new Error("TODO: navigate pop");case"Enter":if(this.contains(e.target)){e.preventDefault(),this.insertOrUpdateCommand(e);let t=this.cursorInstruction;if(t.isGroupCommand()){const e=t.command.substr(1);this.editorElm.selectGroup(e)}else this.playSelectedInstructions(e)}break;case"Play":e.preventDefault(),this.playSelectedInstructions(e);break;case"ArrowRight":e.preventDefault(),this.selectNextCell(e),this.playSelectedInstructions(e),this.focus();break;case"ArrowLeft":e.preventDefault(),this.selectPreviousCell(e),this.playSelectedInstructions(e),this.focus();break;case"ArrowDown":e.preventDefault(),this.selectNextRowCell(e),this.playSelectedInstructions(e),this.focus();break;case"ArrowUp":e.preventDefault(),this.selectPreviousRowCell(e),this.playSelectedInstructions(e),this.focus();break;case" ":e.preventDefault(),this.editorElm.song.isPlaybackActive()?this.editorElm.song.stopPlayback():this.editorElm.song.play();break;case"PlayFrequency":let r=this.editorElm.keyboard.getKeyboardCommand(e.key,this.editorElm.fieldTrackerOctave.value);if(null===r)break;e.preventDefault(),this.insertOrUpdateCommand(e,r),this.playSelectedInstructions(e),this.focus()}break;case"touchstart":case"mousedown":if(this.editorElm.closeAllMenus(),this.mousePosition.isDown=!0,this.mousePosition.isDragging=!1,this.mousePosition.lastDown=e,delete this.mousePosition.lastDrag,e.target.matches("asct-instruction"))return this.onCellInput(e);if(e.target.matches("asct-instruction > *"))return this.onCellInput(e,e.target.instruction);if(e.target.matches("asct-instruction-add"))return this.onRowInput(e,e.target.row);if(e.target.matches("asct-row"))return this.onRowInput(e);break;case"touchmove":case"mousemove":1===e.which&&this.mousePosition.isDown&&(this.mousePosition.isDragging=!0,this.mousePosition.lastDrag=e),this.mousePosition.isDown&&this.mousePosition.lastDrag&&this.mousePosition.lastDown.path[0].matches("asct-row");break;case"touchend":case"mouseup":this.mousePosition.isDown=!1,this.mousePosition.isDragging&&this.mousePosition.lastDown.path[0].matches("asct-row"),this.mousePosition.isDragging=!1;const i=this.mousePosition.lastUp;if(e.t=new Date,this.mousePosition.lastUp=e,i&&i.t.getTime()+this.editorElm.doubleClickTimeout>(new Date).getTime()){e.preventDefault();const t=e.path[0],s=i.path[0];if(s===t||s.contains(t)||t.contains(s)){const s=new CustomEvent("doubleclick",{detail:{firstMouseEvent:i.e,secondMouseEvent:e,clientX:e.clientX,clientY:e.clientY},cancelable:!0,bubbles:!0});t.dispatchEvent(s)}}break;case"mouseout":e.target.matches("asc-tracker")&&this.isSelectionRectActive()&&this.commitSelectionRect();break;case"click":break;case"doubleclick":case"longpress":e.preventDefault(),this.contains(e.target)&&this.editorElm.menuContext.openContextMenu(e);break;case"contextmenu":e.altKey||(e.preventDefault(),this.editorElm.menuContext.openContextMenu(e,this.cursorCell));break;case"scroll":break;case"dragstart":case"drag":case"dragend":console.info(e.type);break;default:throw new Error("Unhandled type: "+e.type)}}updateSelectionRect(e,t){t||(t=this.mousePosition.lastDrag||this.mousePosition.lastDrag);var s=e.clientX-t.clientX,i=e.clientY-t.clientY;if(Math.sqrt(s*s+i*i)<30)return console.warn("Skipping selection rect");let r,n,o,l,c=this.querySelector("div.selection-rect");return c||((c=document.createElement("div")).classList.add("selection-rect"),this.appendChild(c)),e.clientX<t.clientX?(r=e.clientX,o=t.clientX-e.clientX):(r=t.clientX,o=e.clientX-t.clientX),e.clientY<t.clientY?(n=e.clientY,l=t.clientY-e.clientY):(n=t.clientY,l=e.clientY-t.clientY),c.style.left=r+"px",c.style.width=o+"px",c.style.top=n+"px",c.style.height=l+"px",this.querySelectorAll("asct-instruction").forEach(e=>{const t=e.getBoundingClientRect(),s=t.x+t.width>r&&t.x<r+o&&t.y+t.height>n&&t.y<n+l;e.classList.toggle("selecting",s)}),{x:r,y:n,w:o,h:l}}isSelectionRectActive(){return!!this.querySelector("div.selection-rect")}commitSelectionRect(e=null,t=null){e||(e=this.mousePosition.lastDown);let s=this.querySelector("div.selection-rect");if(!s)return console.warn("No selection rect");const i=s.getBoundingClientRect();s.parentNode.removeChild(s),this.clearSelection();const r=this.querySelectorAll("asct-instruction,asct-row"),n=[];r.forEach(e=>{const t=e.getBoundingClientRect();t.x+t.width>i.x&&t.x<i.x+i.width&&t.y+t.height>i.y&&t.y<i.y+i.height&&(n.push(e),e.select(!0,!1))}),console.log("Selection ",n,i)}setPlaybackPositionInTicks(e){let t=this.navigateGroup(e);this.querySelectorAll("asct-row.position").forEach(e=>e.classList.remove("position")),t.classList.add("position")}async onSongEvent(e){switch(e.type){case"song:seek":this.setPlaybackPositionInTicks(e.detail.positionInTicks);break;case"group:seek":e.detail.groupName===this.groupName&&this.setPlaybackPositionInTicks(e.detail.positionInTicks);break;case"group:play":break;case"note:start":if(e.detail.groupName===this.groupName){let t=this.findInstructionElement(e.detail.instruction.index);t&&t.classList.add("playing")}break;case"note:end":if(e.detail.groupName===this.groupName){let t=this.findInstructionElement(e.detail.instruction.index);t&&t.classList.remove("playing")}}}get selectedCells(){return this.querySelectorAll("asct-instruction.selected")}get cursorCell(){return this.querySelector("asct-instruction.cursor,asct-instruction-add.cursor")}get cursorPosition(){return(e=>e?e.parentNode.position:null)(this.cursorCell)}get cursorInstruction(){return this.getInstruction(this.cursorCell.index)}getCursorCell(){return this.querySelector(".cursor")}getCursorIndex(){const e=this.querySelector(".cursor");return e?e.index:null}updateSelection(){const e=this.editorElm.getSelectedIndicies();this.querySelectorAll("asct-instruction-add").forEach(e=>e.parentNode.removeChild(e)),this.querySelectorAll("asct-instruction").forEach(t=>{-1!==e.indexOf(t.index)?t.select(!0):t.select(!1)})}selectIndex(e,t,s=!1){const i=this.findInstructionElement(t);return!!i&&(this.selectCell(e,i,s),!0)}selectNextCell(e){let t=this.querySelector(".cursor")||this.querySelector("asct-instruction");return t?t instanceof AudioSourceComposerTrackerInstructionAdd?this.selectNextRowCell(e,0):t.nextInstructionSibling?this.selectCell(e,t.nextInstructionSibling):this.selectNextRowCell(e):this.selectRow(e,this.querySelector("asct-row"))}selectPreviousCell(e){let t=this.querySelector(".cursor")||this.querySelector("asct-instruction:last-child");return t?t.previousInstructionSibling?this.selectCell(e,t.previousInstructionSibling):this.selectPreviousRowCell(e):this.selectRow(e,this.querySelector("asct-row:last-child"))}selectNextRowCell(e,t=null){let s=this.querySelector(".cursor")||this.querySelector("asct-instruction");const i=s.parentNode;if(null===t&&(t=[].indexOf.call(s.parentNode.children,s)),!i.nextElementSibling)return this.currentRowSegmentID++,this.renderRows(),this.focus(),this.selectNextCell(e);const r=i.nextElementSibling;let n=r.querySelector("asct-instruction");return r.children[t]&&r.children[t].matches("asct-instruction")&&(n=r.children[t]),n?this.selectCell(e,n):this.selectRow(e,i.nextElementSibling),n}selectPreviousRowCell(e,t=null){let s=this.querySelector(".cursor")||this.querySelector("asct-instruction:last-child");const i=s.parentNode;if(null===t&&(t=[].indexOf.call(s.parentNode.children,s)),!i.previousElementSibling){if(0===this.currentRowSegmentID)throw new Error("TODO: reached beginning of song");return this.currentRowSegmentID--,this.renderRows(),this.focus(),this.selectPreviousCell(e)}let r,n=i.previousElementSibling;return n.children[t]&&n.children[t].matches("asct-instruction,asct-instruction-add")&&(r=n.children[t]),r?this.selectCell(e,r):this.selectRow(e,n),r}selectSegmentIndicies(e,t=!1){Array.isArray(e)||(e=[e]),t&&this.clearSelection();for(let t=0;t<e.length;t++){const s=e[t],i=this.findInstructionElement(s);i&&(i.select(!0,!1),0===t&&i.setCursor())}}selectRow(e,t){return e.ctrlKey||this.clearSelection(),t.createAddInstructionElement().setCursor(),this.editorElm.panelTracker.render(),this.focus(),t.parentNode.scrollTo(),this.editorElm.song.setPlaybackPositionInTicks(t.position),t.scrollTo(),t}selectCell(e,t,s=null){let i=!0;return null===s&&(s=!(e&&e.ctrlKey)),e&&e.shiftKey&&(i=!t.selected),s&&this.editorElm.clearSelectedIndicies(),this.editorElm.closeAllMenus(),t.select(i),t.setCursor(),this.editorElm.panelTracker.render(),this.focus(),this.editorElm.song.setPlaybackPositionInTicks(t.parentNode.position),t.parentNode.scrollTo(),t}onRowInput(e,t=null){e.preventDefault(),t=t||e.target,this.selectRow(e,t)}onCellInput(e,t){e.preventDefault(),t=t||e.target,this.selectCell(e,t,!e.shiftKey),this.playSelectedInstructions(e)}insertOrUpdateCommand(e,t=null){let s=this.editorElm.getSelectedIndicies();if(this.cursorCell.matches("asct-instruction-add")){let e=this.getInstructionFormValues(t);if(!e)return this.editorElm.fieldInstructionCommand.focus(),console.info("Insert canceled");const s=this.cursorPosition,i=this.insertInstructionAtPosition(s,e);this.renderRows(),this.selectSegmentIndicies(i,!0)}else{for(let e=0;e<s.length;e++){const i=this.getInstruction(s[e]),r=this.replaceFrequencyAlias(t,i.instrument);this.replaceInstructionCommand(s[e],r)}this.renderRows(),this.selectSegmentIndicies(s)}}replaceFrequencyAlias(e,t){const s=this.editorElm.song.getInstrument(t,!1);if(!s||!s.getFrequencyAliases)return e;const i=s.getFrequencyAliases(e);return void 0===i[e]?e:i[e]}findRowElement(e){return this.querySelector(`asct-row[p='${e}']`)}findInstructionElement(e){return this.querySelector(`asct-instruction[i='${e}']`)}}customElements.define("asc-tracker",AudioSourceComposerTracker);const VISIBLE_BUFFER=100;class AudioSourceComposerTrackerRow extends HTMLElement{constructor(e){super(),this.setAttribute("p",e)}get trackerElm(){return this.closest("asc-tracker")}get selected(){return this.classList.contains("selected")}get position(){return parseInt(this.getAttribute("p"))}get duration(){return this.nextElementSibling?this.nextElementSibling.position-this.position:"N/A"}set index(e){this.setAttribute("i",e)}get index(){return parseInt(this.getAttribute("i"))}get visible(){const e=this.parentNode.scrollTop+this.parentNode.offsetHeight,t=this.offsetTop+this.offsetHeight;return!(this.offsetTop-e>VISIBLE_BUFFER)&&!(t<this.parentNode.scrollTop-VISIBLE_BUFFER)}connectedCallback(){if(this.previousElementSibling&&this.previousElementSibling instanceof AudioSourceComposerTrackerRow){const e=this.position-this.previousElementSibling.position;this.previousElementSibling.renderDelta(e)}}createAddInstructionElement(){let e=this.querySelector("asct-instruction-add");if(!e){this.parentNode.querySelectorAll("asct-instruction-add").forEach(e=>e.parentNode.removeChild(e));const t=document.createElement("asct-instruction-add");e=t,t.innerHTML="+"}let t=this.querySelector("asct-delta");return t?this.insertBefore(e,t):this.appendChild(e),e}clearAddInstructionElement(){this.parentNode.querySelectorAll("asct-instruction-add").forEach(e=>e.parentNode.removeChild(e))}select(e=!0){if(e){if(this.selected)return void console.warn("Already selected ",this);this.classList.add("selected")}else{if(!this.selected)return void console.warn("Already unselected ",this);this.classList.remove("selected")}}clearAllCursors(){this.trackerElm.querySelectorAll(".cursor").forEach(e=>e.classList.remove("cursor"))}scrollTo(){const e=this.parentNode;e.scrollTop<this.offsetTop-e.offsetHeight&&(e.scrollTop=this.offsetTop),e.scrollTop>this.offsetTop&&(e.scrollTop=this.offsetTop-e.offsetHeight)}renderDelta(e){let t=this.querySelector("asct-delta");return t||(t=document.createElement("asct-delta"),this.appendChild(t)),t.render(e),this}renderInstructions(e=[]){const t=this.querySelectorAll("asct-instruction");let s=0;for(;s<t.length;s++){const i=e[s],r=t[s];s>=e.length?r.parentNode.removeChild(r):(r.index=i.index,r.render(e[s]))}let i=this.querySelector("asct-delta");for(;s<e.length;s++){const t=e[s],r=document.createElement("asct-instruction");r.index=t.index,i?this.insertBefore(r,i):this.appendChild(r),r.render(e[s])}return this}}customElements.define("asct-row",AudioSourceComposerTrackerRow);class AudioSourceComposerTrackerInstruction extends HTMLElement{constructor(){super()}get row(){return this.parentNode}get trackerElm(){if(!this.parentNode)throw new Error("Invalid tracker");return this.parentNode.trackerElm}get editorElm(){return this.trackerElm.editor}set index(e){this.setAttribute("i",e)}get index(){return parseInt(this.getAttribute("i"))}get selected(){return this.classList.contains("selected")}get nextInstructionSibling(){return this.nextElementSibling&&this.nextElementSibling.matches("asct-instruction")?this.nextElementSibling:null}get previousInstructionSibling(){return this.previousElementSibling&&this.previousElementSibling.matches("asct-instruction")?this.previousElementSibling:null}getInstruction(){return this.row.trackerElm.getInstruction(this.index)}play(){return this.editorElm.song.playInstructionAtIndex(this.trackerElm.groupName,this.index,this.editorElm.song.getAudioContext().currentTime,{groupPositionInTicks:this.row.position,currentIndex:this.index}),this}connectedCallback(){}scrollTo(){return this.row.scrollTo()}clearAllCursors(){return this.row.clearAllCursors()}setCursor(){return this.clearAllCursors(),this.classList.add("cursor"),this}select(e=!0){return e?(this.classList.add("selected"),this.editorElm.addSelectedIndex(this.index)):(this.classList.remove("selected","cursor"),this.editorElm.removeSelectedIndex(this.index)),this.render(),this}render(e=null){e=e||this.getInstruction();let t=this.querySelector("ascti-command");if(t||this.appendChild(t=document.createElement("ascti-command")),t.render(e),this.classList.contains("selected")){let t=this.querySelector("ascti-instrument");t||this.appendChild(t=document.createElement("ascti-instrument")),t.render(e);let s=this.querySelector("ascti-velocity");s||this.appendChild(s=document.createElement("ascti-velocity")),s.render(e);let i=this.querySelector("ascti-duration");i||this.appendChild(i=document.createElement("ascti-duration")),i.render(e)}else{let e=this.querySelector("ascti-instrument");e&&e.parentNode.removeChild(e);let t=this.querySelector("ascti-velocity");t&&t.parentNode.removeChild(t);let s=this.querySelector("ascti-duration");s&&s.parentNode.removeChild(s)}return this}}customElements.define("asct-instruction",AudioSourceComposerTrackerInstruction);class AudioSourceComposerTrackerInstructionAdd extends AudioSourceComposerTrackerInstruction{render(e=null){if(e)throw new Error("Invalid");return this.innerHTML="+",this}}customElements.define("asct-instruction-add",AudioSourceComposerTrackerInstructionAdd);class AudioSourceComposerTrackerParameter extends HTMLElement{constructor(){super()}get instruction(){return this.parentNode}get trackerElm(){return this.parentNode.parentNode.trackerElm}get editor(){return this.trackerElm.editor}connectedCallback(){}render(){this.innerHTML=this.editor.values.format(this.row.duration,"duration")}}class AudioSourceComposerParamCommand extends AudioSourceComposerTrackerParameter{render(e=null){e=e||this.instruction.getInstruction(),this.innerHTML=this.editor.values.format(e.command,"command")}}customElements.define("ascti-command",AudioSourceComposerParamCommand);class AudioSourceComposerParamInstrument extends AudioSourceComposerTrackerParameter{render(e=null){e=e||this.instruction.getInstruction(),this.innerHTML=this.editor.values.format(e.instrument,"instrument")}}customElements.define("ascti-instrument",AudioSourceComposerParamInstrument);class AudioSourceComposerParamVelocity extends AudioSourceComposerTrackerParameter{render(e=null){e=e||this.instruction.getInstruction(),this.innerHTML=this.editor.values.format(e.velocity,"velocity")}}customElements.define("ascti-velocity",AudioSourceComposerParamVelocity);class AudioSourceComposerTrackerDuration extends AudioSourceComposerTrackerParameter{render(e=null){e=e||this.instruction.getInstruction(),this.innerHTML=this.editor.values.format(e.duration,"duration")}}customElements.define("ascti-duration",AudioSourceComposerTrackerDuration);class AudioSourceComposerTrackerDelta extends HTMLElement{constructor(){super()}get editorElm(){return this.trackerElm.editorElm}get trackerElm(){return this.parentNode.trackerElm}get row(){return this.parentNode}connectedCallback(){}render(e){e=e||(this.row?this.row.duration:-1),this.innerHTML=this.editorElm.values.format(e,"duration")}}customElements.define("asct-delta",AudioSourceComposerTrackerDelta);class AudioSourceComposerKeyboard{constructor(){}getKeyboardLayout(e=null){switch(e){default:case"2octave":return{"@":"C#4","#":"D#4","%":"F#4","^":"G#4","&":"A#4","*":"C#3",")":"D#3",Q:"C4",W:"D4",E:"E4",R:"F4",T:"G4",Y:"A4",U:"B4",I:"C3",O:"D3",P:"E3",S:"C#3",D:"D#3",G:"F#3",H:"G#3",J:"A#3",L:"C#4",":":"D#4",Z:"C3",X:"D3",C:"E3",V:"F3",B:"G3",N:"A3",M:"B3","<":"C4",">":"D4","?":"E4",2:"C#2",3:"D#2",5:"F#2",6:"G#2",7:"A#2",9:"C#3",0:"D#3",q:"C2",w:"D2",e:"E2",r:"F2",t:"G2",y:"A2",u:"B2",i:"C3",o:"D3",p:"E3",s:"C#1",d:"D#1",g:"F#1",h:"G#1",j:"A#1",l:"C#2",";":"D#2",z:"C1",x:"D1",c:"E1",v:"F1",b:"G1",n:"A1",m:"B1",",":"C2",".":"D2","/":"E2"};case"4octave":return{Q:"C6",W:"C#6",E:"D6",R:"D#6",T:"E6",Y:"F6",U:"F#6",I:"G6",O:"G#6",P:"A6","{":"A#6","}":"B6",A:"C5",S:"C#5",D:"D5",F:"D#5",G:"E5",H:"F5",J:"F#5",K:"G5",L:"G#5",":":"A5",'"':"A#5",Z:"C4",X:"C#4",C:"D4",V:"D#4",B:"E4",N:"F4",M:"F#4","<":"G4",">":"G#4","?":"A4",q:"C3",w:"C#3",e:"D3",r:"D#3",t:"E3",y:"F3",u:"F#3",i:"G3",o:"G#3",p:"A3","[":"A#3","]":"B3",a:"C2",s:"C#2",d:"D2",f:"D#2",g:"E2",h:"F2",j:"F#2",k:"G2",l:"G#2",";":"A2","'":"A#2",z:"C1",x:"C#1",c:"D1",v:"D#1",b:"E1",n:"F1",m:"F#1",",":"G1",".":"G#1","/":"A1"}}}getKeyboardCommand(e,C=3,D=null){if(!Number.isInteger(C))throw new Error("Octave value must be an integer");const r=this.getKeyboardLayout(D);if(void 0===r[e])return null;let t=r[e];for(let e=6;e>=1;e--)t=t.replace(e,C+e-1);return t}}class AudioSourceComposerActions extends AudioSourceComposerRenderer{getDefaultInstrumentURL(){return(new AudioSourceUtilities).getScriptDirectory("instrument/audio-source-synthesizer.js")}setInstrumentName(t,e,n){this.song.setInstrumentName(e,n),this.setStatus(`Instrument name updated: ${n}`)}setSongName(t,e){this.song.setName(e),this.setStatus(`Song name updated: ${e}`)}setSongVersion(t,e){this.song.setVersion(e),this.setStatus(`Song version updated: ${e}`)}setStartingBPM(t,e){this.song.setStartingBPM(e),this.setStatus(`Song beats per minute updated: ${e}`)}setSongVolume(t,e){this.song.setVolume(e),this.fieldSongVolume.value=e}async loadNewSongData(){const t=new AudioSourceStorage,e=this.getDefaultInstrumentURL()+"";let n=t.generateDefaultSong(e);await this.song.loadSongData(n),this.render(),this.setStatus("Loaded new song",n)}async loadRecentSongData(){const t=new AudioSourceStorage;let e=await t.getRecentSongList();return!(!e[0]||!e[0].uuid)&&(this.setStatus("Loading recent song: "+e[0].uuid),await this.loadSongFromMemory(e[0].uuid),!0)}async saveSongToMemory(){const t=this.song,e=t.data,n=t.history,s=new AudioSourceStorage;this.setStatus("Saving song to memory..."),await s.saveSongToMemory(e,n),this.setStatus("Saved song to memory: "+e.uuid)}saveSongToFile(){const t=this.song.data,e=new AudioSourceStorage;this.setStatus("Saving song to file"),e.saveSongToFile(t)}async loadSongFromMemory(t){const e=this.song,n=new AudioSourceStorage,s=await n.loadSongFromMemory(t);0===s.instruments.length&&console.warn("Song contains no instruments");const r=await n.loadSongHistoryFromMemory(t);await e.loadSongData(s),await e.loadSongHistory(r),this.render(!0),this.setStatus("Song loaded from memory: "+t,s)}async loadSongFromFileInput(t,e=null){if(!(e=e||this.fieldSongFileLoad.inputElm)||!e.files||0===e.files.length)throw new Error("Invalid file input");if(e.files.length>1)throw new Error("Invalid file input: only one file allowed");const n=e.files[0],s=n.name.split(".").pop().toLowerCase();switch(s){case"mid":case"midi":await this.loadSongFromMIDIFile(n);break;case"json":await this.loadSongFromJSONFile(n);break;default:throw new Error("Unknown file type: "+s)}}async loadSongFromJSONFile(t){const e=new AudioSourceUtilities,n=await e.loadJSONFile(t);0===n.instruments.length&&console.warn("Song contains no instruments"),await this.song.loadSongData(n),this.render(!0),this.setStatus("Song loaded from file: ",n)}async loadSongFromMIDIFile(t,e=null){e=e||this.getDefaultInstrumentURL();const n=new MIDISupport,s=await n.loadSongFromMidiFile(t,e);await this.song.loadSongData(s),this.render(!0),this.setStatus("Song loaded from midi: ",s)}async loadSongFromSrc(t){const e=new AudioSourceUtilities,n=await e.loadJSONFromURL(t);0===n.instruments.length&&console.warn("Song contains no instruments"),await this.song.loadSongData(n),this.setStatus("Song loaded from src: "+t),console.info(this.song.data),this.render(!0)}async songPlay(){await this.song.play()}async songPause(){this.song.stopPlayback()}async songStop(){this.song.stopPlayback(),this.song.setPlaybackPositionInTicks(0)}setSongPosition(t,e=null){const n=this.song;if(null===e){e=(new AudioSourceValues).parsePlaybackPosition(this.fieldSongPosition.value)}n.setPlaybackPosition(e)}insertInstructionCommand(t,e=null,n=!1,s=null){const r=this.trackerElm,o=this.song;if(null===e&&(e=r.fieldInstructionCommand.value||null),n&&(e=prompt("Set custom command:",e||"")),!e)throw new Error("Invalid Instruction command");let a=r.getInstructionFormValues(e);null!==s&&(a.instrument=s);const i=o.getSongPositionInTicks();console.log(i);let l=o.insertInstructionAtPosition(r.groupName,i,a);r.renderRows(),this.selectIndicies(l),r.playSelectedInstructions()}setInstructionCommand(t,e=null,n=!1,s=null){const r=this.trackerElm,o=this.song;let a=this.getSelectedIndicies();if(0===a.length)throw new Error("No selection");if(null===e&&(e=r.fieldInstructionCommand.value||null),n&&(e=prompt("Set custom command:",e||"")),!e)throw new Error("Invalid Instruction command");for(let t=0;t<a.length;t++)o.replaceInstructionCommand(r.groupName,a[t],e),null!==s&&o.replaceInstructionInstrument(r.groupName,a[t],s),r.findInstructionElement(a[t]).render();r.playSelectedInstructions()}setInstructionInstrument(t,e=null){const n=this.trackerElm,s=this.song;let r=this.getSelectedIndicies();if(e=null!==e?e:parseInt(n.fieldInstructionInstrument.value),!Number.isInteger(e))throw new Error("Invalid Instruction ID");for(let t=0;t<r.length;t++)s.replaceInstructionInstrument(n.groupName,r[t],e),n.findInstructionElement(r[t]).render();n.fieldInstructionInstrument.value=e,n.playSelectedInstructions()}setInstructionDuration(t,e=null,n=!1){const s=this.trackerElm,r=this.song;let o=this.getSelectedIndicies();if(e||(e=parseFloat(s.fieldInstructionDuration.value)),n&&(e=parseInt(prompt("Set custom duration in ticks:",e))),isNaN(e))throw new Error("Invalid duration: "+typeof e);for(let t=0;t<o.length;t++)r.replaceInstructionDuration(s.groupName,o[t],e),s.findInstructionElement(o[t]).render();s.playSelectedInstructions()}setInstructionVelocity(t,e=null,n=!1){const s=this.trackerElm,r=this.song;let o=this.getSelectedIndicies();if(null===e&&(e=s.fieldInstructionVelocity.value),e=parseFloat(e),n&&(e=parseInt(prompt("Set custom velocity (0-127):",s.fieldInstructionVelocity.value))),null===e||isNaN(e))throw new Error("Invalid velocity: "+typeof e);for(let t=0;t<o.length;t++)r.replaceInstructionVelocity(s.groupName,o[t],e),s.findInstructionElement(o[t]).render();s.playSelectedInstructions()}deleteInstructionCommand(t){const e=this.trackerElm,n=this.song;let s=this.getSelectedIndicies();for(let t=0;t<s.length;t++)n.deleteInstructionAtIndex(e.groupName,s[t]);e.renderRows()}songGroupAddNew(t){this.trackerElm;const e=this.song;let n=e.generateInstructionGroupName();(n=prompt("Create new instruction group?",n))?(e.addInstructionGroup(n,[]),this.render()):this.setStatus("<span class='error'>Create instruction group canceled</span>")}songGroupRename(t,e,n=null){const s=this.song;(n=prompt(`Rename instruction group (${e})?`,e))!==e?(s.renameInstructionGroup(e,n),this.render()):this.setStatus("<span class='error'>Rename instruction group canceled</span>")}songGroupRemove(t,e){const n=this.song;confirm(`Remove instruction group (${e})?`)?(n.removeInstructionGroup(e),this.render()):this.setStatus("<span class='error'>Remove instruction group canceled</span>")}songAddInstrument(t,e,n={}){if(!e)return this.handleError("Empty URL");if(n.url=e,n.libraryURL=this.defaultLibraryURL,confirm(`Add Instrument to Song?\nURL: ${e}`)){const t=this.song.addInstrument(n);this.setStatus("New instrument Added to song: "+e),this.fieldInstructionInstrument.value=t}else this.handleError(`New instrument canceled: ${e}`)}async songReplaceInstrument(t,e,n,s={}){return Number.isInteger(e)?n?(s.url=n,s.libraryURL=this.libraryURL,void(confirm(`Change Instrument (${e}) to ${n}`)?(await this.song.replaceInstrument(e,s),await this.song.loadInstrument(e,!0),this.setStatus(`Instrument (${e}) changed to: ${n}`),this.fieldInstructionInstrument.value=e):this.handleError(`Change instrument canceled: ${n}`))):this.handleError("Empty URL"):this.handleError("Invalid Instrument ID: Not an integer")}songRemoveInstrument(t,e=null){null===e&&(e=parseInt(t.target.form.elements.instrumentID.value)),confirm(`Remove Instrument ID: ${e}`)?(this.song.removeInstrument(e),this.setStatus(`Instrument (${e}) removed`)):this.handleError("Remove instrument canceled")}setTrackerChangeGroup(t,e=null){const n=this.trackerElm;e=e||t.target.form.getAttribute("data-group"),n.groupName=e}setTrackerOctave(t,e=null){null!==e&&(this.fieldTrackerOctave.value=e)}setTrackerRowLength(t,e=null){const n=this.trackerElm;null!==e&&n.fieldTrackerRowLength.value,n.renderRows()}setTrackerSegmentLength(t,e=null){const n=this.trackerElm;null!==e&&(n.fieldTrackerSegmentLength.value=e),n.renderRows()}setTrackerFilterInstrument(t){this.trackerElm.renderRows()}setTrackerSelection(t,e=null){const n=this.trackerElm;e||(e=n.fieldTrackerSelection.value.split(/\D+/).map(t=>parseInt(t))),this.selectIndicies(e),n.fieldTrackerSelection.focus()}togglePanelInstruments(t){this.containerElm.classList.toggle("hide-panel-instruments")}togglePanelTracker(t){this.containerElm.classList.toggle("hide-panel-tracker")}togglePanelSong(t){this.containerElm.classList.toggle("hide-panel-song")}toggleFullscreen(t){const e=!this.classList.contains("fullscreen");this.containerElm.classList.toggle("fullscreen",e),this.classList.toggle("fullscreen",e)}batchSelect(e,searchCallbackString=null,promptUser=!1){if(!promptUser&&searchCallbackString||(searchCallbackString=prompt("Run custom search:",searchCallbackString||'/** Example Search **/ i.command === "C3"   &&   i.instrument === 0')),!searchCallbackString)throw new Error("Batch command canceled: Invalid search");const storage=new AudioSourceStorage;storage.addBatchRecentSearches(searchCallbackString);const tracker=this.trackerElm;tracker.clearSelection();const groupName=tracker.groupName,g=groupName;try{const stats={count:0},iterator=this.song.getIterator(groupName);let instruction;const window=null,document=null;for(;instruction=iterator.nextConditionalInstruction(instruction=>{const i=instruction;return eval(searchCallbackString)});)stats.count++,tracker.selectIndex(e,iterator.groupIndex);this.setStatus("Batch Search Completed: "+JSON.stringify(stats),stats)}catch(t){this.setStatus("Batch Search Failed: "+t.message,t)}}batchRunCommand(e,commandCallbackString=null,searchCallbackString=null,promptUser=!1){const storage=new AudioSourceStorage;if(!promptUser&&searchCallbackString||(searchCallbackString=prompt("Run custom search:",searchCallbackString||'/** Example Search **/ i.command === "C3"   &&   i.instrument === 0')),!searchCallbackString)throw new Error("Batch command canceled: Invalid search");if(storage.addBatchRecentSearches(searchCallbackString),!promptUser&&commandCallbackString||(commandCallbackString=prompt("Run custom command:",commandCallbackString||"/** Example Command **/ i.command='C4';")),!commandCallbackString)throw new Error("Batch command canceled: Invalid command");storage.addBatchRecentCommands(commandCallbackString);const instructionList=[],tracker=this.trackerElm,groupName=tracker.groupName,g=groupName;try{const stats={count:0,modified:0},iterator=this.song.getIterator(groupName);let instruction;const window=null,document=null;for(;instruction=iterator.nextConditionalInstruction(instruction=>{const i=instruction;return eval(searchCallbackString)});){const instructionString=JSON.stringify(instruction.data),i=instruction;eval(commandCallbackString),instructionString!==JSON.stringify(instruction.data)&&stats.modified++,stats.count++,tracker.selectIndex(e,iterator.groupIndex)}return this.setStatus("Batch Command Completed: "+JSON.stringify(stats),stats),instructionList}catch(t){return this.setStatus("Batch Command Failed: "+t.message,t),[]}}}class AudioSourceUIDiv extends HTMLElement{constructor(e=null,t=null){super(),null!==e&&this.setAttribute("key",e),this.content=t}get key(){return this.getAttribute("key")}get hasContent(){return!!this.content}get targetElm(){return this}render(){this.targetElm.innerHTML="";const e=this.content;"function"==typeof e?e(this.targetElm):e instanceof HTMLElement?this.targetElm.appendChild(e):this.targetElm.innerHTML+=e}connectedCallback(){null!==this.content&&this.render()}disconnectedCallback(){}addDiv(e=null,t=null){if(null===e)throw new Error("Invalid class name");let n=this.findChild(e);if(n){if(!n instanceof AudioSourceUIDiv)throw new Error("Invalid AudioSourceUIDiv");n.content=t}else n=this.appendChild(new AudioSourceUIDiv(e,t));return n}addMenu(e,t=null,n=null,i=!1){let s=this.findChild(e);return s||(s=new AudioSourceUIMenu(e,t,n,i),this.targetElm.appendChild(s),s)}addActionMenu(e,t=null,n=!1){return this.addMenu(e,t,null,n)}addSubMenu(e,t=null,n=!1){return this.addMenu(e,null,t,n)}addGrid(e,t=null){return this.findChild(e)||this.appendChild(new AudioSourceUIGrid(e,t))}addButtonInput(e,t,n=null,i=null){return this.findChild(e)||this.appendChild(new AudioSourceUIButton(e,t,n,i))}addTextInput(e,t,n=null,i="",s=null){return this.findChild(e)||this.appendChild(new AudioSourceUITextInput(e,t,n,i,s))}addRangeInput(e,t,n=1,i=100,s=null,l=null){return this.findChild(e)||this.appendChild(new AudioSourceUIRangeInput(e,t,n,i,s,l))}addCheckBoxInput(e,t,n=null,i=!1){return this.findChild(e)||this.appendChild(new AudioSourceUIInputCheckBox(e,t,n,i))}addFileInput(e,t,n,i=null,s=null){return this.findChild(e)||this.appendChild(new AudioSourceUIFileInput(e,t,n,i,s))}addSelectInput(e,t,n,i=null,s=null){return this.findChild(e)||this.appendChild(new AudioSourceUISelectInput(e,t,n,i,s))}addBreak(e="break"){return this.addDiv(e,"")}findChild(e=null){if(null===e)throw new Error("Invalid Search key");let t;for(let n=0;n<this.children.length;n++)if((t=this.children[n]).getAttribute("key")===e)return t;return null}createIcon(e,t="icon"){return new AudioSourceUIIcon(t,e)}}customElements.define("asui-div",AudioSourceUIDiv);class AudioSourceUIMenu extends HTMLElement{constructor(e,t=null,n=null,i=!1){super(),null!==e&&this.setAttribute("key",e),this.action=t,this.populate=n,this.mouseTimeout=null,this.setAttribute("key",e),!0===i&&(this.hasBreak=i),this.containerElm=document.createElement("div"),this.containerElm.classList.add("dropdown-container"),this.containerElm.setAttribute("tabindex","0"),this.appendChild(this.containerElm)}get caption(){return this.getAttribute("caption")||this.key}get key(){return this.getAttribute("key")}get disabled(){return"true"===this.getAttribute("disabled")}set disabled(e){e?this.setAttribute("disabled","true"):this.removeAttribute("disabled")}get hasBreak(){return this.getAttribute("hasBreak")}set hasBreak(e){this.setAttribute("hasBreak",e),this.render()}addActionMenu(e,t=null,n=!1){return this.addMenu(e,t,null,n)}addSubMenu(e,t=null,n=!1){return this.addMenu(e,null,t,n)}addMenu(e,t=null,n=null,i=!1){let s=this.findMenuItem(e);return s||(s=new AudioSourceUIMenu(e,t,n,i),this.containerElm.appendChild(s),s)}findMenuItem(e=null){if(null===e)throw new Error("Invalid Search key");for(let t=0;t<this.children.length;t++){let n=this.children[t];if(n.getAttribute("key")===e)return n}return null}connectedCallback(){this.addEventListener("mouseenter",this.onInputEvent),this.addEventListener("mouseleave",this.onInputEvent),this.addEventListener("click",this.onInputEvent),this.addEventListener("change",this.onInputEvent),this.addEventListener("keydown",this.onInputEvent),this.render()}disconnectedCallback(){this.removeEventListener("mouseenter",this.onInputEvent),this.removeEventListener("mouseleave",this.onInputEvent),this.removeEventListener("click",this.onInputEvent),this.removeEventListener("change",this.onInputEvent),this.removeEventListener("keydown",this.onInputEvent)}onInputEvent(e){if(!this.contains(e.target))return;if(this===e.target.closest("asui-menu"))switch(e.type){case"mouseenter":clearTimeout(this.mouseTimeout),this.hasSubMenu&&!this.disabled&&this.renderSubMenu(e);break;case"mouseleave":this.classList.contains("stick")||(clearTimeout(this.mouseTimeout),this.mouseTimeout=setTimeout(e=>{this.clearSubMenu()},200));break;case"click":if(e.defaultPrevented)return;if(this.hasAction)e.preventDefault(),this.doAction(e);else{if(!this.hasSubMenu)return console.warn("Menu has no submenu or action: ",this);e.preventDefault(),this.toggleSubMenu(e)}break;case"keydown":if(e.defaultPrevented)return;e.preventDefault();const t=this.containerElm,n=t.querySelector("asui-menu.selected")||t.firstElementChild;if(!n)throw new Error("No selected menu item found");switch(e.key){case"Escape":case"Backspace":this.closeMenu(e);break;case"Enter":if(n.hasAction)n.doAction(e);else{if(!n.hasSubMenu)return console.warn("Menu has no submenu or action: ",n);n.toggleSubMenu(e)}break;case"ArrowRight":if(!n.hasSubMenu)return console.warn("Menu has no submenu: ",n);n.toggleSubMenu(e);break;case"ArrowLeft":this.closeMenu(e);break;case"ArrowDown":this.selectNextSubMenuItem();break;case"ArrowUp":this.selectPreviousSubMenuItem()}}}get hasAction(){return!!this.action}doAction(e){if(!this.hasAction)throw new Error("No .action callback set");e.menuElement=this,this.action(this),this.closeAllMenus()}get hasSubMenu(){return!!this.populate}toggleSubMenu(e){if(this.classList.contains("stick"))this.clearSubMenu(e);else{this.renderSubMenu(e),this.classList.add("stick");let t=this;for(;t=t.parentNode.closest("asui-menu");)t.classList.add("stick")}}clearSubMenu(e){this.classList.remove("stick","open","open-context-menu"),this.containerElm.innerHTML=""}async renderSubMenu(e){if(!this.populate)throw new Error("Menu has no content");this.classList.add("open"),this.containerElm.innerHTML="";const t=this.populate(this);t instanceof Promise&&await t,this.containerElm.focus();const n=this.containerElm.querySelectorAll("asui-menu:not([disabled])");n[0]&&n[0].classList.add("selected")}selectNextSubMenuItem(){const e=this.containerElm.querySelector("asui-menu.selected");this.containerElm.querySelectorAll("asui-menu.selected").forEach(e=>e.classList.remove("selected"));const t=this.containerElm.querySelectorAll("asui-menu:not([disabled])");let n=[].indexOf.call(t,e);(n>-1&&n<t.length-1?t[n+1]:t[0]).classList.add("selected")}selectPreviousSubMenuItem(){const e=this.containerElm.querySelector("asui-menu.selected");this.containerElm.querySelectorAll("asui-menu.selected").forEach(e=>e.classList.remove("selected"));const t=this.containerElm.querySelectorAll("asui-menu:not([disabled])");let n=[].indexOf.call(t,e);(n>0?t[n-1]:t[t.length-1]).classList.add("selected")}openContextMenu(e,t=null){const n=(t=t||e.target).getBoundingClientRect();let i,s;if(e.clientX&&e.clientY)i=e.clientX,s=e.clientY;else{const e=this.editor.getBoundingClientRect();i=n.x+n.width-e.x,s=n.y+n.height-e.y}this.clearSubMenu(),this.renderSubMenu(e),console.info("Context menu ",t,this.containerElm,i,s),this.classList.add("open","stick","open-context-menu"),this.style.left=i+"px",this.style.top=s+"px"}closeAllMenus(){let e=this;for(;e.parentElement&&e.parentElement.closest("asui-menu");)e=e.parentElement.closest("asui-menu");e.parentElement.querySelectorAll("asui-menu.open,asui-menu.stick").forEach(e=>e.classList.remove("open","stick"))}closeMenu(e){this.clearSubMenu(e);let t=this.parentElement.closest("asui-menu");this.querySelectorAll("asui-menu.open,asui-menu.stick").forEach(e=>e.classList.remove("open","stick")),t&&t!==this&&t.renderSubMenu(e)}render(){const e=this.caption;if(e){let t=this.querySelector("div.caption");t||((t=document.createElement("div")).classList.add("caption"),this.firstElementChild?this.insertBefore(t,this.firstElementChild):this.appendChild(t)),t.innerHTML="","string"==typeof e?t.innerHTML=e:t.appendChild(e)}if(this.hasBreak){let e=this.querySelector("hr");e||(e=document.createElement("hr"),this.firstElementChild?this.insertBefore(e,this.firstElementChild):this.appendChild(e))}}}customElements.define("asui-menu",AudioSourceUIMenu);class AudioSourceUIGrid extends HTMLElement{constructor(e=null,t=null){super(),null!==e&&this.setAttribute("key",e),this.content=t}get key(){return this.getAttribute("key")}get targetElm(){return this}render(e){this.targetElm.innerHTML="","function"==typeof e?e(this.targetElm):e instanceof HTMLElement?this.targetElm.appendChild(e):this.targetElm.innerHTML+=e}connectedCallback(){null!==this.content&&this.render(this.content)}disconnectedCallback(){}findChild(e=null){if(null===e)throw new Error("Invalid Search key");let t;for(let n=0;n<this.children.length;n++)if((t=this.children[n]).getAttribute("key")===e)return t;return null}addGridRow(e,t=null){return this.findChild(e)||this.appendChild(new AudioSourceUIGridRow(e,t))}}customElements.define("asui-grid",AudioSourceUIGrid);class AudioSourceUIGridRow extends AudioSourceUIDiv{constructor(e,t){super(e,t)}}customElements.define("asuig-row",AudioSourceUIGridRow);class AudioSourceUIInputAbstract extends AudioSourceUIDiv{constructor(e=null,t,n){super(e,n),this.listeners=[],this.callback=t||function(){console.warn("No callback set")}}get targetElm(){return this.inputElm}get inputElm(){throw new Error("Not implemented")}get disabled(){return this.inputElm.disabled}set disabled(e){this.inputElm.disabled=e}get value(){return this.inputElm.value}set value(e){this.inputElm.value=e}focus(){return this.inputElm.focus()}addEventListener(e,t,n){this.listeners.push([e,t,n])}connectedCallback(){super.connectedCallback();const e=this.inputElm;this.listeners.forEach(t=>e.addEventListener(t[0],t[1],t[2]))}disconnectedCallback(){super.disconnectedCallback();const e=this.inputElm;this.listeners.forEach(t=>e.removeEventListener(t[0],t[1]))}}class AudioSourceUIButton extends AudioSourceUIInputAbstract{constructor(e=null,t=null,n=null,i=null){super(e,t,n);const s=document.createElement("button");s.classList.add("themed"),i&&s.setAttribute("title",i),this.appendChild(s),this.addEventListener("click",e=>this.onClick(e))}get inputElm(){return this.querySelector("button")}onClick(e){this.callback(e,this.value)}}customElements.define("asui-input-button",AudioSourceUIButton);class AudioSourceUISelectInput extends AudioSourceUIInputAbstract{constructor(e=null,t=null,n=null,i=null,s=null){super(e,t,n),this.selectedValue=null;const l=document.createElement("select");l.classList.add("themed"),i&&l.setAttribute("title",i),this.appendChild(l),null!==s?this.setValue(s):this.setDefaultValue(),this.addEventListener("focus",e=>this.renderOptions(e)),this.addEventListener("change",e=>this.onChange(e))}get inputElm(){return this.querySelector("select")}get value(){return this.selectedValue?this.selectedValue.value:null}set value(e){this.setValue(e)}async setDefaultValue(){let e=!1;await this.eachOption((t,n)=>{e||(e={value:t,title:n})}),this.addOrSetValue(e.value,e.title)}async setValue(e){let t=!1;if(this.selectedValue={value:e,title:"*"},await this.eachOption((n,i)=>{n===e&&(t={value:n,title:i})}),!t){let t=[];throw this.eachOption(function(e){t.push(e)}),console.log(`Value not found: (${typeof e}) ${e}`,t),new Error(`Value not found: (${typeof e}) ${e}`)}this.selectedValue=t,this.addOrSetValue(t.value,t.title)}getOrCreateOption(e,t){const n=this.inputElm;let i=n.querySelector(`option[value="${e}"]`);return i||((i=document.createElement("option")).setAttribute("value",e),i.innerText=t||"Unknown value",n.insertBefore(i,n.firstChild)),i}async eachOption(e,t=null){t=t||function(){};const n=this.content((t,n=null)=>e(t,n=null!==n?n:t),t);n instanceof Promise&&await n}async addOrSetValue(e,t=null){this.selectedValue={value:e,title:t||"Unknown value"},this.getOrCreateOption(e,this.selectedValue.title).selected=!0}async onChange(e){const t=this.inputElm.value;let n=!1;if(await this.eachOption((e,i)=>{e+""===t&&(n={value:e,title:i})}),!n)throw new Error("Value not found: ",t,this);this.selectedValue=n,this.callback(e,this.selectedValue.value)}render(){this.inputElm.innerHTML="";const e=this.content;"function"==typeof e?this.renderOptions():e instanceof HTMLElement?this.inputElm.appendChild(e):this.inputElm.innerHTML+=e}async renderOptions(){const e=this.inputElm;e.innerHTML="";let t=e;await this.eachOption((e,n)=>{let i=document.createElement("option");i.setAttribute("value",e),i.innerText=n,this.selectedValue&&this.selectedValue.value===e&&(i.selected=!0),t.appendChild(i)},n=>{null!==n?((t=document.createElement("optgroup")).setAttribute("label",n),e.appendChild(t)):t=e})}}customElements.define("asui-input-select",AudioSourceUISelectInput);class AudioSourceUIRangeInput extends AudioSourceUIInputAbstract{constructor(e=null,t=null,n=1,i=100,s=null,l=null){super(e,t);const u=document.createElement("input");u.classList.add("themed"),u.setAttribute("type","range"),u.setAttribute("min",n+""),u.setAttribute("max",i+""),null!==l&&u.setAttribute("value",l),null!==s&&u.setAttribute("title",s),this.appendChild(u),this.addEventListener("change",e=>this.onChange(e))}get inputElm(){return this.querySelector("input")}get value(){return parseInt(this.inputElm.value)}set value(e){this.inputElm.value=e}onChange(e){this.callback(e,this.value)}}customElements.define("asui-input-range",AudioSourceUIRangeInput);class AudioSourceUITextInput extends AudioSourceUIInputAbstract{constructor(e=null,t=null,n=null,i=null,s=null){super(e,t);const l=document.createElement("input");l.classList.add("themed"),l.setAttribute("type","text"),n&&l.setAttribute("title",n),i&&l.setAttribute("value",i),s&&l.setAttribute("placeholder",s),this.appendChild(l),this.addEventListener("change",e=>this.onChange(e))}get inputElm(){return this.querySelector("input")}onChange(e){this.callback(e,this.value)}}customElements.define("asui-input-text",AudioSourceUITextInput);class AudioSourceUIInputCheckBox extends AudioSourceUIInputAbstract{constructor(e=null,t=null,n=null,i=!1){super(e,t);const s=document.createElement("input");s.classList.add("themed"),s.setAttribute("type","checkbox"),n&&s.setAttribute("title",n),i&&(s.checked=i),this.appendChild(s),this.addEventListener("change",e=>this.onChange(e))}get inputElm(){return this.querySelector("input")}get checked(){return this.inputElm.checked}onChange(e){this.callback(e,this.checked)}}customElements.define("asui-input-checkbox",AudioSourceUIInputCheckBox);class AudioSourceUIFileInput extends AudioSourceUIInputAbstract{constructor(e=null,t,n,i=null,s=null){super(e,t,n);const l=document.createElement("label");this.appendChild(l),l.classList.add("button-style");const u=document.createElement("div");l.appendChild(u);const r=document.createElement("input");r.classList.add("themed"),r.setAttribute("type","file"),r.setAttribute("style","display: none;"),i&&r.setAttribute("accepts",i),s&&r.setAttribute("title",s),l.appendChild(r),this.addEventListener("change",e=>this.onChange(e))}get targetElm(){return this.querySelector("label > div")}get inputElm(){return this.querySelector("input")}onChange(e){try{this.callback(e,this.value)}catch(e){console.error(e)}this.value=""}}customElements.define("asui-input-file",AudioSourceUIFileInput);class AudioSourceUIIcon extends HTMLElement{constructor(e=null,t){super(),null!==e&&this.setAttribute("key",e),this.classList.add(t)}get key(){return this.getAttribute("key")}}customElements.define("asui-icon",AudioSourceUIIcon);class AudioSourceUtilities{constructor(){}get sources(){return{MidiParser:[this.getScriptDirectory("assets/3rdparty/MidiParser/main.js"),"https://cdn.jsdelivr.net/gh/colxi/midi-parser-js/src/main.js"],MIDIFile:[this.getScriptDirectory("assets/3rdparty/MIDIFile/MIDIFile.min.js")],LZString:[this.getScriptDirectory("assets/3rdparty/LZString/lz-string.min.js"),"https://cdn.jsdelivr.net/gh/pieroxy/lz-string/libs/lz-string.min.js"]}}async loadJSLibrary(i,r=null){if(r||(r=(()=>void 0!==window[i])),r())return!0;const e=this.sources[i];for(let i=0;i<e.length;i++)if(await this.loadScript(e[i]),r())return!0;throw new Error(`Failed to load ${i} Library`)}async getMidiParser(){return void 0===window.MidiParser&&await this.loadJSLibrary("MidiParser"),window.MidiParser}async getMIDIFile(){return void 0===window.MIDIFile&&await this.loadJSLibrary("MIDIFile"),window.MIDIFile}async getLZString(){return void 0===window.LZString&&await this.loadJSLibrary("LZString"),window.LZString}async loadPackageInfo(i=!1){const r=this.getScriptDirectory("package.json");let e=AudioSourceUtilities.packageInfo;if(!i&&e)return e;if(!(e=await this.loadJSONFromURL(r)).version)throw new Error("Invalid package version: "+r);return console.log("Package Version: ",e.version,e),AudioSourceUtilities.packageInfo=e,e}getScriptElement(i=null){return document.head.querySelector(i||'script[src$="audio-source-utilities.js"],script[src$="audio-source-composer.min.js"],script[src$="audio-source-player.min.js"]')}getScriptDirectory(i="",r=null){const e=this.getScriptElement(r);if(!e)throw new Error("Script Element not found");return e.src.split("/").slice(0,-2).join("/")+"/"+i}async loadScript(i){await new Promise((r,e)=>{const t=document.createElement("script");t.src=i,t.onload=(i=>r()),document.head.appendChild(t)})}async loadJSONFromURL(i){return i=new URL(i,document.location)+"",new Promise((r,e)=>{const t=new XMLHttpRequest;t.open("GET",i,!0),t.responseType="json",t.onload=(()=>{if(200!==t.status)return e("JSON file not found: "+i);r(t.response)}),t.send()})}async loadJSONFile(i){const r=await new Promise((r,e)=>{let t=new FileReader;t.readAsText(i),t.onload=(i=>{r(i.target.result)})});return JSON.parse(r)}}AudioSourceUtilities.instrumentLibrary=null,AudioSourceUtilities.packageInfo=null,"undefined"!=typeof module&&(module.exports={AudioSourceUtilities:AudioSourceUtilities});class AudioSourceValues{constructor(e=null){this.song=e}get noteFrequencies(){return["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"]}get valueTypes(){return["beats-per-measure","beats-per-minute","command-group-execute","note-frequency-named","durations","groups","named-durations","note-frequency","note-frequency-all","note-frequency-octaves","song-groups","song-instruments","song-recent-list","velocities"]}getValues(e,t){let s,n=[],r=null;const o=e=>{null!=e&&n.push(e)},a=this.song?this.song.data:null,u=this.song?this.song.timeDivision:384;switch(e){case"song-recent-list":break;case"song-instruments":if(this.song&&a.instruments){const e=a.instruments;for(let s=0;s<e.length;s++){const n=e[s]||{name:"No Instrument Loaded"};r=t(s,this.format(s,"instrument")+": "+(n.name?n.name:n.url.split("/").pop())),o(r)}}break;case"note-frequency-named":if(a)for(let e=0;e<a.instruments.length;e++)if(this.song.isInstrumentLoaded(e)){const s=this.song.getInstrument(e);if(s.getFrequencyAliases){const n=s.getFrequencyAliases();for(const s in n)if(n.hasOwnProperty(s)){const a=n[s];r=t(s,a,e),o(r)}}}break;case"note-frequency":s=this.noteFrequencies;for(let e=0;e<s.length;e++){const n=s[e];r=t(n,n),o(r)}break;case"note-frequency-all":s=this.noteFrequencies;for(let e=1;e<=8;e++)for(let n=0;n<s.length;n++){const a=s[n]+e;r=t(a,a),o(r)}break;case"note-frequency-octaves":for(let e=1;e<=7;e+=1)r=t(e,""+e),o(r);break;case"velocities":for(let e=100;e>=0;e-=10)r=t(e,e),o(r);break;case"durations":for(let e=64;e>1;e/=2){let s=`1/${e}`;r=t(1/e/1.5*u,`${s}t`),o(r),r=t(1/e*u,`${s}`),o(r),r=t(1/e*1.5*u,`${s}d`),o(r)}for(let e=1;e<=16;e++)r=t(e*u,e+"B"),o(r);break;case"named-durations":for(let e=64;e>1;e/=2){let s=`1/${e}`;r=t(`${s}t`,`${s}t`),o(r),r=t(`${s}`,`${s}`),o(r),r=t(`${s}d`,`${s}d`),o(r)}for(let e=1;e<=16;e++)r=t(e+"B",e+"B"),o(r);break;case"beats-per-measure":for(let e=1;e<=12;e++)r=t(e,e+` beat${e>1?"s":""} per measure`),o(r);break;case"beats-per-minute":for(let e=40;e<=300;e+=10)r=t(e,e+` beat${e>1?"s":""} per minute`),o(r);break;case"segment-lengths":[4,5,6,7,8,10,12,16,24,32,48,64,96,128].forEach(e=>{r=t(u*e,e+"B"),o(r)});break;case"song-groups":case"groups":a&&a.instructions&&Object.keys(a.instructions).forEach(function(e,s){r=t(e,e),o(r)});break;case"command-group-execute":a&&a.instructions&&Object.keys(a.instructions).forEach(function(e,s){r=t("@"+e,"@"+e),o(r)});break;default:throw new Error("Invalid Value type: "+e)}return n}format(e,t){switch(t){case"duration":let s;return this.getValues("durations",(t,n)=>{e!==t&&e!==n||(s=n)}),s?s:(e=parseFloat(e).toFixed(2)).replace(".00","t");case"instrument":return"number"!=typeof e?"N/A":e<10?"0"+e:""+e;case"velocity":return"number"!=typeof e?"N/A":100===e?"Max":e+"";case"command":return e;default:throw new Error("Unknown format: "+t)}}formatPlaybackPosition(e){let t=Math.floor(e/60);e%=60;let s=Math.round(1e3*(e-Math.floor(e)));return e=Math.floor(e),`${t=(t+"").padStart(2,"0")}:${e=(e+"").padStart(2,"0")}:${s=(s+"").padStart(3,"0")}`}parsePlaybackPosition(e){const t=e.split(":");return 60*parseInt(t[0])+parseInt(t[1])+parseInt(t[2])/1e3}}"undefined"!=typeof module&&(module.exports={AudioSourceValues:AudioSourceValues}),"undefined"!=typeof global&&void 0===global.AudioSourceUtilities&&(global.AudioSourceUtilities=require("./audio-source-utilities.js").AudioSourceUtilities);"undefined"==typeof HTMLElement&&(global.HTMLElement=class{});class AudioSourceLibrary extends HTMLElement{constructor(e){super(),this.url=null,this.urlPrefix="",this.name="Loading...",this.samples={},this.libraries={},this.presets={},this.instruments={},Object.assign(this,e)}eachLibrary(e){this.processItemList(this.libraries,r=>{r.url=new URL(this.urlPrefix+(r.url||r.name),this.url)+"",e(r)})}eachSample(e){this.processItemList(this.samples,r=>{r.url=new URL(this.urlPrefix+(r.url||r.name),this.url)+"",e(r)})}eachPreset(e){this.processItemList(this.presets,r=>(r.url=this.url+"#"+r.name,e(r)))}eachInstrument(e){this.processItemList(this.instruments,r=>{r.url=new URL(this.urlPrefix+(r.url||r.name),this.url)+"",e(r)})}getPresetConfig(e){let r=null;if(this.processItemList(this.presets,s=>{if(s.name===e)return r=s,!1}),!r)throw new Error("Preset not found: "+e);r.samples||(r.samples={}),0===Object.keys(r.samples).length&&(r.samples[e]={});const s={};return s.preset=e,s.samples=[],this.processItemList(r.samples,e=>{void 0!==this.samples[e.name]&&Object.assign(e,this.samples[e.name]),e.url=new URL(this.urlPrefix+(e.url||e.name),this.url)+"",s.samples.push(e)}),s.libraryURL=this.url,s.preset=e,s}processItemList(e,r,s="url"){const i=(e,i=null)=>{if("string"==typeof e){const r={};r[s]=e,e=r}void 0===(e=Object.assign({},e)).name&&i&&(e.name=i),r(e)};if(Array.isArray(e))for(let r=0;r<e.length&&!1!==i(e[r]);r++);else{if("object"!=typeof e)throw new Error("Unknown array or object");for(let r in e)if(e.hasOwnProperty(r)&&!1===i(e[r],r))break}}}AudioSourceLibrary.eachHistoricLibrary=(async e=>{for(let r in AudioSourceLibrary.cache)if(AudioSourceLibrary.cache.hasOwnProperty(r)){let s=AudioSourceLibrary.cache[r];s instanceof Promise&&(s=await s);let i=s.name||s.url.split("/").pop();if(!1===e(s.url,i))return}}),AudioSourceLibrary.loadURL=async function(e){if(!e)throw new Error("Invalid url");let r;return e=new URL((e+"").split("#")[0],document.location)+"",AudioSourceLibrary.cache[e]?(r=AudioSourceLibrary.cache[e])instanceof Promise&&(r=await r):(AudioSourceLibrary.cache[e]=new Promise((r,s)=>{const i=new XMLHttpRequest;i.open("GET",e+"",!0),i.responseType="json",i.onload=(()=>{if(200!==i.status)return s("Sample library not found: "+e);const t=i.response;t.url=e+"",Object.keys(AudioSourceLibrary.cache).forEach(e=>{Object.values(AudioSourceLibrary.cache)>5&&delete AudioSourceLibrary.cache[e]}),AudioSourceLibrary.cache[e]=t,console.info("Sample Library Loaded: ",e,AudioSourceLibrary.cache),r(t)}),i.send()}),r=await AudioSourceLibrary.cache[e]),new AudioSourceLibrary(r)},AudioSourceLibrary.cache={},"undefined"!=typeof customElements&&customElements.define("audio-source-library",AudioSourceLibrary),"undefined"!=typeof module&&(module.exports={AudioSourceLibrary:AudioSourceLibrary});class AudioSourceSong{constructor(t={},n=null){this.dispatchElement=n,this.audioContext=null,this.instruments={loaded:[],class:{},classPromises:{},promises:{}},this.seekLength=.5,this.playbackPosition=0,this.volumeGain=null,this.activeGroups={},this.data=null,this.loadSongData(t),this.history=[],"undefined"!=typeof document&&document.addEventListener("instrument:loaded",t=>this.onSongEvent(t))}dispatchEvent(t){this.dispatchElement&&this.dispatchElement.dispatchEvent(t)}getAudioContext(){if(this.audioContext)return"suspended"===this.audioContext.state&&this.audioContext.resume(),this.audioContext;this.audioContext=new(window.AudioContext||window.webkitAudioContext);this.audioContext.createGain();return this.audioContext}get uuid(){return this.data.uuid}get timeDivision(){return this.data.timeDivision}get startingBeatsPerMinute(){return this.data.beatsPerMinute}get rootGroup(){return this.data.root}getVolumeGain(){if(!this.volumeGain){const t=this.getAudioContext();let n=t.createGain();n.gain.value=AudioSourceSong.DEFAULT_VOLUME,n.connect(t.destination),this.volumeGain=n}return this.volumeGain}getVolumeValue(){return this.volumeGain?100*this.volumeGain.gain.value:100*AudioSourceSong.DEFAULT_VOLUME}setVolume(t){const n=this.getVolumeGain();n.gain.value!==t&&(n.gain.value=t/100,this.dispatchEvent(new CustomEvent("song:volume",{detail:{volume:t}})))}async loadSongData(t,n=null){t=Object.assign({},{name:this.generateName(),uuid:this.generateUUID(),version:"0.0.1",root:"root",created:(new Date).getTime(),timeDivision:384,beatsPerMinute:120,beatsPerMeasure:4,instruments:[],instructions:{root:[]}},t),this.data=t,Object.keys(t.instructions).map((t,n)=>this.processAllInstructionData(t)),await this.loadAllInstruments(),this.dispatchEvent(new CustomEvent("song:loaded",{detail:this}))}loadSongHistory(t){this.history=t}processAllInstructionData(t){const n=this.data.instructions[t];for(let t=0;t<n.length;t++){const i=n[t];n[t]=this.processInstructionData(i)}}processInstructionData(t){return SongInstruction.parse(t).data}getInstructions(t,n=null){let i=this.data.instructions[t];if(!i)throw new Error("Instruction group not found: "+t);return n&&("number"==typeof n&&(n=[n]),i=i.filter((t,i)=>-1!==n.indexOf(i))),i.map(t=>new SongInstruction(t))}getInstructionIndex(t,n){n instanceof SongInstruction&&(n=n.data);const i=this.data.instructions[t].indexOf(n);if(-1===i)throw new Error("Instruction not found in instruction list");return i}getInstruction(t,n,i=!0){let e=this.data.instructions[t];if(!Number.isInteger(n)){if(i)throw new Error("Invalid Index: "+typeof n);return null}if(n>=e.length){if(i)throw new Error(`Instruction index is greater than group length: ${n} >= ${e.length} for groupName: ${t}`);return null}if(!e[n]){if(i)throw new Error(`Instruction not found at index: ${n} for groupName: ${t}`);return null}return new SongInstruction(e[n],n)}getInstructionGroupLength(t){return this.data.instructions[t].length}getIterator(t,n=null){return new AudioSourceInstructionIterator(this,t,n?n.currentBPM:this.getStartingBPM(),n?n.groupPositionInTicks:0)}eachGroupInstruction(t,n,i=null){if(!this.data.instructions[t])throw new Error("Invalid group: "+t);const e=this.getIterator(t,i);let r=e.nextInstruction();for(;r;){if(!1===n(r,e))break;r=e.nextInstruction()}return e.groupPlaybackTime}eachSongInstruction(t){return Object.keys(this.data.instructions).forEach(n=>{const i=this.getIterator(n);let e;for(;e=i.nextInstruction();){if(!1===t(e,i))break}}),[]}getSongLength(){return this.getGroupLength(this.rootGroup)}getGroupLength(t){const n=this.getIterator(t);let i;for(;i=n.nextInstruction(););return n.groupPlaybackTime}getSongPositionFromTicks(t){return this.getGroupPositionFromTicks(this.rootGroup,t)}getGroupPositionFromTicks(t,n){let i=null;if(this.eachGroupInstruction(t,(t,e)=>{if(i=e,e.groupPositionInTicks>=n)return!1}),!i)return 0;let e=i.groupPlaybackTime;if(n>i.groupPositionInTicks){const t=n-i.groupPositionInTicks;e+=this.ticksToSeconds(t,i.currentBPM)}else if(n<i.groupPositionInTicks){const t=i.groupPositionInTicks-n;e-=this.ticksToSeconds(t,i.currentBPM)}return e}getSongPositionInTicks(t=null){return null===t&&(t=this.songPlaybackPosition),this.getGroupPositionInTicks(this.rootGroup,t)}getGroupPositionInTicks(t,n){let i=null;if(this.eachGroupInstruction(t,(t,e)=>{if(i=e,e.groupPlaybackTime>=n)return!1}),!i)return 0;let e=i.groupPositionInTicks;if(n>i.groupPlaybackTime){const t=n-i.groupPlaybackTime;e+=this.secondsToTicks(t,i.currentBPM)}else if(n<i.groupPlaybackTime){const t=i.groupPlaybackTime-n;e-=this.secondsToTicks(t,i.currentBPM)}return e}ticksToSeconds(t,n){return t/this.timeDivision*(60/n)}secondsToTicks(t,n){return Math.round(t*this.timeDivision/(60/n))}async play(){this.playback&&(this.stopPlayback(),this.setPlaybackPosition(0)),await this.initAllInstruments(this.getAudioContext());const t=new AudioSourceInstructionPlayback(this,this.rootGroup,this.getAudioContext().currentTime-this.playbackPosition);this.playback=t,console.log("Start playback:",this.playbackPosition),this.dispatchEvent(new CustomEvent("song:play",{detail:{playback:this.playback}})),await this.playback.playGroup(),this.dispatchEvent(new CustomEvent("song:end",{detail:{playback:this.playback}})),t.isPlaybackActive&&t.stopPlayback()}stopPlayback(){if(!this.playback)throw new Error("Playback is already stopped");this.playbackPosition=this.getAudioContext().currentTime-this.playback.startTime,this.playback.stopPlayback(),this.playback=null,console.log("End playback:",this.playbackPosition)}get isPlaying(){return!!this.playback}get songPlaybackPosition(){return this.playback?this.getAudioContext().currentTime-this.playback.startTime:this.playbackPosition}setPlaybackPositionInTicks(t){if(!Number.isInteger(t))throw new Error("Invalid start position in ticks");const n=this.getSongPositionFromTicks(t);return this.setPlaybackPosition(n)}setPlaybackPosition(t){if(t=parseFloat(t),Number.isNaN(t))throw new Error("Invalid start position");this.playbackPosition=t;const n=this.getSongPositionInTicks(this.playbackPosition),i={position:this.playbackPosition,positionInTicks:n};this.dispatchEvent(new CustomEvent("song:seek",{detail:i}))}isPlaybackActive(){for(const t in this.activeGroups)if(this.activeGroups.hasOwnProperty(t)&&!0===this.activeGroups[t])return!0;return!1}async playInstructionAtIndex(t,n,i=null){this.getAudioContext();const e=this.getInstruction(t,n,!1);e?await this.playInstruction(e,i):console.warn("No instruction at index")}async playInstruction(t,n=null,i=null){if(!t instanceof SongInstruction)throw new Error("Invalid instruction");if(t.isGroupCommand()){const i=new AudioSourceInstructionPlayback(this,t.getGroupFromCommand(),n);return await i.playGroup()}let e=this.getStartingBPM(),r=this.timeDivision;const s=t.getDurationAsTicks(r)/r/(e/60);let o=this.getAudioContext().currentTime;n||0===n||(n=o),this.playInstrument(t.instrument,t.command,n,s,t.velocity),n>o&&(setTimeout(()=>{this.dispatchEvent(new CustomEvent("note:start",{detail:{groupName:i,instruction:t}}))},1e3*(n-this.getAudioContext().currentTime)),s&&setTimeout(()=>{this.dispatchEvent(new CustomEvent("note:end",{detail:{groupName:i,instruction:t}}))},1e3*(n+s-this.getAudioContext().currentTime)))}onSongEvent(t){switch(t.type){case"instrument:loaded":const n=t.detail.class,i=t.detail.url;this.instruments.class[i]=n,this.loadAllInstruments()}}isInstrumentLoaded(t){return!!this.instruments.loaded[t]}async playInstrument(t,n,i,e,r){if(t||0===t||(console.warn("No instrument set for instruction. Using instrument 0"),t=0),!this.data.instruments[t])return void console.error(`Instrument ${t} is not loaded. Playback skipped. `);let s=this.getInstrument(t);const o=this.getVolumeGain();return await s.play(o,n,i,e,r)}getInstrumentConfig(t,n=!0){const i=this.getInstrumentList();if(i[t])return i[t];if(n)throw new Error("Instrument ID not found: "+t);return null}getInstrument(t,n=!0){if(this.instruments.loaded[t])return this.instruments.loaded[t];if(n)throw new Error("Instrument not yet loaded: "+t);return null}getInstrumentList(){return this.data.instruments.slice()}async loadInstrumentClass(t){t=new URL(t)+"";let n=this.instruments.class[t];if(n)return n;const i=document.createElement("script");i.src=t;const e=new Promise((n,e)=>{i.onload=n,i.onerror=(n=>{i.parentNode.removeChild(i),e("Error loading: "+t)})});if(document.head.appendChild(i),await e,!this.instruments.class[t])throw new Error("Failed to load instrument class: "+t);return this.instruments.class[t]}async loadInstrument(t,n=!1){if(t=parseInt(t),!n&&this.instruments.loaded[t])return!0;this.instruments.loaded[t]=null;const i=this.getInstrumentConfig(t);if(!i.url)throw new Error("Invalid instrument URL");let e=new URL(i.url,document.location.origin);const r=new(await this.loadInstrumentClass(e))(i,this,t);return this.instruments.loaded[t]=r,this.dispatchEvent(new CustomEvent("instrument:instance",{detail:{instance:r,instrumentID:t},bubbles:!0})),this.audioContext&&await this.initInstrument(t,this.audioContext),!0}async loadAllInstruments(){const t=this.getInstrumentList();for(let n=0;n<t.length;n++)t[n]&&await this.loadInstrument(n)}async initInstrument(t,n){const i=this.getInstrument(t);await i.init(n)}async initAllInstruments(t){console.time("initAllInstruments");const n=this.getInstrumentList();for(let i=0;i<n.length;i++){const n=this.getInstrument(i,!1);n&&await n.init(t)}console.timeEnd("initAllInstruments")}hasGroup(t){return void 0!==this.data.instructions[t]}getName(){return this.data.name}setName(t){return this.replaceDataPath(["name"],t)}getVersion(){return this.data.version}setVersion(t){return this.replaceDataPath(["version"],t)}getStartingBPM(){return this.data.beatsPerMinute}setStartingBPM(t){if(!Number.isInteger(t))throw new Error("Invalid BPM");return this.replaceDataPath(["beatsPerMinute"],t)}addInstrument(t){if("object"!=typeof t&&(t={url:t}),!t.url)throw new Error("Invalid Instrument URL");const n=this.data.instruments.length;return this.replaceDataPath(["instruments",n],t),this.loadInstrument(n),this.dispatchEvent(new CustomEvent("instrument:modified",{bubbles:!0,detail:{instrumentID:n,config:t,oldConfig:null}}),1),n}async replaceInstrument(t,n){let i=this.data.instruments[t]||{};return"object"!=typeof n&&(n={url:n}),i&&i.name&&!n.name&&(n.name=i.name),i=this.replaceDataPath(["instruments",t],n),this.dispatchEvent(new CustomEvent("instrument:modified",{bubbles:!0,detail:{instrumentID:t,config:n,oldConfig:i}}),1),i}removeInstrument(t){if(!this.data.instruments[t])throw new Error("Invalid instrument ID: "+t);delete this.instruments.loaded[t];const n=this.deleteDataPath(["instruments",t]);return this.dispatchEvent(new CustomEvent("instrument:modified",{bubbles:!0,detail:{instrumentID:t,config:null,oldConfig:n}}),1),n}replaceInstrumentParam(t,n,i){if(t=parseInt(t),!this.data.instruments[t])throw new Error("Invalid instrument ID: "+t);return Array.isArray(n)||(n=[n]),n.unshift(t),n.unshift("instruments"),this.replaceDataPath(n,i)}deleteInstrumentParam(t,n){if(t=parseInt(t),!this.data.instruments[t])throw new Error("Invalid instrument ID: "+t);return Array.isArray(n)||(n=[n]),n.unshift(t),n.unshift("instruments"),this.deleteDataPath(n)}setInstrumentName(t,n){return this.replaceInstrumentParam(t,"name",n)}generateName(){return`Untitled (${(new Date).toJSON().slice(0,10).replace(/-/g,"/")})`}generateUUID(){var t=(new Date).getTime();return"undefined"!=typeof performance&&"function"==typeof performance.now&&(t+=performance.now()),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){var i=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"===n?i:3&i|8).toString(16)})}generateInstructionGroupName(t="group"){const n=this.data;for(let i=0;i<=999;i++){const e=t+i;if(!n.instructions.hasOwnProperty(e))return e}throw new Error("Failed to generate group name")}findDataPath(t){if(!Array.isArray(t))throw new Error("Path list must be an array");if("*"===t[0])return{value:this.data,parent:{key:this.data},key:"key"};let n,i=this.data,e=null;for(let r=0;r<t.length;r++){if(e=t[r],/^\d+$/.test(e)&&(e=parseInt(e)),n=i,void 0===i)throw new Error("Invalid path key: "+e);i=i[e]}if(!n)throw new Error("Invalid path: "+t.join("."));return{value:i,parent:n,key:e}}insertDataPath(t,n){const i=this.findDataPath(t);if(n=AudioSourceSong.sanitizeInput(n),"number"!=typeof i.key)throw new Error("Insert action requires numeric key");if(i.parent.length<i.key)throw new Error(`Insert position out of index: ${i.parent.length} < ${i.key} for path: ${t}`);return i.parent.splice(i.key,0,n),this.queueHistoryAction(t,n),null}deleteDataPath(t){const n=this.findDataPath(t),i=n.parent[n.key];if("number"==typeof n.key){if(n.parent.length<n.key)throw new Error(`Delete position out of index: ${n.parent.length} < ${n.key} for path: ${t}`);n.parent.splice(n.key,1)}else delete n.parent[n.key];return this.queueHistoryAction(t,null,i),i}replaceDataPath(t,n){const i=this.findDataPath(t);if(void 0===n)return this.deleteDataPath(t);let e=null;return n=AudioSourceSong.sanitizeInput(n),void 0!==i.parent[i.key]&&(e=i.parent[i.key]),i.parent[i.key]=n,this.queueHistoryAction(t,n,e),e}queueHistoryAction(t,n=null,i=null){const e=[t];return null===n&&null===i||e.push(n),null!==i&&e.push(i),this.history.push(e),this.dispatchEvent(new CustomEvent("song:modified",{detail:e}),1),e}insertInstructionAtPosition(t,n,i){if("string"==typeof n&&(n=SongInstruction.parseDurationAsTicks(n,this.timeDivision)),!Number.isInteger(n))throw new Error("Invalid integer: "+typeof n);if(!i)throw new Error("Invalid insert instruction");const e=SongInstruction.parse(i);let r=this.data.instructions[t];const s=this.getIterator(t);let o=s.nextInstruction();for(;;){if(s.groupPositionInTicks>n){const i=[n-(s.groupPositionInTicks-o.deltaDuration),s.groupPositionInTicks-n],r=s.groupIndex;return this.replaceInstructionDeltaDuration(t,r,i[1]),e.deltaDuration=i[0],this.insertInstructionAtIndex(t,r,e),r}if(s.groupPositionInTicks===n){let n;for(n=s.groupIndex+1;n<r.length&&!(new SongInstruction(r[n]).deltaDuration>0);n++);return e.deltaDuration=0,this.insertInstructionAtIndex(t,n,e),n}if(!o)break;o=s.nextInstruction()}if(s.groupPositionInTicks>=n)throw new Error("Something went wrong");let a=r.length;return e.deltaDuration=n-s.groupPositionInTicks,this.insertInstructionAtIndex(t,a,e),a}insertInstructionAtIndex(t,n,i){if(!i)throw new Error("Invalid insert instruction");i=SongInstruction.parse(i).data,this.insertDataPath(["instructions",t,n],i)}deleteInstructionAtIndex(t,n){const i=this.getInstruction(t,n);if(i.deltaDuration>0){const e=this.getInstruction(t,n+1,!1);e&&this.replaceInstructionDeltaDuration(t,n+1,e.deltaDuration+i.deltaDuration)}return this.deleteDataPath(["instructions",t,n])}replaceInstructionDeltaDuration(t,n,i){return this.replaceInstructionParam(t,n,0,i)}replaceInstructionCommand(t,n,i){return this.replaceInstructionParam(t,n,1,i)}replaceInstructionInstrument(t,n,i){return this.replaceInstructionParam(t,n,2,i)}replaceInstructionDuration(t,n,i){return this.replaceInstructionParam(t,n,3,i)}replaceInstructionVelocity(t,n,i){if(!Number.isInteger(i))throw new Error("Velocity must be an integer: "+i);if(i<0)throw new Error("Velocity must be a positive integer: "+i);return this.replaceInstructionParam(t,n,4,i)}replaceInstructionParam(t,n,i,e){return null===e?this.deleteDataPath(["instructions",t,n,i]):this.replaceDataPath(["instructions",t,n,i],e)}addInstructionGroup(t,n){if(this.data.instructions.hasOwnProperty(t))throw new Error("New group already exists: "+t);this.replaceDataPath(["instructions",t],n||[])}removeInstructionGroup(t){if("root"===t)throw new Error("Cannot remove root instruction group, n00b");if(!this.data.instructions.hasOwnProperty(t))throw new Error("Existing group not found: "+t);return this.replaceDataPath(["instructions",t])}renameInstructionGroup(t,n){if("root"===t)throw new Error("Cannot rename root instruction group, n00b");if(!this.data.instructions.hasOwnProperty(t))throw new Error("Existing group not found: "+t);if(this.data.instructions.hasOwnProperty(n))throw new Error("New group already exists: "+n);const i=this.replaceDataPath(["instructions",t]);this.replaceDataPath(["instructions",n],i)}applyHistoryActions(t){for(let n=0;n<t.length;n++){const i=t[n];switch(i.action){case"reset":Object.assign(this.data,i.data);break;case"insert":this.insertDataPath(i.path,i.data);break;case"delete":this.deleteDataPath(i.path);break;case"replace":this.replaceDataPath(i.path,i.data)}}this.history=[],this.processAllInstructionData()}static sanitizeInput(t){if(Array.isArray(t)){for(let n=0;n<t.length;n++)t[n]=AudioSourceSong.sanitizeInput(t[n]);return t}if("object"==typeof t){for(const n in t)t.hasOwnProperty(n)&&(t[n]=AudioSourceSong.sanitizeInput(t[n]));return t}if("string"!=typeof t)return t;if("undefined"!=typeof require){var n=new(require("bad-words"));if(n.isProfane(t))throw new Error("Swear words are forbidden");t=n.clean(t)}var i={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};return t.replace(/[&<>'"]/g,function(t){return i[t]})}onInput(t){t.defaultPrevented||t.type}}AudioSourceSong.DEFAULT_VOLUME=.7;class AudioSourceInstructionPlayback{constructor(t,n,i=null,e=1){i=i||t.getAudioContext().currentTime,this.song=t,this.groupName=n,this.seekLength=e,this.iterator=null,this.subGroups=[],this.startTime=i,this.quantizationInTicks=t.timeDivision}get groupPositionInTicks(){return this.iterator.groupPositionInTicks}get isPlaybackActive(){return!!this.iterator}async playGroup(){const t=this.song.getIterator(this.groupName);for(this.iterator=t,this.song.dispatchEvent(new CustomEvent("group:play",{detail:{playback:this,iterator:t}}));this.isPlaybackActive;)await this.playNextInstructionRow();this.song.dispatchEvent(new CustomEvent("group:end",{detail:{playback:this,iterator:t}}));let n=this.song.getAudioContext().currentTime-this.startTime;console.info("Group finished: ",this.groupName,n)}stopPlayback(t=!0){const n=this.iterator;if(this.iterator=null,this.song.dispatchEvent(new CustomEvent("group:stop",{detail:{playback:this,iterator:n}})),t){const t=this.song.getInstrumentList();for(let n=0;n<t.length;n++){const t=this.song.getInstrument(n,!1);t&&t.stopPlayback&&t.stopPlayback()}}this.subGroups.forEach(n=>n.stopPlayback(t))}async playNextInstructionRow(){if(!this.isPlaybackActive)throw new Error("Playback is not active");const t=this.iterator.nextInstructionQuantizedRow(this.quantizationInTicks);if(this.iterator.hasReachedEnd)return this.stopPlayback(!1),0;const n=this.song.getAudioContext(),i=this.startTime+this.iterator.groupPlaybackTime,e=i-n.currentTime;if(e>0&&await new Promise((t,n)=>setTimeout(t,1e3*e)),!this.isPlaybackActive)return;for(let n=0;n<t.length;n++){const e=t[n];if(e.isGroupCommand()){let t=e.getGroupFromCommand();if(t===this.iterator.groupName)return void console.error("Recursive group call. Skipping group '"+t+"'");const n=new AudioSourceInstructionPlayback(this.song,t,i);this.subGroups.push(n),n.playGroup()}else this.song.playInstruction(e,i,this.groupName)}const r={groupName:this.groupName,position:this.iterator.groupPlaybackTime,positionInTicks:this.iterator.groupPositionInTicks};this.song.dispatchEvent(new CustomEvent("group:seek",{detail:r}))}}class AudioSourceInstructionIterator{constructor(t,n,i=null,e=0){if(!t.data.instructions[n])throw new Error("Song group not found: "+n);this.song=t,this.groupName=n,this.currentBPM=i||t.getStartingBPM(),this.groupPositionInTicks=e,this.lastInstructionGroupPositionInTicks=e,this.groupPlaybackTime=0,this.lastInstructionGroupPlaybacktime=0,this.groupIndex=-1,this.nextQuantizationBreakInTicks=0}get hasReachedEnd(){return void 0===this.instructionList[this.groupIndex+1]}get instructionList(){return this.song.data.instructions[this.groupName]}getCurrentInstruction(){const t=this.instructionList[this.groupIndex];if(!t)return null;const n=new SongInstruction(t);return n.index=this.groupIndex,n.positionInTicks=this.groupPositionInTicks,n}getCurrentInstructionRow(){const t=[];let n,i=this.groupIndex;for(;(n=this.getInstruction(i))&&(n.positionInTicks=this.groupPositionInTicks,t.push(n),!n.deltaDuration);)i++;return t}getInstruction(t,n=!0){const i=this.instructionList[t];if(!i){if(n)throw new Error("");return null}const e=new SongInstruction(i);return e.index=t,e}getInstructionRow(t){const n=[];let i;for(;(i=this.getInstruction(t))&&(n.push(i),!i.deltaDuration);)t++;return n}currentInstruction(){const t=-1===this.groupIndex?0:this.groupIndex,n=this.getInstruction(t,!1);return n.positionInTicks=this.groupPositionInTicks,n}nextConditionalInstruction(t){let n,i=0;for(;n=this.nextInstruction();){if(i+=n.deltaDuration,!0===t(n))return n.deltaDuration=i,n}return null}nextInstruction(){if(this.hasReachedEnd)return null;this.groupIndex++;const t=this.instructionList[this.groupIndex],n=new SongInstruction(t);if(n.deltaDuration){this.groupPositionInTicks=this.lastInstructionGroupPositionInTicks+n.deltaDuration,this.lastInstructionGroupPositionInTicks=this.groupPositionInTicks;const t=n.deltaDuration/this.song.timeDivision/(this.currentBPM/60);this.groupPlaybackTime=this.lastInstructionGroupPlaybacktime+t,this.lastInstructionGroupPlaybacktime=this.groupPlaybackTime}return this.getInstruction(this.groupIndex)}nextInstructionRow(t=null){let n=this.nextInstruction();if(!n)return null;let i=[];for(n&&i.push(n);;){let t=this.getInstruction(this.groupIndex+1,!1);if(!t)break;if(t.deltaDuration)break;t=this.nextInstruction(),i.push(t)}return null!==t&&(i=i.filter(t)),i}nextInstructionQuantizedRow(t,n=null){if(!t)throw new Error("Invalid Quantization value: "+typeof t);let i=this.getInstruction(this.groupIndex+1,!1);if(!i)return null;let e=this.lastInstructionGroupPositionInTicks+i.deltaDuration;if(-1!==this.groupIndex)for(;this.nextQuantizationBreakInTicks<=this.groupPositionInTicks;)this.nextQuantizationBreakInTicks+=t;if(e>this.nextQuantizationBreakInTicks){const n=this.nextQuantizationBreakInTicks-this.groupPositionInTicks;this.groupPositionInTicks=this.nextQuantizationBreakInTicks;const i=n/this.song.timeDivision/(this.currentBPM/60);return this.groupPlaybackTime+=i,this.nextQuantizationBreakInTicks+=t,[]}return this.nextInstructionRow(n)}*[Symbol.iterator](){let t;for(;t=this.nextInstruction();)yield t}}class AudioSourceConditionalInstructionIterator extends AudioSourceInstructionIterator{constructor(t,n,i=null,e=null,r=0){if(super(t,n,e,r),"function"!=typeof i)throw new Error("Invalid conditional callback");this.conditionalCallback=i}nextInstruction(){let t,n=0;for(;t=super.nextInstruction();){if(n+=t.deltaDuration,!0===this.conditionalCallback(t))return t.deltaDuration=n,t}return null}}class SongInstruction{constructor(t,n=null,i=null){this.data=t||[0,"",0],this.index=n,this.positionInTicks=i}get deltaDuration(){return this.data[0]}set deltaDuration(t){this.data[0]=SongInstruction.parseDurationAsTicks(t)}get command(){return this.data[1]||null}set command(t){this.data[1]=t}get instrument(){return void 0===this.data[2]?null:this.data[2]}set instrument(t){if(t=parseInt(t),Number.isNaN(t))throw new Error("Invalid Instrument ID");this.data[2]=t}get duration(){return void 0===this.data[3]?null:this.data[3]}set duration(t){if(t=parseFloat(t),Number.isNaN(t))throw new Error("Invalid Duration");this.data[3]=t}getDurationAsTicks(t){return SongInstruction.parseDurationAsTicks(this.duration,t)}get velocity(){return void 0===this.data[4]?null:this.data[4]}set velocity(t){if(t=parseInt(t),Number.isNaN(t))throw new Error("Invalid Velocity");this.data[4]=t}get panning(){return void 0===this.data[5]?null:this.data[5]}set panning(t){if(t=parseInt(t),Number.isNaN(t))throw new Error("Invalid Panning");this.data[5]=t}isGroupCommand(){return this.command&&"@"===this.command[0]}getGroupFromCommand(){return this.command.substr(1)}static parse(t){return t instanceof SongInstruction?t:("number"==typeof t?t=[t]:"string"==typeof t&&(t=t.split(":")).length>=2&&(t[1]=parseInt(t[1])),"string"==typeof t[0]&&t.unshift(0),new SongInstruction(t))}static parseDurationAsTicks(t,n){if(null===t||"number"==typeof t)return t;switch(t[t.length-1].toLowerCase()){case"t":return parseInt(t.substr(0,t.length-1));case"b":return n*parseFloat(t.substr(0,t.length-1))}throw new Error("Invalid Duration: "+t)}}if("undefined"!=typeof module&&(module.exports={AudioSourceSong:AudioSourceSong,AudioSourceInstructionIterator:AudioSourceInstructionIterator,AudioSourceInstructionPlayback:AudioSourceInstructionPlayback}),"undefined"!=typeof global&&void 0===global.CustomEvent){class t{constructor(t,n){}}global.CustomEvent=t}class AudioSourceStorage{constructor(){}async getRecentSongList(){return await this.decodeForStorage(localStorage.getItem("song-recent-list")||"[]")}generateName(){return`Untitled (${(new Date).toJSON().slice(0,10).replace(/-/g,"/")})`}generateUUID(){var e=(new Date).getTime();return"undefined"!=typeof performance&&"function"==typeof performance.now&&(e+=performance.now()),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var o=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?o:3&o|8).toString(16)})}generateDefaultSong(e=null){const t={name:this.generateName(),uuid:this.generateUUID(),version:"0.0.1",root:"root",created:(new Date).getTime(),timeDivision:384,beatsPerMinute:120,beatsPerMeasure:4,instruments:[],instructions:{root:[]}};return e&&t.instruments.push({url:e}),t}async encodeForStorage(e,t=null,o=null){let r=JSON.stringify(e,t,o);const n=new AudioSourceUtilities;return(await n.getLZString()).compress(r)}async decodeForStorage(e){if(!e)return null;const t=new AudioSourceUtilities;return e=(await t.getLZString()).decompress(e)||e,JSON.parse(e)}saveState(e){localStorage.setItem("audio-source-state",JSON.stringify(e))}loadState(){let e=localStorage.getItem("audio-source-state");return e&&(e=JSON.parse(e)),e}async saveSongToMemory(e,t){e.uuid||(e.uuid=this.generateUUID());let o=[];try{o=await this.decodeForStorage(localStorage.getItem("song-recent-list")||"[]")}catch(e){console.error(e)}(o=o.filter(t=>t.uuid!==e.uuid)).unshift({uuid:e.uuid,name:e.name}),localStorage.setItem("song-recent-list",await this.encodeForStorage(o)),localStorage.setItem("song:"+e.uuid,await this.encodeForStorage(e)),localStorage.setItem("song-history:"+e.uuid,await this.encodeForStorage(t)),console.info("Song saved to memory: "+e.uuid,e)}saveSongToFile(e,t=!0){const o="/** INSTRUCTIONS-"+this.generateUUID()+" **/";let r=JSON.stringify(e.instructions),n=JSON.stringify(Object.assign({},e,{instructions:o}),null,"\t");n=n.replace('"'+o+'"',r);const a="data:text/json;charset=utf-8,"+encodeURIComponent(n),s=document.createElement("a");s.setAttribute("href",a);let i=(e.name||"untitled").replace(/\s+/g,"_")+".json";if(t&&(i=window.prompt("Download as file?",i)),!i)return console.warn("Download canceled");s.setAttribute("download",i),document.body.appendChild(s),s.click(),s.remove()}async loadSongFromMemory(e){let t=localStorage.getItem("song:"+e);if(!t)throw new Error("Song Data not found for uuid: "+e);let o=await this.decodeForStorage(t);if(!o)throw new Error("Invalid Song Data: "+t);return o}async loadSongHistoryFromMemory(e){let t=localStorage.getItem("song-history:"+e);return t?await this.decodeForStorage(t):null}getBatchRecentCommands(){let e=localStorage.getItem("batch-recent-commands");return e?e=JSON.parse(e):[]}addBatchRecentCommands(e){let t=this.getBatchRecentCommands();-1===t.indexOf(e)&&t.unshift(e),localStorage.setItem("batch-recent-commands",JSON.stringify(t))}getBatchRecentSearches(){let e=localStorage.getItem("batch-recent-searches");return e?e=JSON.parse(e):[]}addBatchRecentSearches(e){let t=this.getBatchRecentSearches();-1===t.indexOf(e)&&t.unshift(e),localStorage.setItem("batch-recent-searches",JSON.stringify(t))}}"undefined"!=typeof module&&(module.exports={AudioSourceStorage:AudioSourceStorage});class MIDISupport{constructor(){}loadMIDIInterface(e){navigator.requestMIDIAccess&&navigator.requestMIDIAccess().then(t=>{console.info("MIDI initialized",t);const o=[];t.inputs.forEach(t=>{o.push(t),t.addEventListener("midimessage",e)}),console.log("MIDI input devices detected: "+o.map(e=>e.name).join(", "))},e=>{throw new Error("error initializing MIDI: "+e)})}getCommandFromMIDINote(e){const t=Math.floor(e/12),o=e%12;return(new AudioSourceValues).noteFrequencies[o]+t}async loadMIDIFile(e){const t=new AudioSourceUtilities,o=new(await t.getMIDIFile())(await new Promise((t,o)=>{let n=new FileReader;n.readAsArrayBuffer(e),n.onload=(e=>{t(e.target.result)})}));return console.info("MIDI Data Loaded: ",o),o}async loadSongFromMidiFile(e,t=null){const o=await this.loadMIDIFile(e);return this.loadSongFromMIDIData(o,t)}loadSongFromMIDIData(e,t=null){const o={root:[]};let n=(new AudioSourceStorage).generateDefaultSong();n.instructions=o,n.timeDivision=e.timeDivision;const a=new AudioSourceSong(n);let i=0;for(let o=0;o<e.track.length;o++){const r="root",s={},c=e.track[o].event;let l=0,I=0,u=!1,d="Track "+o;for(let e=0;e<c.length;e++){const t=c[e];switch(t.type){case 8:case 9:u=!0;break;case 255:switch(t.metaType){case 3:d=t.data.trim()}}}if(!u){console.info("Skipping empty track: ",o,c);continue}const m=i++;t&&(n.instruments[m]={url:t+"",name:d});for(let e=0;e<c.length;e++){const t=c[e];switch(l+=t.deltaTime,t.type){case 8:let e=this.getCommandFromMIDINote(t.data[0]);if(s[e]){const t=s[e][0],o=s[e][1];let n=l-t;delete s[e],a.replaceInstructionDuration(r,o,n)}break;case 9:let o=this.getCommandFromMIDINote(t.data[0]),n=t.data[1];if(0===n&&s[o]){const e=s[o][1];let t=l-I;a.replaceInstructionDuration(r,e,t),delete s[o];break}I=l;const i=new SongInstruction([0,o,m,0,n]),c=a.insertInstructionAtPosition(r,l,i);s[o]=[l,c]}}}return a.data}}})();