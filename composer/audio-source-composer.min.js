(function(){class AudioSourceComposerElement extends HTMLElement{constructor(){super(),this.versionString="-1",this.eventHandlers=[],this.saveSongToMemoryTimer=null,this.longPressTimeout=null,this.keyboard=new AudioSourceComposerKeyboard,this.song=new AudioSourceSong({},this),this.status={groupHistory:[],longPressTimeout:500,doubleClickTimeout:500,autoSaveTimeout:4e3},this.shadowDOM=null,this.actions=new AudioSourceComposerActions(this),this.values=new AudioSourceValues(this.song);const e=new AudioSourceLibraries,t=e.getScriptDirectory("instrument/instrument.library.json");e.loadInstrumentLibrary(t),e.loadPackageInfo().then(e=>this.setVersion(e.version))}get tracker(){return this.shadowDOM.querySelector("asc-tracker")}get containerElm(){return this.shadowDOM.querySelector(".asc-container")}get scriptDirectory(){return(new AudioSourceLibraries).getScriptDirectory("")}get sampleLibraryURL(){return this.getAttribute("sampleLibraryURL")||this.scriptDirectory("sample/sample.library.json")}set sampleLibraryURL(e){this.setAttribute("sampleLibraryURL",e)}connectedCallback(){this.loadCSS(),this.shadowDOM=this.attachShadow({mode:"open"}),this.attachEventHandler(["focus"],e=>this.onInput(e),this.shadowDOM,!0),this.attachEventHandler(["song:loaded","song:play","song:end","song:stop","song:modified","song:seek","group:play","group:seek","note:start","note:end"],this.onSongEvent),this.attachEventHandler(["instrument:instance","instrument:library","instrument:modified","instrument:loaded"],e=>this.onSongEvent(e),document),this.render(),this.focus(),this.loadDefaultSong(),(new MIDISupport).loadMIDIInterface(e=>this.onInput(e))}disconnectedCallback(){this.eventHandlers.forEach(e=>e[2].removeEventListener(e[0],e[1]))}attachEventHandler(e,t,s,n=null){Array.isArray(e)||(e=[e]);for(let o=0;o<e.length;o++){const r=e[o];(s=s||this).addEventListener(r,t,n),this.eventHandlers.push([r,t,s])}}async loadDefaultSong(){const e=this.getAttribute("src");if(e)try{return await this.actions.loadSongFromSrc(e),!0}catch(t){console.error("Failed to load from src: ",e,t)}return!!await this.actions.loadRecentSongData()||(this.actions.loadNewSongData(),!1)}get currentGroup(){return this.status.currentGroup}get selectedIndicies(){return this.status.getSelectedIndicies()}get selectedRange(){return this.status.selectedRange}getAudioContext(){return this.song.getAudioContext()}getSongData(){return this.song.data}getDefaultInstrumentURL(){return new URL(this.scriptDirectory+"instrument/audio-source-synthesizer.js",document.location)}updateSongPositionValue(e){let t=Math.floor(e/60);e%=60;let s=Math.round(1e3*(e-Math.floor(e)));e=Math.floor(e),t=(t+"").padStart(2,"0"),e=(e+"").padStart(2,"0"),s=(s+"").padStart(4,"0"),this.fieldSongPosition.value=`${t}:${e}:${s}`}onInput(e){if(!e.defaultPrevented){switch(e.type){case"focus":break;default:this.song.getAudioContext()}switch(e.type){case"focus":for(let t=0;t<e.path.length;t++){const s=e.path[t];if(s.classList&&s.classList.contains("instrument-container")){s.classList.contains("selected")||(s.parentNode.querySelectorAll(".instrument-container.selected").forEach(e=>e.classList.remove("selected")),s.classList.add("selected"),setTimeout(e=>s.parentNode.scrollLeft=s.offsetLeft-20,1));break}}break;default:this.tracker&&this.tracker.onInput(e)}}}async onSongEvent(e){switch(this.tracker&&this.tracker.onSongEvent(e),e.type){case"song:seek":this.updateSongPositionValue(e.detail.position);break;case"song:loaded":this.tracker.renderDuration=this.song.timeDivision;break;case"song:play":this.classList.add("playing"),this.containerElm.classList.add("playing"),this.fieldSongPlaybackPause.disabled=!1;const t=setInterval(e=>{this.song.isPlaying||(clearInterval(t),this.fieldSongPlaybackPause.disabled=!0,this.containerElm.classList.remove("playing"),this.classList.remove("playing")),this.updateSongPositionValue(this.song.songPlaybackPosition)},10);break;case"song:pause":this.classList.add("paused"),this.containerElm.classList.add("paused");break;case"song:end":this.classList.remove("playing","paused"),this.containerElm.classList.remove("playing","paused");break;case"instrument:instance":this.renderInstrument(e.detail.instrumentID,e.detail.instance);break;case"instrument:modified":case"song:modified":switch(e.type){case"instrument:modified":this.renderInstruments(),this.tracker&&this.tracker.renderForms()}clearTimeout(this.saveSongToMemoryTimer),this.saveSongToMemoryTimer=setTimeout(e=>this.actions.saveSongToMemory(e),this.status.autoSaveTimeout);break;case"instrument:loaded":case"instrument:remove":this.renderInstruments(),this.tracker&&this.tracker.renderForms();break;case"instrument:library":this.renderSongForms(),this.tracker&&this.tracker.renderForms()}}onError(e){console.error(e),this.setStatus(`<span style="red">${e}</span>`),this.webSocket&&this.webSocket.onError(e)}setStatus(e){console.info.apply(null,arguments),this.statusElm.innerHTML=e}setVersion(e){this.versionString=e,this.versionElm.innerHTML=e}closeAllMenus(){this.shadowDOM.querySelector("asui-menu").closeAllMenus()}get statusElm(){return this.shadowDOM.querySelector(".asc-status-container .status-text")}get versionElm(){return this.shadowDOM.querySelector(".asc-status-container .version-text")}get menuFile(){return this.shadowDOM.querySelector('asui-menu[key="file"]')}get menuEdit(){return this.shadowDOM.querySelector('asui-menu[key="edit"]')}get menuView(){return this.shadowDOM.querySelector('asui-menu[key="view"]')}get menuInstrument(){return this.shadowDOM.querySelector('asui-menu[key="instrument"]')}get menuContext(){return this.shadowDOM.querySelector('asui-menu[key="context"]')}get panelSong(){return this.shadowDOM.querySelector("asui-form[key='song']")}get panelTracker(){return this.shadowDOM.querySelector("asui-form[key='tracker']")}get panelTrackerRowSegments(){return this.shadowDOM.querySelector("asui-form[key='tracker-row-segments']")}get panelInstruction(){return this.shadowDOM.querySelector("asui-form[key='instruction']")}get panelInstruments(){return this.shadowDOM.querySelector("asui-form[key='instruments']")}render(){const e=new AudioSourceLibraries,t=e.getScriptDirectory("composer/audio-source-composer.css"),s=e.getScriptDirectory("common/audio-source-common.css");this.shadowDOM.innerHTML=`\n        <link rel="stylesheet" href="${t}" />\n        <link rel="stylesheet" href="${s}" />\n        <div class="asc-container">\n            <div class="asui-menu-container">\n                <asui-menu key="file" caption="File"></asui-menu>\n                <asui-menu key="edit" caption="Edit"></asui-menu>\n                <asui-menu key="view" caption="View"></asui-menu>\n                <asui-menu key="instrument" caption="Instrument"></asui-menu>\n                <asui-menu key="context" caption=""></asui-menu>\n            </div>\n            <asui-form key="song" caption="Song" class="panel"></asui-form>\x3c!--\n            --\x3e<asui-form key="instruments" caption="Song Instruments" class="panel"></asui-form>\n            <br/>\n            <asui-form key="instruction" caption="Selected Instruction(s)" class="panel"></asui-form>\x3c!--\n            --\x3e<asui-form key="tracker" caption="Tracker" class="panel"></asui-form>\x3c!--\n            --\x3e<asui-form key="tracker-row-segments" caption="Tracker Segments" class="panel"></asui-form>\n            <br/>\n\n            <asc-tracker group="root"></asc-tracker>\n        </div>\n        <div class="asc-status-container">\n            <span class="status-text"></span>\n            <a href="https://github.com/clevertree/audio-source-composer" target="_blank" class="version-text">${this.versionString}</a>\n        </div>\n        `,this.containerElm.classList.toggle("fullscreen",this.classList.contains("fullscreen")),this.renderMenu(),this.renderSongForms(),this.renderInstruments()}get formSongPlayback(){return this.panelSong.getOrCreateForm("playback","Playback")}get formSongPosition(){return this.panelSong.getOrCreateForm("position","Position")}get formSongVolume(){return this.panelSong.getOrCreateForm("volume","Volume")}get formSongFile(){return this.panelSong.getOrCreateForm("file","File")}get formSongName(){return this.panelSong.getOrCreateForm("name","Name")}get formSongVersion(){return this.panelSong.getOrCreateForm("version","Version")}get fieldSongPlaybackPlay(){return this.formSongPlayback.getInput("play",!1)||this.formSongPlayback.addIconButton("play",e=>this.actions.songPlay(e),"play","Play Song")}get fieldSongPlaybackPause(){return this.formSongPlayback.getInput("pause",!1)||this.formSongPlayback.addIconButton("pause",e=>this.actions.songPause(e),"pause","Pause Song")}get fieldSongPlaybackStop(){return this.formSongPlayback.getInput("stop",!1)||this.formSongPlayback.addIconButton("pause",e=>this.actions.songStop(e),"stop","Stop Song")}get fieldSongVolume(){return this.formSongVolume.getInput("volume",!1)||this.formSongVolume.addRangeInput("volume",(e,t)=>this.actions.setSongVolume(e,t),1,100)}get fieldSongPosition(){return this.formSongPosition.getInput("position",!1)||this.formSongPosition.addTextInput("position",e=>this.editor.actions.setTrackerSelection(e),"Song Position","00:00:0000")}get fieldSongName(){return this.formSongName.getInput("name",!1)||this.formSongName.addTextInput("name",(e,t)=>this.actions.setSongName(e,t),"Song Name")}get fieldSongVersion(){return this.formSongVersion.getInput("version",!1)||this.formSongVersion.addTextInput("version",(e,t)=>this.actions.setSongVersion(e,t))}get fieldSongFileLoad(){return this.formSongFile.getInput("file-load",!1)||this.formSongFile.addFileInput("file-load",e=>this.actions.songFileLoad(e),'<i class="ui-icon ui-file-load"></i>',".json,.mid,.midi","Save Song to File")}get fieldSongFileSave(){return this.formSongFile.getInput("file-save",!1)||this.formSongFile.addIconButton("file-save",e=>this.actions.songFileSave(e),"file-save","Save Song to File")}renderSongForms(){this.fieldSongPlaybackPlay,this.fieldSongPlaybackPause.disabled=!0,this.fieldSongPlaybackStop,this.fieldSongFileLoad,this.fieldSongFileSave,this.fieldSongVolume,this.fieldSongPosition,this.fieldSongName.value=this.song.getName(),this.fieldSongVersion.value=this.song.getVersion()}renderInstrument(e,t=null){let s=this.panelInstruments.getOrCreateForm(e);const n=(e<10?"0":"")+e;if(s.clearInputs(),s.addButton("instrument-id",null,n+":"),t||(s.addSelectInput("instrument-add-url",(t,s)=>this.actions.songReplaceInstrument(t,e,s),e=>{e("","Add Instrument"),this.values.getValues("instruments-available",e)},"Add Instrument",""),s.addBreak()),t)try{if(t instanceof HTMLElement)t.setAttribute("data-id",e+""),s.appendChild(t);else{if("function"!=typeof t.render)throw new Error("No Renderer");{const e=t.render(s);e&&(s.innerHTML=e)}}}catch(e){s.innerHTML=e}}renderInstruments(){this.panelInstruments;const e=this.song.getInstrumentList();for(let t=0;t<e.length;t++){let e=this.song.getInstrument(t,!1);this.renderInstrument(t,e)}this.renderInstrument(e.length,null)}renderMenu(){this.menuFile.populate=(e=>{const t=e.menuElement;t.getOrCreateSubMenu("new","New song").action=(e=>this.actions.loadNewSongData(e));const s=t.getOrCreateSubMenu("open","Open song ►");s.populate=(e=>{s.getOrCreateSubMenu("from Memory ►").populate=(async e=>{const t=e.menuElement,s=new AudioSourceStorage,n=await s.getRecentSongList();for(let e=0;e<n.length;e++){const s=n[e];t.getOrCreateSubMenu(s.guid,s.title).action=(e=>{this.loadSongFromMemory(s.guid)})}});s.getOrCreateSubMenu("from File",'<form name="form-menu-load-file" action="#" class="form-menu-load-file submit-on-change" data-action="song:load-from-file">\n                                <label>from File<input type="file" name="file" accept=".json" style="display: none"></label>\n                            </form>');s.getOrCreateSubMenu("from URL").disabled=!0});const n=t.getOrCreateSubMenu("save","Save song ►");n.populate=(e=>{n.getOrCreateSubMenu("to Memory").action=(e=>this.actions.saveSongToMemory(e)),n.getOrCreateSubMenu("to File").action=(e=>this.actions.saveSongToFile(e))});const o=t.getOrCreateSubMenu("import","Import song ►");o.populate=(e=>{o.getOrCreateSubMenu("from MIDI File",'<form name="form-menu-load-file" action="#" class="form-menu-load-file submit-on-change" data-action="song:load-from-file">\n                                <label>from MIDI File<input type="file" name="file" accept=".mid,.midi" style="display: none"></label>\n                            </form>')});const r=t.getOrCreateSubMenu("export","Export song ►");r.disabled=!0,r.populate=(e=>{r.getOrCreateSubMenu("to MIDI File").disabled=!0})}),this.menuView.populate=(e=>{const t=e.menuElement;t.getOrCreateSubMenu("fullscreen",`${this.classList.contains("fullscreen")?"Disable":"Enable"} Fullscreen`).action=(e=>this.actions.toggleFullscreen(e)),t.getOrCreateSubMenu("forms-song",`${this.containerElm.classList.contains("hide-forms-song")?"Show":"Hide"} Song Forms `).action=(e=>this.actions.togglePanelSong(e)),t.getOrCreateSubMenu("forms-tracker",`${this.containerElm.classList.contains("hide-forms-tracker")?"Show":"Hide"} Track Forms`).action=(e=>this.actions.togglePanelTracker(e)),t.getOrCreateSubMenu("forms-instruments",`${this.containerElm.classList.contains("hide-forms-instruments")?"Show":"Hide"} Instrument Forms`).action=(e=>this.actions.togglePanelInstrument(e))}),this.menuInstrument.populate=(e=>{const t=e.menuElement;t.getOrCreateSubMenu("instrument","Add To Song ►").populate=(e=>{const t=e.menuElement;this.values.getValues("instruments-available",(e,s)=>{t.getOrCreateSubMenu(e,`${s}`).action=(t=>{this.actions.songAddInstrument(t,e)})})});let s=0;this.values.getValues("song-instruments",(e,n)=>{const o=this.song.isInstrumentLoaded(e),r=t.getOrCreateSubMenu(e,`${n} ►`);r.populate=(t=>{const s=t.menuElement;s.getOrCreateSubMenu("change","Replace ►").populate=(t=>{const s=t.menuElement;this.values.getValues("instruments-available",(t,n)=>{s.getOrCreateSubMenu(t,`${n}`).action=(s=>{this.fieldSongAddInstrument.value=t,this.actions.songReplaceInstrument(s,e,t)})})});const n=s.getOrCreateSubMenu("remove","Remove From Song");n.action=(t=>{this.actions.songRemoveInstrument(t,e)}),n.disabled=!o}),0===s&&(r.hasBreak=!0),s++})})}update(){this.menu.update(),this.tracker.update()}selectGroup(e){this.status.groupHistory=this.status.groupHistory.filter(e=>e===this.status.currentGroup),this.status.groupHistory.unshift(this.status.currentGroup),this.status.currentGroup=e,console.log("Group Change: ",e,this.status.groupHistory),this.tracker.groupName=e,this.render()}selectInstructions(e=null){if(this.status.getSelectedIndicies()=[],"number"==typeof e)this.status.getSelectedIndicies()=[e];else{if(!Array.isArray(e)){if("function"==typeof e){let t=[];return this.song.eachInstruction(this.status.currentGroup,(s,n,o)=>{e(s,n,o)&&t.push(s)}),void this.getSelectedIndicies()(t)}throw console.error("Invalid indicies",e)}this.status.getSelectedIndicies()=e}this.update()}playSelectedInstructions(){this.song.stopPlayback();const e=this.status.getSelectedIndicies();for(let t=0;t<e.length;t++)this.song.playInstructionAtIndex(this.status.currentGroup,e[t])}loadCSS(){const e=this.shadowDOM||document.head;if(e.querySelector('link[href$="audio-source-composer.css"]'))return;const t=(new AudioSourceLibraries).getScriptDirectory("composer/audio-source-composer.css");let s=document.createElement("link");s.setAttribute("rel","stylesheet"),s.setAttribute("type","text/css"),s.setAttribute("href",t),e.appendChild(s),console.info("Appending "+t)}}customElements.define("audio-source-composer",AudioSourceComposerElement);class AudioSourceComposerTracker extends HTMLElement{constructor(){super(),this.editor=null,this.eventHandlers=[],this.segmentLength=16,this.currentRowSegmentID=0,this.mousePosition={},this.hasAttribute("tabindex")||this.setAttribute("tabindex","0")}get groupName(){return this.getAttribute("group")}set groupName(t){this.setAttribute("group",t),this.render(1)}get rowLengthInTicks(){return parseInt(this.getAttribute("rowLength"))}set rowLengthInTicks(t){this.setAttribute("rowLength",t),this.render(1)}get isConnected(){return this.editor.containerElm.contains(this)}connectedCallback(){this.attachEventHandler(["scroll","keydown","mousedown","mouseup","mousemove","mouseout","touchstart","touchend","touchmove","dragstart","drag","dragend","contextmenu"],t=>this.onInput(t)),this.editor=this.getRootNode().host,this.getAttribute("rowLength")||this.setAttribute("rowLength",this.editor.song.timeDivision),this.render()}disconnectedCallback(){this.eventHandlers.forEach(t=>t[2].removeEventListener(t[0],t[1]))}attachEventHandler(t,e,n,r=null){Array.isArray(t)||(t=[t]);for(let s=0;s<t.length;s++){const i=t[s];(n=n||this).addEventListener(i,e,r),this.eventHandlers.push([i,e,n])}}clearSelection(t=[]){Array.isArray(t)||(t=[t]),this.parentNode.querySelectorAll("asct-instruction-add").forEach(e=>-1!==t.indexOf(e)?null:e.parentNode.removeChild(e)),this.querySelectorAll("asct-instruction.selected").forEach(e=>-1!==t.indexOf(e)?null:e.select(!1))}playSelectedInstructions(){this.editor.song.isPlaying&&this.editor.song.stopPlayback();const t=this.getSelectedIndicies();for(let e=0;e<t.length;e++)this.editor.song.playInstructionAtIndex(this.groupName,t[e])}getInstruction(t){return this.editor.song.getInstruction(this.groupName,t)}getInstructionFormValues(t=null){t||(t=this.fieldInstructionCommand.value);let e=new SongInstruction;(this.fieldInstructionInstrument.value||0===this.fieldInstructionInstrument.value)&&(e.instrument=parseInt(this.fieldInstructionInstrument.value)),this.fieldInstructionDuration.value&&(e.duration=parseFloat(this.fieldInstructionDuration.value));const n=parseInt(this.fieldInstructionVelocity.value);return(n||0===n)&&(e.velocity=n),t=this.replaceFrequencyAlias(t,e.instrument),e.command=t,e}render(){this.renderRows(),this.renderMenu(),this.renderForms()}navigate(t,e=null){e&&e!==this.groupName&&(this.groupName=e);let n=this.findRowElement(t);if(n)return n;{const e=this.getSegmentIDFromPositionInTicks(t);if(e!==this.currentRowSegmentID){this.navigateSegment(e);let n=this.findRowElement(t);if(!n)throw new Error("Shouldn't happen: Row not found for position: "+t);return n}throw new Error("Shouldn't happen: Row not found for position: "+t)}}getSegmentIDFromPositionInTicks(t){const e=this.editor.song.timeDivision,n=this.segmentLength*e;return Math.floor(t/n)}navigateSegment(t){this.currentRowSegmentID=t,this.renderRows()}renderRows(){console.time("tracker.renderRows()");const t=this.editor.song.timeDivision;this.innerHTML="";let e=this.editor.song.getIterator(this.groupName);const n=this.rowLengthInTicks,r=this.segmentLength*t,s=this.fieldTrackerInstrument.value?parseInt(this.fieldTrackerInstrument.value):null;let i=null,o=0,c=0,a=0;for(;i=e.nextInstructionQuantizedRow(n,s);)if(a=Math.floor(e.groupPositionInTicks/r),this.currentRowSegmentID===a){c=i.length>0?i[0].index:e.groupIndex;const t=new AudioSourceComposerTrackerRow;this.appendChild(t),t.render(c,e.groupPositionInTicks,i),o=e.groupPositionInTicks}o=0===o?0:Math.ceil((o+1)/n)*n;const l=this.currentRowSegmentID*r+r;for(o<l-r&&(o=l-r);o<=l;){const t=new AudioSourceComposerTrackerRow;this.appendChild(t),t.render(c,o),o+=n}const u=this.editor.panelTrackerRowSegments;if(u){u.clearInputs(),a<this.currentRowSegmentID+1&&(a=this.currentRowSegmentID+1);for(let t=0;t<=a;t++){const e=u.addForm(t),n=e.addButton(t,e=>this.navigateSegment(t),t);e.classList.toggle("selected",t===this.currentRowSegmentID),n.classList.toggle("selected",t===this.currentRowSegmentID)}}console.timeEnd("tracker.renderRows()")}renderMenu(){const t=this.editor,e=this.editor.menuEdit,n=this.editor.menuContext;e.populate=n.populate=(e=>{const n=e.menuElement,r=this.getSelectedIndicies(),s=(e,n)=>{e.populate=(e=>{const r=e.menuElement;t.values.getValues("song-groups",(t,e)=>{r.getOrCreateSubMenu(t,`${e}`).action=n});const s=r.getOrCreateSubMenu("new","Create New Group");s.action=(t=>this.editor.actions.addNewSongGroup(t)),s.hasBreak=!0})},i=n.getOrCreateSubMenu("insert","Insert Command ►");i.populate=(e=>{const n=e.menuElement;n.getOrCreateSubMenu("frequency","Frequency ►").populate=(e=>{const n=e.menuElement;t.values.getValues("note-frequency-octaves",(e,r)=>{n.getOrCreateSubMenu(e,`Octave ${r} ►`).populate=(n=>{const r=n.menuElement;t.values.getValues("note-frequencies",(n,s)=>{const i=n+e;r.getOrCreateSubMenu(i,`${s}${e}`).action=(e=>{t.tracker.fieldInstructionCommand.value=i,this.editor.actions.insertInstructionCommand(e,i)})})})})}),n.getOrCreateSubMenu("named","Named ►").disabled=!0;const r=n.getOrCreateSubMenu("group","Group ►");s(r,e=>{const n="@"+groupName;t.tracker.fieldInstructionCommand.value=n,this.editor.actions.insertInstructionCommand(e,n)});const i=n.getOrCreateSubMenu("custom","Custom Command");i.action=(t=>this.editor.actions.insertInstructionCommand(t,null,!0)),i.hasBreak=!0}),i.disabled=r.length>0;const o=n.getOrCreateSubMenu("set-command","Set Command ►");o.populate=(e=>{const n=e.menuElement;n.getOrCreateSubMenu("frequency","Frequency ►").populate=(e=>{const n=e.menuElement;t.values.getValues("note-frequency-octaves",(e,r)=>{n.getOrCreateSubMenu(e,`Octave ${r} ►`).populate=(n=>{const r=n.menuElement;t.values.getValues("note-frequencies",(n,s)=>{const i=n+e;r.getOrCreateSubMenu(i,`${s}${e}`).action=(e=>{t.tracker.fieldInstructionCommand.value=i,this.editor.actions.setInstructionCommand(e,i)})})})})}),n.getOrCreateSubMenu("named","Named ►").disabled=!0;const r=n.getOrCreateSubMenu("group","Group ►");s(r,e=>{const n="@"+groupName;t.tracker.fieldInstructionCommand.value=n,this.editor.actions.setInstructionCommand(e,n)});const i=n.getOrCreateSubMenu("custom","Custom Command");i.action=(t=>this.editor.actions.setInstructionCommand(t,null,!0)),i.hasBreak=!0}),o.disabled=0===r.length;const c=n.getOrCreateSubMenu("set-instrument","Set Instrument ►");c.populate=(e=>{const n=e.menuElement;t.values.getValues("song-instruments",(e,r)=>{n.getOrCreateSubMenu(e,`${r}`).action=(n=>{t.tracker.fieldInstructionInstrument.value=e,this.editor.actions.setInstructionInstrument(n,e)})})}),c.disabled=0===r.length;const a=n.getOrCreateSubMenu("set-duration","Set Duration ►");a.populate=(e=>{const n=e.menuElement;t.values.getValues("durations",(e,r)=>{n.getOrCreateSubMenu(e,`${r}`).action=(n=>{t.tracker.fieldInstructionDuration.value=e,this.editor.actions.setInstructionDuration(n,e)})});const r=n.getOrCreateSubMenu("custom","Custom Duration");r.action=(t=>this.editor.actions.setInstructionDuration(t,null,!0)),r.hasBreak=!0}),a.disabled=0===r.length;const l=n.getOrCreateSubMenu("set-velocity","Set Velocity ►");l.populate=(e=>{const n=e.menuElement;t.values.getValues("velocities",(e,r)=>{n.getOrCreateSubMenu(e,`${r}`).action=(n=>{t.tracker.fieldInstructionVelocity.value=e,this.editor.actions.setInstructionVelocity(n,e)})});const r=n.getOrCreateSubMenu("custom","Custom Velocity");r.action=(t=>this.editor.actions.setInstructionVelocity(t,null,!0)),r.hasBreak=!0}),l.disabled=0===r.length;const u=n.getOrCreateSubMenu("delete","Delete Instruction(s)");u.action=(t=>this.editor.actions.deleteInstructionCommand(t)),u.disabled=0===r.length;const d=n.getOrCreateSubMenu("select","Select ►");d.hasBreak=!0,d.disabled=!0;const h=n.getOrCreateSubMenu("group","Group ►");h.hasBreak=!0,h.disabled=!0})}onInput(t){if(t.defaultPrevented)return;switch(t.type){case"mouseup":this.isSelectionRectActive()&&this.commitSelectionRect()}if(t.target instanceof Node&&!this.contains(t.target))return;let e=this.getSelectedIndicies();switch(t.type){case"midimessage":switch(t.data[0]){case 144:t.preventDefault();let e=(new MIDISupport).getCommandFromMIDINote(t.data[1]),n=Math.round(t.data[2]/128*100);console.log("MIDI ",e,n),this.insertOrUpdateCommand(t,e),this.playSelectedInstructions(t),this.focus()}break;case"keydown":this.editor.closeAllMenus();let n=t.key;switch(!t.ctrlKey&&this.editor.keyboard.getKeyboardCommand(t.key,this.fieldTrackerOctave.value)&&(n="PlayFrequency"),"Enter"===n&&t.altKey&&(n="ContextMenu"),n){case"Delete":t.preventDefault();const r=e.sort((t,e)=>e-t);for(let t=0;t<r.length;t++)this.editor.song.deleteInstructionAtIndex(this.groupName,e[t]);this.renderRows(),this.selectIndicies(t,e[0]);break;case"Escape":case"Backspace":throw new Error("TODO: navigate pop");case"Enter":if(this.contains(t.target)){t.preventDefault(),this.insertOrUpdateCommand(t);let e=this.cursorInstruction;if(e.isGroupCommand()){const t=e.command.substr(1);this.editor.selectGroup(t)}else this.playSelectedInstructions(t)}break;case"Play":t.preventDefault(),this.playSelectedInstructions(t);break;case"ArrowRight":t.preventDefault(),this.selectNextCell(t).scrollTo(),this.playSelectedInstructions(t),this.focus();break;case"ArrowLeft":t.preventDefault(),this.selectPreviousCell(t).scrollTo(),this.playSelectedInstructions(t),this.focus();break;case"ArrowDown":t.preventDefault(),this.selectNextRowCell(t).scrollTo(),this.playSelectedInstructions(t),this.focus();break;case"ArrowUp":t.preventDefault(),this.selectPreviousRowCell(t).scrollTo(),this.playSelectedInstructions(t),this.focus();break;case" ":t.preventDefault(),this.editor.song.isPlaybackActive()?this.editor.song.stopPlayback():this.editor.song.play();break;case"PlayFrequency":let s=this.editor.keyboard.getKeyboardCommand(t.key,this.fieldTrackerOctave.value);if(null===s)break;t.preventDefault(),this.insertOrUpdateCommand(t,s),this.playSelectedInstructions(t),this.focus()}break;case"touchstart":case"mousedown":if(this.editor.closeAllMenus(),this.mousePosition.isDown=!0,this.mousePosition.isDragging=!1,this.mousePosition.lastDown=t,delete this.mousePosition.lastDrag,t.target.matches("asct-instruction,asct-instruction-add"))return this.onCellInput(t);if(t.target.matches("asct-instruction > *"))return this.onCellInput(t,t.target.instruction);if(t.target.matches("asct-row"))return this.onRowInput(t);break;case"touchmove":case"mousemove":1===t.which&&this.mousePosition.isDown&&(this.mousePosition.isDragging=!0,this.mousePosition.lastDrag=t),this.mousePosition.isDown&&this.mousePosition.lastDrag&&this.mousePosition.lastDown.path[0].matches("asct-row");break;case"touchend":case"mouseup":this.mousePosition.isDown=!1,this.mousePosition.isDragging&&this.mousePosition.lastDown.path[0].matches("asct-row"),this.mousePosition.isDragging=!1;const r=this.mousePosition.lastUp;if(t.t=new Date,this.mousePosition.lastUp=t,r&&r.t.getTime()+this.editor.status.doubleClickTimeout>(new Date).getTime()){t.preventDefault();const e=t.path[0],n=r.path[0];if(n===e||n.contains(e)||e.contains(n)){const n=new CustomEvent("doubleclick",{detail:{firstMouseEvent:r.e,secondMouseEvent:t,clientX:t.clientX,clientY:t.clientY},cancelable:!0,bubbles:!0});e.dispatchEvent(n)}}break;case"mouseout":t.target.matches("asc-tracker")&&(console.log(t.target,t.path),this.isSelectionRectActive()&&this.commitSelectionRect());break;case"click":break;case"doubleclick":case"longpress":t.preventDefault(),this.contains(t.target)&&this.editor.menuContext.openContextMenu(t);break;case"contextmenu":t.altKey||(t.preventDefault(),this.editor.menuContext.openContextMenu(t,this.cursorCell));break;case"scroll":break;case"dragstart":case"drag":case"dragend":console.info(t.type);break;default:throw new Error("Unhandled type: "+t.type)}}updateSelectionRect(t,e){e||(e=this.mousePosition.lastDrag||this.mousePosition.lastDrag);var n=t.clientX-e.clientX,r=t.clientY-e.clientY;if(Math.sqrt(n*n+r*r)<30)return console.warn("Skipping selection rect");let s,i,o,c,a=this.querySelector("div.selection-rect");return a||((a=document.createElement("div")).classList.add("selection-rect"),this.appendChild(a)),t.clientX<e.clientX?(s=t.clientX,o=e.clientX-t.clientX):(s=e.clientX,o=t.clientX-e.clientX),t.clientY<e.clientY?(i=t.clientY,c=e.clientY-t.clientY):(i=e.clientY,c=t.clientY-e.clientY),a.style.left=s+"px",a.style.width=o+"px",a.style.top=i+"px",a.style.height=c+"px",this.querySelectorAll("asct-instruction").forEach(t=>{const e=t.getBoundingClientRect(),n=e.x+e.width>s&&e.x<s+o&&e.y+e.height>i&&e.y<i+c;t.classList.toggle("selecting",n)}),{x:s,y:i,w:o,h:c}}isSelectionRectActive(){return!!this.querySelector("div.selection-rect")}commitSelectionRect(t=null,e=null){t||(t=this.mousePosition.lastDown);let n=this.querySelector("div.selection-rect");if(!n)return console.warn("No selection rect");const r=n.getBoundingClientRect();n.parentNode.removeChild(n),this.clearSelection();const s=this.querySelectorAll("asct-instruction,asct-row"),i=[];s.forEach(t=>{const e=t.getBoundingClientRect();e.x+e.width>r.x&&e.x<r.x+r.width&&e.y+e.height>r.y&&e.y<r.y+r.height&&(i.push(t),t.select(!0,!1))}),console.log("Selection ",i,r)}get panelTracker(){return this.editor.panelTracker}get formTrackerOctave(){return this.editor.panelTracker.getOrCreateForm("octave","Octave")}get formTrackerRowLength(){return this.editor.panelTracker.getOrCreateForm("row-length","Row Length")}get formTrackerInstrument(){return this.editor.panelTracker.getOrCreateForm("instrument","Filter by Instrument")}get formTrackerSelection(){return this.editor.panelTracker.getOrCreateForm("selection","Selection")}get fieldTrackerRowLength(){return this.formTrackerRowLength.getInput("row-length",!1)||this.formTrackerRowLength.addSelectInput("row-length",t=>this.editor.actions.setTrackerRowLength(t),t=>{t("","Default"),this.editor.values.getValues("durations",t)},"Select Row Length","")}get fieldTrackerFilterInstrument(){return this.formTrackerInstrument.getInput("filter-instrument",!1)||this.formTrackerInstrument.addSelectInput("filter-instrument",t=>this.editor.actions.setTrackerFilterInstrument(t),t=>{t("","Default"),this.editor.values.getValues("song-instruments",t)},"Filter By Instrument","")}get fieldTrackerOctave(){return this.formTrackerOctave.getInput("octave",!1)||this.formTrackerOctave.addSelectInput("octave",t=>this.editor.actions.setTrackerOctave(t),t=>{this.editor.values.getValues("note-frequency-octaves",t)},"Select Octave",3)}get fieldTrackerSelection(){return this.formTrackerSelection.getInput("selection",!1)||this.formTrackerSelection.addTextInput("selection",t=>this.editor.actions.setTrackerSelection(t),"Selection","","No selection")}get panelInstruction(){return this.editor.panelInstruction}get formInstructionCommand(){return this.editor.panelInstruction.getOrCreateForm("command","Command")}get formInstructionInstrument(){return this.editor.panelInstruction.getOrCreateForm("instrument","Instrument")}get formInstructionVelocity(){return this.editor.panelInstruction.getOrCreateForm("velocity","Velocity")}get formInstructionDuration(){return this.editor.panelInstruction.getOrCreateForm("duration","Duration")}get fieldInstructionCommand(){return this.formInstructionCommand.getInput("command",!1)||this.formInstructionCommand.addSelectInput("command",(t,e)=>this.editor.actions.setInstructionCommand(t,e),(t,e)=>{t("","No Command Selected"),e("Frequencies"),this.editor.values.getValues("note-frequencies-all",t),e("Custom Frequencies"),this.editor.values.getValues("command-instrument-frequencies",t),e("Groups"),this.editor.values.getValues("command-group-execute",t)},"Instruction Instrument","")}get fieldInstructionInsert(){return this.formInstructionCommand.getInput("insert",!1)||this.formInstructionCommand.addIconButton("insert",t=>this.editor.actions.insertInstructionCommand(t),"insert","Insert Instruction")}get fieldInstructionDelete(){return this.formInstructionCommand.getInput("delete",!1)||this.formInstructionCommand.addIconButton("delete",t=>this.editor.actions.deleteInstructionCommand(t),"subtract","Delete Instruction")}get fieldInstructionInstrument(){return this.formInstructionInstrument.getInput("instrument",!1)||this.formInstructionInstrument.addSelectInput("instrument",t=>this.editor.actions.setInstructionInstrument(t),(t,e)=>{t("","No Instrument Selected"),e("Song Instruments"),this.editor.values.getValues("song-instruments",t)},"Instruction Instrument","")}get fieldInstructionVelocity(){return this.formInstructionVelocity.getInput("velocity",!1)||this.formInstructionVelocity.addRangeInput("velocity",(t,e)=>this.editor.actions.setInstructionVelocity(t,e),1,127)}get fieldInstructionDuration(){return this.formInstructionDuration.getInput("duration",!1)||this.formInstructionDuration.addSelectInput("duration",t=>this.editor.actions.setInstructionDuration(t),(t,e)=>{t("","No Duration"),this.editor.values.getValues("durations",t)},"Instruction Duration","")}renderForms(){let t=this.getSelectedIndicies();let e=this.editor.song.getInstructions(this.groupName,t)[0];this.fieldInstructionCommand,this.fieldInstructionInsert,this.fieldInstructionDelete.disabled=0===t.length,this.fieldInstructionInstrument,this.fieldInstructionVelocity,this.fieldInstructionDuration,e&&(this.fieldInstructionCommand.value=e.command,this.fieldInstructionInstrument.value=e.instrument,this.fieldInstructionVelocity.value=e.velocity,this.fieldInstructionDuration.value=e.duration);const n=this.fieldTrackerOctave.value;this.fieldTrackerOctave.value=null!==n?n:3,this.fieldTrackerInstrument,this.fieldTrackerRowLength,this.fieldTrackerSelection,null===this.fieldTrackerOctave.value&&(this.fieldTrackerOctave.value=3),this.fieldTrackerRowLength.value=this.rowLengthInTicks,!this.fieldInstructionDuration.value&&this.fieldTrackerRowLength.value&&(this.fieldInstructionDuration.value=parseInt(this.fieldTrackerRowLength.value)),this.fieldTrackerSelection.value=t.join(",")}onRowInput(t){t.preventDefault();let e=t.target;t.shiftKey||this.clearSelection(),e.createAddInstructionElement(),e.setCursor(),this.renderForms(),this.playSelectedInstructions(t),this.focus(),e.parentNode.scrollTo(),this.editor.song.setPlaybackPositionInTicks(e.position)}onCellInput(t,e){t.preventDefault(),e=e||t.target,t.ctrlKey||this.clearSelection(),this.editor.closeAllMenus(),console.time("onCelInput"),e.select(!e.selected),console.timeEnd("onCelInput"),e.setCursor(),this.renderForms(),e.play(),e.parentNode.scrollTo(),this.focus(),this.editor.song.setPlaybackPositionInTicks(e.parentNode.position)}setPlaybackPositionInTicks(t){let e=this.navigate(t);this.querySelectorAll("asct-row.position").forEach(t=>t.classList.remove("position")),e.classList.add("position")}async onSongEvent(t){switch(t.type){case"song:seek":case"group:seek":this.setPlaybackPositionInTicks(t.detail.positionInTicks);break;case"group:play":break;case"note:start":if(t.detail.instruction){let e=this.findInstructionElement(t.detail.instruction.index);e&&e.classList.add("playing")}break;case"note:end":if(t.detail.instruction){let e=this.findInstructionElement(t.detail.instruction.index);e&&e.classList.remove("playing")}}}get selectedCells(){return this.querySelectorAll("asct-instruction.selected")}get cursorCell(){return this.querySelector("asct-instruction.cursor,asct-instruction-add.cursor")}get cursorRow(){return this.cursorCell.parentNode}get cursorPosition(){return(t=>t?t.parentNode.position:null)(this.cursorCell)}get cursorInstruction(){return this.getInstruction(this.cursorCell.index)}get selectedIndicies(){return[].map.call(this.selectedCells,t=>t.index)}getCursorElement(){return this.querySelector(".cursor")}selectNextCell(t,e=!0){const n=this.getCursorElement();let r;if(n){if(n instanceof AudioSourceComposerTrackerInstructionAdd)return this.selectNextRowCell(t,e,0);r=n.nextInstructionSibling?n.nextInstructionSibling:n.row.createAddInstructionElement()}else r=this.querySelector("asct-instruction");return r||(r=this.querySelector("asct-row").createAddInstructionElement()),r.select(!0).setCursor(),e&&this.clearSelection(r),r}selectPreviousCell(t,e=!0){const n=this.getCursorElement();let r;if(n){if(!n.previousInstructionSibling)return this.selectPreviousRowCell(t,e,-1);r=n.previousInstructionSibling}return r||(r=this.querySelector("asct-row:last-child").createAddInstructionElement()),r.select(!0).setCursor(),e&&this.clearSelection(r),r}selectNextRowCell(t,e=!0,n=null){const r=this.getCursorElement(),s=r.parentNode;if(null===n&&(n=[].indexOf.call(r.parentNode.children,r)),!s.nextElementSibling)return this.currentRowSegmentID++,this.renderRows(),this.focus(),this.selectNextCell(t,!0);const i=s.nextElementSibling;let o=i.querySelector("asct-instruction");return i.children[n]&&i.children[n].matches("asct-instruction,asct-instruction-add")&&(o=i.children[n]),o||(o=i.createAddInstructionElement()),o.select(!0).setCursor(),e&&this.clearSelection(o),o}selectPreviousRowCell(t,e=!0,n=null){const r=this.getCursorElement(),s=r.parentNode;if(null===n&&(n=[].indexOf.call(r.parentNode.children,r)),!s.previousElementSibling){if(0===this.currentRowSegmentID)throw new Error("TODO: reached beginning of song");return this.currentRowSegmentID--,this.renderRows(),this.focus(),this.selectPreviousCell(t,!0)}let i,o=s.previousElementSibling;return o.children[n]&&o.children[n].matches("asct-instruction,asct-instruction-add")&&(i=o.children[n]),i||(i=o.createAddInstructionElement()),i.select(!0).setCursor(),e&&this.clearSelection(i),i}selectIndicies(t,e,n=!0){const r=this.getSelectedIndicies();if(e.length!==r.length||!e.sort().every(function(t,e){return t===r.sort()[e]})){Array.isArray(e)||(e=[e]),n&&this.clearSelection();for(let t=0;t<e.length;t++){const n=this.findInstructionElement(e[t]);if(!n)throw new Error("Instruction not found: "+e[t]);n.select(!0,!1),0===t&&n.setCursor()}}}increaseTrackerSize(t,e=!0){if(this.renderMinimumRows+=1,this.render(),e){this.querySelector("asc-tracker > asct-row:last-child").setCursor()}}insertInstructionAtIndex(t,e){return this.editor.song.insertInstructionAtIndex(this.groupName,e,t)}insertInstructionAtPosition(t,e){return this.editor.song.insertInstructionAtPosition(this.groupName,t,e)}deleteInstructionAtIndex(t){return this.editor.song.deleteInstructionAtIndex(this.groupName,t,1)}replaceInstructionCommand(t,e){return this.editor.song.replaceInstructionCommand(this.groupName,t,e)}replaceInstructionVelocity(t,e){return this.editor.song.replaceInstructionVelocity(this.groupName,t,e)}insertOrUpdateCommand(t,e=null){let n=this.getSelectedIndicies();if(this.cursorCell.matches("asct-instruction-add")){let n=this.getInstructionFormValues(e);if(!n)return this.fieldInstructionCommand.focus(),console.info("Insert canceled");const r=this.cursorPosition,s=this.insertInstructionAtPosition(r,n);this.renderRows(),this.selectIndicies(t,s)}else{for(let t=0;t<n.length;t++){const r=this.getInstruction(n[t]),s=this.replaceFrequencyAlias(e,r.instrument);this.replaceInstructionCommand(n[t],s)}this.renderRows(),this.selectIndicies(t,n)}}replaceFrequencyAlias(t,e){const n=this.editor.song.getInstrument(e,!1);if(!n||!n.getFrequencyAliases)return t;const r=n.getFrequencyAliases(t);return void 0===r[t]?t:r[t]}findRowElement(t){let e=this.querySelector(`asct-row[p='${t}']`);if(e)return e;let n=this.querySelectorAll("asct-row");for(let e=n.length-1;e>=0;e--){const r=n[e];if(r.position<t)return r}return null}findInstructionElement(t){return this.querySelector(`asct-instruction[i='${t}']`)}}customElements.define("asc-tracker",AudioSourceComposerTracker);const VISIBLE_BUFFER=100;class AudioSourceComposerTrackerRow extends HTMLElement{constructor(){super()}get tracker(){return this.closest("asc-tracker")}get selected(){return this.classList.contains("selected")}set position(t){this.setAttribute("p",t)}get position(){return parseInt(this.getAttribute("p"))}get duration(){return this.nextElementSibling?this.nextElementSibling.position-this.position:"N/A"}set index(t){this.setAttribute("i",t)}get index(){return parseInt(this.getAttribute("i"))}get visible(){const t=this.parentNode.scrollTop+this.parentNode.offsetHeight,e=this.offsetTop+this.offsetHeight;return!(this.offsetTop-t>VISIBLE_BUFFER)&&!(e<this.parentNode.scrollTop-VISIBLE_BUFFER)}connectedCallback(){}getDeltaElement(){let t=this.querySelector("asct-delta");return t||(t=document.createElement("asct-delta"),this.appendChild(t),t)}createAddInstructionElement(){let t=this.querySelector("asct-instruction-add");if(!t){this.parentNode.querySelectorAll("asct-instruction-add").forEach(t=>t.parentNode.removeChild(t));const e=document.createElement("asct-instruction-add");t=e,e.index=this.index,e.innerHTML="+"}const e=this.getDeltaElement();return this.insertBefore(t,e),t}clearAddInstructionElement(){this.parentNode.querySelectorAll("asct-instruction-add").forEach(t=>t.parentNode.removeChild(t))}setCursor(){this.querySelector("asct-instruction-add").classList.add("cursor")}select(t=!0){if(t){if(this.selected)return void console.warn("Already selected ",this);this.classList.add("selected")}else{if(!this.selected)return void console.warn("Already unselected ",this);this.classList.remove("selected")}}updateDelta(){let t=this.getDeltaElement();this.appendChild(t),t.render(this.duration)}scrollTo(){const t=this.parentNode;t.scrollTop<this.offsetTop-t.offsetHeight&&(t.scrollTop=this.offsetTop),t.scrollTop>this.offsetTop&&(t.scrollTop=this.offsetTop-t.offsetHeight)}render(t,e,n=[]){this.position=e;const r=this.querySelectorAll("asct-instruction");let s=0;for(;s<r.length;s++){const e=r[s];s>=n.length?e.parentNode.removeChild(e):(e.index=t+s,e.render(n[s]))}for(;s<n.length;s++){const e=document.createElement("asct-instruction");e.index=t+s,this.appendChild(e),e.render(n[s])}return this.nextElementSibling?this.updateDelta():this.previousElementSibling&&this.previousElementSibling.updateDelta(),this.selected&&this.createAddInstructionElement(),this}}customElements.define("asct-row",AudioSourceComposerTrackerRow);class AudioSourceComposerTrackerInstruction extends HTMLElement{constructor(){super()}get row(){return this.parentNode}get tracker(){if(!this.parentNode)throw new Error("Invalid tracker");return this.parentNode.tracker}get editor(){return this.tracker.editor}set index(t){this.setAttribute("i",t)}get index(){return parseInt(this.getAttribute("i"))}get selected(){return this.classList.contains("selected")}get nextInstructionSibling(){return this.nextElementSibling&&this.nextElementSibling.matches("asct-instruction")?this.nextElementSibling:null}get previousInstructionSibling(){return this.previousElementSibling&&this.previousElementSibling.matches("asct-instruction")?this.previousElementSibling:null}getInstruction(){return this.row.tracker.getInstruction(this.index)}play(){return this.editor.song.playInstructionAtIndex(this.tracker.groupName,this.index,this.editor.song.getAudioContext().currentTime,{groupPositionInTicks:this.row.position,currentIndex:this.index}),this}connectedCallback(){}scrollTo(){return this.row.scrollTo()}setCursor(){return this.tracker.querySelectorAll(".cursor").forEach(t=>t.classList.remove("cursor")),this.classList.add("cursor"),this}select(t=!0){return t?this.classList.add("selected"):this.classList.remove("selected","cursor"),this.render(),this}render(t=null){t=t||this.getInstruction();let e=this.querySelector("ascti-command");if(e||this.appendChild(e=document.createElement("ascti-command")),e.render(t),this.classList.contains("selected")){let e=this.querySelector("ascti-instrument");e||this.appendChild(e=document.createElement("ascti-instrument")),e.render(t);let n=this.querySelector("ascti-velocity");n||this.appendChild(n=document.createElement("ascti-velocity")),n.render(t);let r=this.querySelector("ascti-duration");r||this.appendChild(r=document.createElement("ascti-duration")),r.render(t)}else{let t=this.querySelector("ascti-instrument");t&&t.parentNode.removeChild(t);let e=this.querySelector("ascti-velocity");e&&e.parentNode.removeChild(e);let n=this.querySelector("ascti-duration");n&&n.parentNode.removeChild(n)}return this}}customElements.define("asct-instruction",AudioSourceComposerTrackerInstruction);class AudioSourceComposerTrackerInstructionAdd extends AudioSourceComposerTrackerInstruction{render(t=null){if(t)throw new Error("Invalid");return this.innerHTML="+",this}}customElements.define("asct-instruction-add",AudioSourceComposerTrackerInstructionAdd);class AudioSourceComposerTrackerParameter extends HTMLElement{constructor(){super()}get instruction(){return this.parentNode}get tracker(){return this.parentNode.parentNode.tracker}get editor(){return this.tracker.editor}connectedCallback(){}render(){this.innerHTML=this.editor.values.format(this.row.duration,"duration")}}class AudioSourceComposerParamCommand extends AudioSourceComposerTrackerParameter{render(t=null){t=t||this.instruction.getInstruction(),this.innerHTML=this.editor.values.format(t.command,"command")}}customElements.define("ascti-command",AudioSourceComposerParamCommand);class AudioSourceComposerParamInstrument extends AudioSourceComposerTrackerParameter{render(t=null){t=t||this.instruction.getInstruction(),this.innerHTML=this.editor.values.format(t.instrument,"instrument")}}customElements.define("ascti-instrument",AudioSourceComposerParamInstrument);class AudioSourceComposerParamVelocity extends AudioSourceComposerTrackerParameter{render(t=null){t=t||this.instruction.getInstruction(),this.innerHTML=this.editor.values.format(t.velocity,"velocity")}}customElements.define("ascti-velocity",AudioSourceComposerParamVelocity);class AudioSourceComposerTrackerDuration extends AudioSourceComposerTrackerParameter{render(t=null){t=t||this.instruction.getInstruction(),this.innerHTML=this.editor.values.format(t.duration,"duration")}}customElements.define("ascti-duration",AudioSourceComposerTrackerDuration);class AudioSourceComposerTrackerDelta extends HTMLElement{constructor(){super()}get editor(){return this.tracker.editor}get tracker(){return this.parentNode.tracker}get row(){return this.parentNode}connectedCallback(){}render(t){t=t||this.row?this.row.duration:-1,this.innerHTML=this.editor.values.format(t,"duration")}}customElements.define("asct-delta",AudioSourceComposerTrackerDelta);class AudioSourceComposerKeyboard{constructor(){}get keyboardLayout(){return{2:"C#2",3:"D#2",5:"F#2",6:"G#2",7:"A#2",9:"C#3",0:"D#3",q:"C2",w:"D2",e:"E2",r:"F2",t:"G2",y:"A2",u:"B2",i:"C3",o:"D3",p:"E3",s:"C#1",d:"D#1",g:"F#1",h:"G#1",j:"A#1",l:"C#2",";":"D#2",z:"C1",x:"D1",c:"E1",v:"F1",b:"G1",n:"A1",m:"B1",",":"C2",".":"D2","/":"E2"}}getKeyboardCommand(e,r=3){if(!Number.isInteger(r))throw new Error("Octave value must be an integer");const o=this.keyboardLayout;if(void 0===o[e])return null;let t=o[e];return t=(t=t.replace("2",r+1)).replace("1",r)}}class AudioSourceComposerMenu extends HTMLElement{constructor(){super(),this.action=null,this.populate=null,this.mouseTimeout=null,this.caption=null}get key(){return this.getAttribute("key")}set key(e){this.setAttribute("key",e),this.render()}get disabled(){return"true"==this.getAttribute("disabled")}set disabled(e){e?this.setAttribute("disabled","true"):this.removeAttribute("disabled")}get hasBreak(){return this.getAttribute("hasBreak")}set hasBreak(e){this.setAttribute("hasBreak",e),this.render()}get editor(){const e=this.closest("div.asc-container").parentNode.host;if(!e)throw new Error("Editor not found");return e}connectedCallback(){const e=this.getAttribute("caption");e&&(this.caption=e),this.addEventListener("mouseenter",this.onInputEvent),this.addEventListener("mouseleave",this.onInputEvent),this.addEventListener("click",this.onInputEvent),this.addEventListener("change",this.onInputEvent),this.addEventListener("keydown",this.onInputEvent),this.render()}disconnectedCallback(){this.removeEventListener("mouseenter",this.onInputEvent),this.removeEventListener("mouseleave",this.onInputEvent),this.removeEventListener("click",this.onInputEvent),this.removeEventListener("change",this.onInputEvent),this.removeEventListener("keydown",this.onInputEvent)}onInputEvent(e){if(!this.contains(e.target))return;if(this===e.target.closest("asui-menu"))switch(e.type){case"mouseenter":clearTimeout(this.mouseTimeout),this.hasSubMenu&&this.renderSubMenu(e);break;case"mouseleave":this.classList.contains("stick")||(clearTimeout(this.mouseTimeout),this.mouseTimeout=setTimeout(e=>{this.clearSubMenu()},200));break;case"click":if(e.defaultPrevented)return;if(this.hasAction)e.preventDefault(),this.doAction(e);else{if(!this.hasSubMenu)return console.warn("Menu has no submenu or action: ",this);e.preventDefault(),this.toggleSubMenu(e)}break;case"keydown":if(e.defaultPrevented)return;e.preventDefault();const t=this.getSubMenuContainer(),n=t.querySelector("asui-menu.selected")||t.firstElementChild;if(!n)throw new Error("No selected menu item found");switch(e.key){case"Escape":case"Backspace":this.closeMenu(e);break;case"Enter":if(n.hasAction)n.doAction(e);else{if(!n.hasSubMenu)return console.warn("Menu has no submenu or action: ",n);n.toggleSubMenu(e)}break;case"ArrowRight":if(!n.hasSubMenu)return console.warn("Menu has no submenu: ",n);n.toggleSubMenu(e);break;case"ArrowLeft":this.closeMenu(e);break;case"ArrowDown":this.selectNextSubMenuItem();break;case"ArrowUp":this.selectPreviousSubMenuItem()}}}get hasAction(){return!!this.action}doAction(e){if(!this.hasAction)throw new Error("No .action callback set");e.menuElement=this,this.action(e),this.closeAllMenus()}get hasSubMenu(){return!!this.populate}toggleSubMenu(e){this.classList.contains("open")?this.clearSubMenu(e):this.renderSubMenu(e)}clearSubMenu(e){this.classList.remove("open"),this.getSubMenuContainer().innerHTML=""}renderSubMenu(e){if(!this.populate)throw new Error("Menu has no .populate callback");let t=this.getSubMenuContainer();this.classList.add("open"),e.menuElement=this,this.populate(e),t.focus();const n=t.querySelectorAll("asui-menu:not([disabled])");n[0]&&n[0].classList.add("selected")}getSubMenuContainer(){let e=this.querySelector(".dropdown-container");return e||((e=document.createElement("div")).classList.add("dropdown-container"),e.setAttribute("tabindex","0"),this.appendChild(e)),e}getOrCreateSubMenu(e,t=null){e=e.toString();let n=this.getSubMenuContainer();for(let t=0;t<n.childNodes.length;t++){const s=n.childNodes[t];if(s.matches("asui-menu")&&s.key===e)return s}const s=document.createElement("asui-menu");return s.key=e,t&&(s.caption=t),n.appendChild(s),s}selectNextSubMenuItem(){const e=this.getSubMenuContainer(),t=e.querySelector("asui-menu.selected");e.querySelectorAll("asui-menu.selected").forEach(e=>e.classList.remove("selected"));const n=e.querySelectorAll("asui-menu:not([disabled])");let s=[].indexOf.call(n,t);(s>-1&&s<n.length-1?n[s+1]:n[0]).classList.add("selected")}selectPreviousSubMenuItem(){const e=this.getSubMenuContainer(),t=e.querySelector("asui-menu.selected");e.querySelectorAll("asui-menu.selected").forEach(e=>e.classList.remove("selected"));const n=e.querySelectorAll("asui-menu:not([disabled])");let s=[].indexOf.call(n,t);(s>0?n[s-1]:n[n.length-1]).classList.add("selected")}openContextMenu(e,t=null){const n=(t=t||e.target).getBoundingClientRect();let s=this.getSubMenuContainer();const i=this.editor.getBoundingClientRect();let r=n.x+n.width-i.x,o=n.y+n.height-i.y;this.clearSubMenu(),this.renderSubMenu(e),console.info("Context menu ",t,s,r,o),s.classList.add("open-context-menu"),this.classList.add("open","stick"),s.style.left=r+"px",s.style.top=o+"px"}closeAllMenus(){let e=this;for(;e.parentElement&&e.parentElement.closest("asui-menu");)e=e.parentElement.closest("asui-menu");e.parentElement.querySelectorAll("asui-menu.open,asui-menu.stick").forEach(e=>e.classList.remove("open","stick"))}closeMenu(e){this.clearSubMenu(e);let t=this.parentElement.closest("asui-menu");this.querySelectorAll("asui-menu.open,asui-menu.stick").forEach(e=>e.classList.remove("open","stick")),t&&t!==this&&t.renderSubMenu(e)}render(){const e=null===this.caption?this.key:this.caption;if(e){let t=this.querySelector("div");t||((t=document.createElement("div")).classList.add("caption"),this.firstElementChild?this.insertBefore(t,this.firstElementChild):this.appendChild(t)),t.innerHTML="","string"==typeof e?t.innerHTML=e:t.appendChild(e)}if(this.hasBreak){let e=this.querySelector("hr");e||(e=document.createElement("hr"),this.firstElementChild?this.insertBefore(e,this.firstElementChild):this.appendChild(e))}}}customElements.define("asui-menu",AudioSourceComposerMenu);class AudioSourceComposerActions{constructor(t){this.editor=t}setInstrumentName(t,e,o){this.editor.song.setInstrumentName(e,o),this.editor.setStatus(`Instrument name updated: ${o}`)}setSongName(t,e){this.editor.song.setName(e),this.editor.setStatus(`Song name updated: ${e}`)}setSongVersion(t,e){this.editor.song.setVersion(e),this.editor.setStatus(`Song version updated: ${e}`)}setSongVolume(t,e){this.editor.song.setVolume(e),this.editor.setStatus(`Volume modified: ${e}`)}loadNewSongData(){const t=new AudioSourceStorage,e=this.getDefaultInstrumentURL()+"";let o=t.generateDefaultSong(e);this.editor.song.loadSongData(o),this.editor.render(),this.editor.setStatus("Loaded new song",o)}async loadRecentSongData(){const t=new AudioSourceStorage;let e=await t.getRecentSongList();return!(!e[0]||!e[0].guid)&&(this.editor.setStatus("Loading recent song: "+e[0].guid),await this.loadSongFromMemory(e[0].guid),!0)}async saveSongToMemory(){const t=this.editor.song,e=t.data,o=t.history,n=new AudioSourceStorage;this.editor.setStatus("Saving song to memory..."),await n.saveSongToMemory(e,o),this.editor.setStatus("Saved song to memory: "+e.guid)}saveSongToFile(){const t=this.editor.song.data,e=new AudioSourceStorage;this.editor.setStatus("Saving song to file"),e.saveSongToFile(t)}async loadSongFromMemory(t){const e=this.editor.song,o=new AudioSourceStorage,n=await o.loadSongFromMemory(t),s=await o.loadSongHistoryFromMemory(t);e.loadSongData(n),e.loadSongHistory(s),this.editor.render(),this.editor.setStatus("Song loaded from memory: "+t,n)}async loadSongFromFileInput(t){const e=t.name.split(".").pop().toLowerCase();switch(e){case"mid":case"midi":await this.loadSongFromMIDIFileInput(t);break;case"json":await this.loadSongFromJSONFileInput(t);break;default:throw new Error("Unknown file type: "+e)}}async loadSongFromJSONFileInput(t){const e=new AudioSourceStorage,o=await e.loadJSONFile(t);this.editor.song.loadSongData(o),this.editor.render(),this.editor.setStatus("Song loaded from file: ",o)}async loadSongFromMIDIFileInput(t,e=null){e=e||this.getDefaultInstrumentURL();const o=new MIDISupport,n=await o.loadSongFromMidiFile(t,e);this.editor.song.loadSongData(n),this.editor.render(),this.editor.setStatus("Song loaded from midi: ",n)}async loadSongFromSrc(t){t=new URL(t,document.location)+"";const e=await new Promise((e,o)=>{const n=new XMLHttpRequest;n.open("GET",t+"",!0),n.responseType="json",n.onload=(()=>{if(200!==n.status)return o("Song file not found: "+url);e(n.response)}),n.send()});this.editor.song.loadSongData(e,t),this.editor.setStatus("Song loaded from src: "+t),console.info(this.editor.song.data),this.editor.render()}async songPlay(){await this.editor.song.play()}async songPause(){this.editor.song.stopPlayback()}async songStop(){this.editor.song.stopPlayback(),this.editor.song.setPlaybackPositionInTicks(0)}insertInstructionCommand(t,e=null,o=!1){const n=this.editor.tracker,s=this.editor.song;n.getSelectedIndicies();if(null===e&&(e=n.fieldInstructionCommand.value||null),o&&(e=prompt("Set custom command:",e||"")),!e)throw new Error("Invalid Instruction command");let r=n.getInstructionFormValues(e);if(!n.cursorCell)throw new Error("No cursor cell");{const e=n.cursorPosition;if(null===e)throw new Error("No cursor position");const o=s.insertInstructionAtPosition(n.groupName,e,r);n.renderRows(),n.selectIndicies(t,o)}n.playSelectedInstructions()}setInstructionCommand(t,e=null,o=!1){const n=this.editor.tracker,s=this.editor.song;let r=n.getSelectedIndicies();if(null===e&&(e=n.fieldInstructionCommand.value||null),o&&(e=prompt("Set custom command:",e||"")),!e)throw new Error("Invalid Instruction command");n.getInstructionFormValues(e);if(!(r.length>0))throw new Error("No selection");for(let t=0;t<r.length;t++)s.replaceInstructionCommand(n.groupName,r[t],e),n.findInstructionElement(r[t]).render();n.renderRows(),n.selectIndicies(t,r),n.playSelectedInstructions()}setInstructionInstrument(t,e=null){const o=this.editor.tracker,n=this.editor.song;let s=o.getSelectedIndicies();if(e=null!==e?e:parseInt(o.fieldInstructionInstrument.value),!Number.isInteger(e))throw new Error("Invalid Instruction ID");for(let t=0;t<s.length;t++)n.replaceInstructionInstrument(o.groupName,s[t],e),o.findInstructionElement(s[t]).render();this.editor.status.currentInstrumentID=e,o.playSelectedInstructions(),o.selectIndicies(t,s)}setInstructionDuration(t,e=null,o=!1){const n=this.editor.tracker,s=this.editor.song;let r=n.getSelectedIndicies();if(e||(e=parseFloat(n.fieldInstructionDuration.value)),o&&(e=parseInt(prompt("Set custom duration in ticks:",e))),isNaN(e))throw new Error("Invalid duration: "+typeof e);for(let t=0;t<r.length;t++)s.replaceInstructionDuration(n.groupName,r[t],e),n.findInstructionElement(r[t]).render();n.playSelectedInstructions(),n.selectIndicies(t,r)}setInstructionVelocity(t,e=null,o=!1){const n=this.editor.tracker,s=this.editor.song;let r=n.getSelectedIndicies();if(null===e&&(e=n.fieldInstructionVelocity.value),e=parseFloat(e),o&&(e=parseInt(prompt("Set custom velocity (0-127):",n.fieldInstructionVelocity.value))),null===e||isNaN(e))throw new Error("Invalid velocity: "+typeof e);for(let t=0;t<r.length;t++)s.replaceInstructionVelocity(n.groupName,r[t],e),n.findInstructionElement(r[t]).render();n.playSelectedInstructions(),n.selectIndicies(t,r)}deleteInstructionCommand(t){const e=this.editor.tracker,o=this.editor.song;let n=e.getSelectedIndicies();for(let t=0;t<n.length;t++)o.deleteInstructionAtIndex(e.groupName,n[t]);e.renderRows(),e.selectIndicies(t,n[0])}addNewSongGroup(t){const e=this.editor.tracker,o=this.editor.song;let n=o.generateInstructionGroupName(e.groupName);(n=prompt("Create new instruction group?",n))?o.addInstructionGroup(n,[]):this.editor.setStatus("<span style='color: red'>Create instruction group canceled</span>"),this.editor.render()}songAddInstrument(t,e=null){(e=e||t.target.form.elements.instrumentURL.value)?confirm(`Add Instrument to Song?\nURL: ${e}`)?(this.editor.song.addInstrument(e),this.editor.setStatus("New instrument Added to song: "+e)):this.editor.setStatus(`<span style='color: red'>New instrument canceled: ${e}</span>`):this.editor.setStatus("<span style='color: red'>Empty URL</span>")}async songReplaceInstrument(t,e,o=null){if(!Number.isInteger(e))throw new Error("Invalid Instrument ID: Not an integer");if(!(o=o||t.target.form.elements.instrumentURL.value))throw new Error("Failed to change instrument: Empty URL");const n={url:o};n.title=n.url.split("/").pop(),await this.editor.song.replaceInstrument(e,n),await this.editor.song.loadInstrument(e,!0),this.editor.setStatus(`Instrument (${e}) changed to: ${o}`),this.editor.tracker.fieldInstructionInstrument.value=e}songRemoveInstrument(t,e=null){null===e&&(e=parseInt(t.target.form.elements.instrumentID.value)),confirm(`Remove Instrument ID: ${e}`)?(this.editor.song.removeInstrument(e),this.editor.setStatus(`Instrument (${e}) removed`)):this.editor.setStatus("<span style='color: red'>Remove instrument canceled</span>")}setTrackerChangeGroup(t,e=null){const o=this.editor.trackerElm;e=e||t.target.form.getAttribute("data-group"),o.groupName=e}setTrackerOctave(t){const e=this.editor.trackerElm;this.editor.status.currentOctave=parseInt(e.fieldTrackerOctave.value)}setTrackerRowLength(t){const e=this.editor.trackerElm;let o=e.getSelectedIndicies();this.rowLengthInTicks=e.fieldTrackerRowLength.value,e.renderRows(),e.selectIndicies(t,o)}setTrackerRowSegment(t){const e=this.editor.trackerElm;this.currentRowSegmentID=parseInt(form.elements.id.value),e.renderRows(),e.selectNextCell(),e.querySelector(`asctr-segment[id="${this.currentRowSegmentID}"]`).focus()}setTrackerFilterInstrument(t){const e=this.editor.trackerElm;let o=e.getSelectedIndicies();e.renderRows(),e.selectIndicies(t,o)}setTrackerSelection(t,e=null){const o=this.editor.trackerElm;e||(e=o.fieldSelectedIndicies.value.split(/\D+/).map(t=>parseInt(t))),o.selectIndicies(t,e),o.fieldSelectedIndicies.focus()}togglePanelInstrument(t){}togglePanelTracker(t){}togglePanelSong(t){}toggleFullscreen(t){}}class AudioSourceComposerForm extends HTMLElement{constructor(t=null,e=null){super(),null!==t&&this.setAttribute("key",t),null===e&&this.hasAttribute("caption")&&(e=this.getAttribute("caption"),this.removeAttribute("caption")),this.caption=e}get caption(){const t=this.querySelector(".header");return t?t.innerText:null}set caption(t){let e=this.querySelector(".header");t||"0"===t?(e||((e=document.createElement("div")).classList.add("header"),this.prepend(e)),e.innerHTML=t):e&&e.parentNode.removeChild(e)}get parentForm(){return this.parentNode.closest("asui-form")}get key(){return this.getAttribute("key")}get editor(){return this.closest("audio-source-composer")||this.getRootNode().host}clearInputs(){const t=this.caption;this.innerHTML="",this.caption=t}getInput(t,e=!0){const n=this.querySelector(`[key="${t}"]`);if(n)return n;if(e)throw new Error("Input key not found: "+t);return null}getOrCreateForm(t,e=null){let n=this.getInput(t,!1);if(n?null!==e&&(n.caption=e):n=this.addForm(t,e),!n instanceof AudioSourceComposerForm)throw new Error("Input is not a form: "+t);return n}getForm(t){if(!this.getInput(t)instanceof AudioSourceComposerForm)throw new Error("Input is not a form: "+t);return t}addInput(t){if(!t.hasAttribute("key"))throw new Error("Form Inputs require a key attribute");return this.appendChild(t),t}addForm(t,e=null){return this.addInput(new AudioSourceComposerForm(t,e))}addGrid(t){return this.addInput(new AudioSourceComposerGrid(t))}addBreak(t="break"){return this.addText(t,"<br/>")}addText(t,e=null){return this.addInput(new AudioSourceComposerFormText(t,e))}addButton(t,e,n,r=null){return this.addInput(new AudioSourceComposerFormButton(t,e,n,r))}addIconButton(t,e,n,r=null){const u=new AudioSourceComposerFormIcon(null,n);return this.addInput(new AudioSourceComposerFormButton(t,e,u,r))}addSelectInput(t,e,n,r=null,u=null){return this.addInput(new AudioSourceComposerFormSelect(t,e,n,r,u))}addRangeInput(t,e,n=1,r=100,u=null,o=null){return this.addInput(new AudioSourceComposerFormRangeInput(t,e,n,r,u,o))}addTextInput(t,e,n=null,r="",u=null){return this.addInput(new AudioSourceComposerFormInputText(t,e,n,r,u))}addCheckBoxInput(t,e,n=null,r=!1){return this.addInput(new AudioSourceComposerFormInputCheckBox(t,e,n,r))}addFileInput(t,e,n,r=null,u=null){return this.addInput(new AudioSourceComposerFormFileInput(t,e,n,r,u))}}customElements.define("asui-form",AudioSourceComposerForm);class AudioSourceComposerGrid extends HTMLElement{constructor(t=null){super(),null!==t&&this.setAttribute("key",t)}get parentForm(){return this.parentNode.closest("asui-form")}get key(){return this.getAttribute("key")}get editor(){return this.closest("audio-source-composer")||this.getRootNode().host}clearInputs(){this.innerHTML=""}getInput(t,e,n=!0){const r=this.getOrCreateRow(t).querySelector(`[key="${e}"]`);if(r)return r;if(n)throw new Error("Input key not found: "+e);return null}getOrCreateRow(t){let e=this.querySelector(`asuig-row[key="${t}"]`);return e||(e=new AudioSourceComposerGridRow(t),this.appendChild(e)),e}addInput(t,e){if(!e.hasAttribute("key"))throw new Error("Form Inputs require a key attribute");return this.getOrCreateRow(t).addInput(e),e}addText(t,e,n=null){return this.getOrCreateRow(t).addText(e,n)}addButton(t,e,n,r,u=null){return this.getOrCreateRow(t).addButton(e,n,r,u)}addIconButton(t,e,n,r,u=null){return this.getOrCreateRow(t).addIconButton(e,n,r,tit)}addSelectInput(t,e,n,r,u=null,o=null){return this.getOrCreateRow(t).addSelectInput(e,n,r,u,o)}addRangeInput(t,e,n,r=1,u=100,o=null,s=null){return this.getOrCreateRow(t).addRangeInput(t,e,n,r,u,o,s)}addTextInput(t,e,n,r=null,u="",o=null){return this.getOrCreateRow(t).addTextInput(t,e,n,r,u,o)}addCheckBoxInput(t,e,n,r=null,u=!1){return this.getOrCreateRow(t).addCheckBoxInput(t,e,n,r,u)}addFileInput(t,e,n,r,u=null,o=null){return this.getOrCreateRow(t).addFileInput(t,e,n,r,u,o)}}customElements.define("asui-grid",AudioSourceComposerGrid);class AudioSourceComposerGridRow extends HTMLElement{constructor(t=null){super(),null!==t&&this.setAttribute("key",t)}get grid(){return this.parentNode}get key(){return this.getAttribute("key")}clearInputs(){this.innerHTML=""}getInput(t,e=!0){const n=this.querySelector(`[key="${t}"]`);if(n)return n;if(e)throw new Error("Input key not found: "+t);return null}addInput(t){if(!t.hasAttribute("key"))throw new Error("Form Inputs require a key attribute");return this.appendChild(t),t}addText(t,e=null){return this.addInput(new AudioSourceComposerFormText(t,e))}addButton(t,e,n,r=null){return this.addInput(new AudioSourceComposerFormButton(t,e,n,r))}addIconButton(t,e,n,r=null){const u=new AudioSourceComposerFormIcon(null,n);return this.addInput(new AudioSourceComposerFormButton(t,e,u,r))}addSelectInput(t,e,n,r=null,u=null){return this.addInput(new AudioSourceComposerFormSelect(t,e,n,r,u))}addRangeInput(t,e,n=1,r=100,u=null,o=null){return this.addInput(new AudioSourceComposerFormRangeInput(t,e,n,r,u,o))}addTextInput(t,e,n=null,r="",u=null){return this.addInput(new AudioSourceComposerFormInputText(t,e,n,r,u))}addCheckBoxInput(t,e,n=null,r=!1){return this.addInput(new AudioSourceComposerFormInputCheckBox(t,e,null,r))}addFileInput(t,e,n,r=null,u=null){return this.addInput(new AudioSourceComposerFormFileInput(t,e,n,r,u))}}customElements.define("asuig-row",AudioSourceComposerGridRow);class AudioSourceComposerPanelInputAbstract extends HTMLElement{constructor(t,e){super(),this.listeners=[],this.callback=e||function(){console.warn("No callback set")},this.setAttribute("key",t)}get key(){return this.getAttribute("key")}get inputElm(){throw new Error("Not implemented")}get disabled(){return this.inputElm.disabled}set disabled(t){this.inputElm.disabled=t}get value(){return this.inputElm.value}set value(t){this.inputElm.value=t}addEventListener(t,e,n){this.listeners.push([t,e,n])}connectedCallback(){this.listeners.forEach(t=>this.inputElm.addEventListener(t[0],t[1],t[2]))}disconnectedCallback(){this.listeners.forEach(t=>this.inputElm.removeEventListener(t[0],t[1]))}}class AudioSourceComposerFormButton extends AudioSourceComposerPanelInputAbstract{constructor(t,e=null,n=null,r=null){super(t,e),this.setAttribute("key",t);const u=document.createElement("button");u.classList.add("themed"),r&&u.setAttribute("title",r),n instanceof HTMLElement?u.appendChild(n):u.innerHTML=n,this.appendChild(u),this.addEventListener("click",t=>this.onClick(t))}get inputElm(){return this.querySelector("button")}onClick(t){this.callback(t,this.value)}}customElements.define("asui-input-button",AudioSourceComposerFormButton);class AudioSourceComposerFormSelect extends AudioSourceComposerPanelInputAbstract{constructor(t,e=null,n=null,r=null,u=null){super(t,e),this.optionsCallback=n||function(){throw new Error("No options callback set")},this.setAttribute("key",t);const o=document.createElement("select");o.classList.add("themed"),r&&o.setAttribute("title",r),this.appendChild(o);try{this.value=null===u?"":u}catch(t){console.warn(t.message,this)}this.addEventListener("focus",t=>this.renderOptions(t)),this.addEventListener("change",t=>this.onChange(t))}get inputElm(){return this.querySelector("select")}get value(){const t=this.inputElm.value;let e=!1;return this.eachOption((n,r)=>{n+""===t&&(e={value:n,title:r})}),e?e.value:null}set value(t){let e=!1;if(this.eachOption((n,r)=>{n===t&&(e={value:n,title:r})}),!e)throw new Error(`Value not found: (${typeof t}) ${t}`);this.addOrSetValue(e.value,e.title)}eachOption(t,e=null){e=e||function(){},this.optionsCallback((e,n=null)=>t(e,n=null!==n?n:e),e)}addOrSetValue(t,e=null){const n=this.inputElm;let r=n.querySelector(`option[value="${t}"]`);r||(e||this.eachOption((n,r)=>{n===t&&(e=r)}),(r=document.createElement("option")).setAttribute("value",t),r.innerText=e||"Unknown value",n.prepend(r)),r.selected=!0}onChange(t){this.callback(t,this.value)}renderOptions(){const t=this.inputElm;let e=t.options[t.selectedIndex];t.innerHTML="";let n=t;this.eachOption((t,r)=>{let u=document.createElement("option");e&&t+""===e.value?(u=e,e=null):(u.setAttribute("value",t),u.innerText=r),n.appendChild(u)},e=>{null!==e?((n=document.createElement("optgroup")).setAttribute("label",e),t.appendChild(n)):n=t}),e&&t.prepend(e)}}customElements.define("asui-input-select",AudioSourceComposerFormSelect);class AudioSourceComposerFormRangeInput extends AudioSourceComposerPanelInputAbstract{constructor(t,e=null,n=1,r=100,u=null,o=null){super(t,e),this.setAttribute("key",t);const s=document.createElement("input");s.classList.add("themed"),s.setAttribute("type","range"),s.setAttribute("min",n+""),s.setAttribute("max",r+""),null!==o&&s.setAttribute("value",o),null!==u&&s.setAttribute("title",u),this.appendChild(s),this.addEventListener("change",t=>this.onChange(t))}get inputElm(){return this.querySelector("input")}get value(){return parseInt(this.inputElm.value)}set value(t){this.inputElm.value=t}onChange(t){this.callback(t,this.value)}}customElements.define("asui-input-range",AudioSourceComposerFormRangeInput);class AudioSourceComposerFormInputText extends AudioSourceComposerPanelInputAbstract{constructor(t,e=null,n=null,r=null,u=null){super(t,e),this.setAttribute("key",t);const o=document.createElement("input");o.classList.add("themed"),o.setAttribute("type","text"),n&&o.setAttribute("title",n),r&&o.setAttribute("value",r),u&&o.setAttribute("placeholder",u),this.appendChild(o),this.addEventListener("change",t=>this.onChange(t))}get inputElm(){return this.querySelector("input")}onChange(t){this.callback(t,this.value)}}customElements.define("asui-input-text",AudioSourceComposerFormInputText);class AudioSourceComposerFormInputCheckBox extends AudioSourceComposerPanelInputAbstract{constructor(t,e=null,n=null,r=!1){super(t,e),this.setAttribute("key",t);const u=document.createElement("input");u.classList.add("themed"),u.setAttribute("type","checkbox"),n&&u.setAttribute("title",n),r&&(u.checked=r),this.appendChild(u),this.addEventListener("change",t=>this.onChange(t))}get inputElm(){return this.querySelector("input")}get checked(){return this.inputElm.checked}onChange(t){this.callback(t,this.checked)}}customElements.define("asui-input-checkbox",AudioSourceComposerFormInputCheckBox);class AudioSourceComposerFormFileInput extends AudioSourceComposerPanelInputAbstract{constructor(t,e,n,r=null,u=null){super(t,e),this.setAttribute("key",t);const o=document.createElement("label");this.appendChild(o),o.innerHTML=n;const s=document.createElement("input");s.classList.add("themed"),s.setAttribute("type","file"),s.setAttribute("style","display: none;"),r&&s.setAttribute("accepts",r),u&&s.setAttribute("title",u),o.appendChild(s)}get inputElm(){return this.querySelector("input")}connectedCallback(){this.addEventListener("change",t=>this.onChange(t))}onChange(t){this.callback(t,this.value)}}customElements.define("asui-input-file",AudioSourceComposerFormFileInput);class AudioSourceComposerFormText extends HTMLElement{constructor(t,e){super(),null!==t&&this.setAttribute("key",t),this.innerHTML=e}get key(){return this.getAttribute("key")}}customElements.define("asui-text",AudioSourceComposerFormText);class AudioSourceComposerFormIcon extends HTMLElement{constructor(t,e){super(),null!==t&&this.setAttribute("key",t),this.classList.add(e)}get key(){return this.getAttribute("key")}}customElements.define("asui-icon",AudioSourceComposerFormIcon);class AudioSourceValues{constructor(e=null){this.song=e}get noteFrequencies(){return["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"]}get valueTypes(){return["beats-per-measure","beats-per-minute","command-group-execute","command-instrument-frequencies","durations","groups","instruments-available","named-durations","note-frequencies","note-frequencies-all","note-frequency-octaves","song-groups","song-instruments","song-recent-list","velocities"]}getValues(e,t){let s,n=null;const r=e=>{null!=e&&r(e)},o=this.song?this.song.data:null,a=this.song?this.song.timeDivision:384;switch(e){case"song-recent-list":break;case"song-instruments":if(this.song&&o.instruments){const e=o.instruments;for(let s=0;s<e.length;s++){const o=e[s]||{name:"No Instrument Loaded"};n=t(s,this.format(s,"instrument")+": "+(o.name?o.name:o.url.split("/").pop())),r(n)}}break;case"instruments-available":const u=(new AudioSourceLibraries).getInstrumentLibrary(!1);u&&u.instruments&&u.instruments.forEach(e=>{let s=e.url;s&&(s=new URL(s,u.url)+""),"object"!=typeof e&&(e={url:e}),e.title||(e.title=e.url.split("/").pop()),n=t(s,e.title)});break;case"command-instrument-frequencies":if(o)for(let e=0;e<o.instruments.length;e++)if(this.song.isInstrumentLoaded(e)){const s=this.song.getInstrument(e);if(s.getFrequencyAliases){const o=s.getFrequencyAliases();Object.values(o).forEach(s=>n=t(s,s,`data-instrument="${e}"`)),r(n)}}break;case"note-frequencies":s=this.noteFrequencies;for(let e=0;e<s.length;e++){const o=s[e];n=t(o,o),r(n)}break;case"note-frequencies-all":s=this.noteFrequencies;for(let e=1;e<=6;e++)for(let o=0;o<s.length;o++){const a=s[o]+e;n=t(a,a),r(n)}break;case"note-frequency-octaves":for(let e=1;e<=7;e+=1)n=t(e,""+e),r(n);break;case"velocities":for(let e=100;e>=0;e-=10)n=t(e,e),r(n);break;case"durations":for(let e=64;e>1;e/=2){let s=`1/${e}`;n=t(1/e/1.5*a,`${s}t`),r(n),n=t(1/e*a,`${s}`),r(n),n=t(1/e*1.5*a,`${s}d`),r(n)}for(let e=1;e<=16;e++)n=t(e*a,e+"B"),r(n);break;case"named-durations":for(let e=64;e>1;e/=2){let s=`1/${e}`;n=t(`${s}t`,`${s}t`),r(n),n=t(`${s}`,`${s}`),r(n),n=t(`${s}d`,`${s}d`),r(n)}for(let e=1;e<=16;e++)n=t(e+"B",e+"B"),r(n);break;case"beats-per-measure":for(let e=1;e<=12;e++)n=t(e,e+` beat${e>1?"s":""} per measure`),r(n);break;case"beats-per-minute":for(let e=40;e<=300;e+=10)n=t(e,e+` beat${e>1?"s":""} per minute`),r(n);break;case"song-groups":case"groups":o&&o.instructions&&Object.keys(o.instructions).forEach(function(e,s){n=t(e,e),r(n)});break;case"command-group-execute":o&&o.instructions&&Object.keys(o.instructions).forEach(function(e,s){n=t("@"+e,"@"+e),r(n)});break;default:throw new Error("Invalid Value type: "+e)}return[]}renderEditorFormOptions(e,t){let s="";return this.getValues(e,function(e,n,r=""){const o=!!t&&t(e);s+=`<option value="${e}" ${o?' selected="selected"':""}${r}>${n}</option>`}),s}format(e,t){switch(t){case"duration":let s;return this.getValues("durations",(t,n)=>{e!==t&&e!==n||(s=n)}),s?s:(e=parseFloat(e).toFixed(2)).replace(".00","t");case"instrument":return"number"!=typeof e?"N/A":e<10?"0"+e:""+e;case"velocity":return"number"!=typeof e?"N/A":100===e?"Max":e+"";case"command":return e;default:throw new Error("Unknown format: "+t)}}}"undefined"!=typeof module&&(module.exports={AudioSourceValues:AudioSourceValues});class AudioSourceLibraries{constructor(){this.instrumentLibrary=null}get sources(){return{MidiParser:[this.getScriptDirectory("assets/3rdparty/MidiParser/main.js"),"https://cdn.jsdelivr.net/gh/colxi/midi-parser-js/src/main.js"],LZString:[this.getScriptDirectory("assets/3rdparty/LZString/lz-string.min.js"),"https://cdn.jsdelivr.net/gh/pieroxy/lz-string/libs/lz-string.min.js"]}}async loadJSLibrary(r,i=null){if(i||(i=(()=>void 0!==window[r])),i())return!0;const e=this.sources[r];for(let r=0;r<e.length;r++)if(await this.loadScript(e[r]),i())return!0;throw new Error(`Failed to load ${r} Library`)}async getMidiParser(){return void 0===window.MidiParser&&await this.loadJSLibrary("MidiParser"),window.MidiParser}async getLZString(){return void 0===window.LZString&&await this.loadJSLibrary("LZString"),window.LZString}getInstrumentLibrary(r=!0){if(!AudioSourceLibraries.instrumentLibrary&&r)throw new Error("Instrument library not available");return AudioSourceLibraries.instrumentLibrary}async loadInstrumentLibrary(r,i=!1){if(!r)throw new Error("Invalid url");r=new URL(r,document.location)+"";let e=AudioSourceLibraries.instrumentLibrary;return!i&&e&&e.url===r?e:((e=await this.loadJSON(r)).url=r+"",console.info("Instrument Library Loaded: ",e),AudioSourceLibraries.instrumentLibrary=e,e)}async loadPackageInfo(r=!1){const i=(new AudioSourceLibraries).getScriptDirectory("package.json");let e=AudioSourceLibraries.packageInfo;if(!r&&e)return e;if(!(e=await this.loadJSON(i)).version)throw new Error("Invalid package version: "+i);return console.log("Package Version: ",e.version,e),AudioSourceLibraries.packageInfo=e,e}getScriptElement(){return document.head.querySelector('script[src$="audio-source-composer-element.js"],script[src$="audio-source-composer.min.js"]')}getScriptDirectory(r=""){return this.getScriptElement().src.split("/").slice(0,-2).join("/")+"/"+r}async loadScript(r){await new Promise((i,e)=>{const t=document.createElement("script");t.src=r,t.onload=(r=>i()),document.head.appendChild(t)})}async loadJSON(r){return r=new URL(r,document.location)+"",new Promise((i,e)=>{const t=new XMLHttpRequest;t.open("GET",r,!0),t.responseType="json",t.onload=(()=>{if(200!==t.status)return e("JSON file not found: "+r);i(t.response)}),t.send()})}}AudioSourceLibraries.instrumentLibrary=null,AudioSourceLibraries.packageInfo=null,"undefined"!=typeof module&&(module.exports={AudioSourceLibraries:AudioSourceLibraries});class AudioSourceSong{constructor(t={},n=null){this.dispatchElement=n,this.audioContext=null,this.instruments={loaded:[],class:{},classPromises:{},promises:{}},this.seekLength=.5,this.playbackPosition=0,this.volumeGain=null,this.activeGroups={},this.data=null,this.loadSongData(t),this.history=[],"undefined"!=typeof document&&document.addEventListener("instrument:loaded",t=>this.onSongEvent(t))}dispatchEvent(t){this.dispatchElement&&this.dispatchElement.dispatchEvent(t)}getAudioContext(){if(this.audioContext)return this.audioContext;this.audioContext=new(window.AudioContext||window.webkitAudioContext);this.audioContext.createGain();return this.audioContext}get timeDivision(){return this.data.timeDivision}get startingBeatsPerMinute(){return this.data.beatsPerMinute}get rootGroup(){return this.data.root}getVolumeGain(){if(!this.volumeGain){const t=this.getAudioContext();let n=t.createGain();n.gain.value=AudioSourceSong.DEFAULT_VOLUME,n.connect(t.destination),this.volumeGain=n}return this.volumeGain}getVolumeValue(){return this.volumeGain?100*this.volumeGain.gain.value:100*AudioSourceSong.DEFAULT_VOLUME}setVolume(t){const n=this.getVolumeGain();n.gain.value!==t&&(n.gain.value=t/100,console.info("Setting volume: ",t))}async loadSongData(t,n=null){t=Object.assign({},{name:this.generateName(),guid:this.generateGUID(),version:"0.0.1",root:"root",created:(new Date).getTime(),timeDivision:384,beatsPerMinute:120,beatsPerMeasure:4,instruments:[],instructions:{root:[]}},t),this.data=t,Object.keys(t.instructions).map((t,n)=>this.processAllInstructionData(t)),0===t.instruments.length&&console.warn("Song contains no instruments"),await this.loadAllInstruments(),this.dispatchEvent(new CustomEvent("song:loaded",{detail:this}))}loadSongHistory(t){this.history=t}processAllInstructionData(t){const n=this.data.instructions[t];for(let t=0;t<n.length;t++){const i=n[t];n[t]=this.processInstructionData(i)}}processInstructionData(t){return SongInstruction.parse(t).data}getInstructions(t,n=null){let i=this.data.instructions[t];if(!i)throw new Error("Instruction group not found: "+t);return n&&("number"==typeof n&&(n=[n]),i=i.filter((t,i)=>-1!==n.indexOf(i))),i.map(t=>new SongInstruction(t))}getInstructionIndex(t,n){n instanceof SongInstruction&&(n=n.data);const i=this.data.instructions[t].indexOf(n);if(-1===i)throw new Error("Instruction not found in instruction list");return i}getInstruction(t,n,i=!0){let e=this.data.instructions[t];if(!Number.isInteger(n)){if(i)throw new Error("Invalid Index: "+typeof n);return null}if(n>=e.length){if(i)throw new Error(`Instruction index is greater than group length: ${n} >= ${e.length} for groupName: ${t}`);return null}if(!e[n]){if(i)throw new Error(`Instruction not found at index: ${n} for groupName: ${t}`);return null}return new SongInstruction(e[n],n)}getIterator(t,n=null){return new AudioSourceInstructionIterator(this,t,n?n.currentBPM:this.startingBeatsPerMinute,n?n.groupPositionInTicks:0)}eachInstruction(t,n,i=null){if(!this.data.instructions[t])throw new Error("Invalid group: "+t);const e=this.getIterator(t,i);let r=e.nextInstruction();for(;r;){if(!1===n(e.groupIndex,r,e))break;r=e.nextInstruction()}return e.groupPlaybackTime}getSongLength(){return this.getGroupLength(this.rootGroup)}getGroupLength(t){const n=this.getIterator(t);let i;for(;i=n.nextInstruction(););return n.groupPlaybackTime}getSongPositionFromTicks(t){return this.getGroupPositionFromTicks(this.rootGroup,t)}getGroupPositionFromTicks(t,n){let i=null;if(this.eachInstruction(t,(t,e,r)=>{if(i=r,r.groupPositionInTicks>=n)return!1}),!i)return 0;let e=i.groupPlaybackTime;if(n>i.groupPositionInTicks){const t=n-i.groupPositionInTicks;e+=this.ticksToSeconds(t,i.currentBPM)}else if(n<i.groupPositionInTicks){const t=i.groupPositionInTicks-n;e-=this.ticksToSeconds(t,i.currentBPM)}return e}getSongPositionInTicks(t){return this.getGroupPositionInTicks(this.rootGroup,t)}getGroupPositionInTicks(t,n){let i=null;if(this.eachInstruction(t,(t,e,r)=>{if(i=r,r.groupPlaybackTime>=n)return!1}),!i)return 0;let e=i.groupPositionInTicks;if(n>i.groupPlaybackTime){const t=n-i.groupPlaybackTime;e+=this.secondsToTicks(t,i.currentBPM)}else if(n<i.groupPlaybackTime){const t=i.groupPlaybackTime-n;e-=this.secondsToTicks(t,i.currentBPM)}return e}ticksToSeconds(t,n){return t/this.timeDivision*(60/n)}secondsToTicks(t,n){return Math.round(t*this.timeDivision/(60/n))}async play(){if(this.playback)throw new Error("Song is already playing");await this.initAllInstruments(this.getAudioContext()),this.playback=new AudioSourceInstructionPlayback(this,this.rootGroup,this.playbackPosition),console.log("Start playback:",this.playbackPosition);const t=this.playback.playGroup();this.dispatchEvent(new CustomEvent("song:play",{detail:{playback:this.playback,promise:t}})),await t,this.dispatchEvent(new CustomEvent("song:end",{detail:{playback:this.playback}})),this.playback&&this.stopPlayback(),console.log("End playback:",this.playbackPosition)}stopPlayback(){if(!this.playback)throw new Error("Playback is already stopped");this.playback.stopPlayback(),this.playback=null}get isPlaying(){return!!this.playback}get songPlaybackPosition(){return this.playback?this.getAudioContext().currentTime-this.playback.startTime:this.playbackPosition}setPlaybackPositionInTicks(t){if(!Number.isInteger(t))throw new Error("Invalid start position in ticks");const n=this.getSongPositionFromTicks(t);return this.setPlaybackPosition(n)}setPlaybackPosition(t){if(t=parseFloat(t),Number.isNaN(t))throw new Error("Invalid start position");this.playbackPosition=t;const n=this.getSongPositionInTicks(this.playbackPosition);console.log("Seek position: ",this.playbackPosition,n);const i={position:this.playbackPosition,positionInTicks:n};this.dispatchEvent(new CustomEvent("song:seek",{detail:i}))}isPlaybackActive(){for(const t in this.activeGroups)if(this.activeGroups.hasOwnProperty(t)&&!0===this.activeGroups[t])return!0;return!1}playInstructionAtIndex(t,n,i=null){const e=this.getInstruction(t,n,!1);e?this.playInstruction(e,i):console.warn("No instruction at index")}async playInstruction(t,n=null){if(!t instanceof SongInstruction)throw new Error("Invalid instruction");if(t.isGroupCommand())return this.playback&&this.playback.stopPlayback(),this.playback=new AudioSourceInstructionPlayback(this),await this.playback.playInstructions(t.getGroupFromCommand(),n);let i=this.startingBeatsPerMinute,e=this.timeDivision;const r=t.getDurationAsTicks(e)/e/(i/60);let s=this.getAudioContext().currentTime;n||0===n||(n=s),this.playInstrument(t.instrument,t.command,n,r,t.velocity),n>s&&(setTimeout(()=>{this.dispatchEvent(new CustomEvent("note:start",{detail:{instruction:t}}))},1e3*(n-this.getAudioContext().currentTime)),r&&setTimeout(()=>{this.dispatchEvent(new CustomEvent("note:end",{detail:{instruction:t}}))},1e3*(n+r-this.getAudioContext().currentTime)))}onSongEvent(t){switch(console.log(t.type),t.type){case"instrument:loaded":const n=t.detail.class,i=t.detail.url;this.instruments.class[i]=n,this.loadAllInstruments()}}isInstrumentLoaded(t){return!!this.instruments.loaded[t]}async playInstrument(t,n,i,e,r){if(t||0===t||(console.warn("No instrument set for instruction. Using instrument 0"),t=0),!this.data.instruments[t])return void console.error(`Instrument ${t} is not loaded. Playback skipped. `);let s=this.getInstrument(t);const o=this.getVolumeGain();return await s.play(o,n,i,e,r)}getInstrumentConfig(t,n=!0){const i=this.getInstrumentList();if(i[t])return i[t];if(n)throw new Error("Instrument ID not found: "+t);return null}getInstrument(t,n=!0){if(this.instruments.loaded[t])return this.instruments.loaded[t];if(n)throw new Error("Instrument not yet loaded: "+t);return null}getInstrumentList(){return this.data.instruments.slice()}async loadInstrumentClass(t){t=new URL(t)+"";let n=this.instruments.class[t];if(n)return n;const i=document.createElement("script");i.src=t;const e=new Promise((n,e)=>{i.onload=n,i.onerror=(n=>{i.parentNode.removeChild(i),e("Error loading: "+t)})});if(document.head.appendChild(i),await e,!this.instruments.class[t])throw new Error("Failed to load instrument class: "+t);return this.instruments.class[t]}async loadInstrument(t,n=!1){if(t=parseInt(t),!n&&this.instruments.loaded[t])return!0;this.instruments.loaded[t]=null;const i=this.getInstrumentConfig(t);if(!i.url)throw new Error("Invalid instrument URL");let e=new URL(i.url,document.location.origin);const r=new(await this.loadInstrumentClass(e))(i,this,t);return this.instruments.loaded[t]=r,this.dispatchEvent(new CustomEvent("instrument:instance",{detail:{instance:r,instrumentID:t},bubbles:!0})),this.audioContext&&await this.initInstrument(t,this.audioContext),!0}async loadAllInstruments(){const t=this.getInstrumentList();for(let n=0;n<t.length;n++)t[n]&&(console.info("Loading instrument: "+n,t[n]),await this.loadInstrument(n))}async initInstrument(t,n){const i=this.getInstrument(t);await i.init(n)}async initAllInstruments(t){console.time("initAllInstruments");const n=this.getInstrumentList();for(let i=0;i<n.length;i++){const n=this.getInstrument(i,!1);n&&await n.init(t)}console.timeEnd("initAllInstruments")}getName(){return this.data.name}setName(t){return this.replaceDataPath(["name"],t)}getVersion(){return this.data.version}setVersion(t){return this.replaceDataPath(["version"],t)}addInstrument(t){if("object"!=typeof t&&(t={url:t}),!t.url)throw new Error("Invalid Instrument URL");const n=this.data.instruments.length;return this.replaceDataPath(["instruments",n],t),this.loadInstrument(n),this.dispatchEvent(new CustomEvent("instrument:modified",{bubbles:!0,detail:{instrumentID:n,config:t,oldConfig:null}}),1),n}async replaceInstrument(t,n){let i=this.data.instruments[t]||{};return"object"!=typeof n&&(n={url:n}),i&&i.name&&!n.name&&(n.name=i.name),i=this.replaceDataPath(["instruments",t],n),this.dispatchEvent(new CustomEvent("instrument:modified",{bubbles:!0,detail:{instrumentID:t,config:n,oldConfig:i}}),1),i}removeInstrument(t){if(!this.data.instruments[t])throw new Error("Invalid instrument ID: "+t);delete this.instruments.loaded[t];const n=this.deleteDataPath(["instruments",t]);return this.dispatchEvent(new CustomEvent("instrument:modified",{bubbles:!0,detail:{instrumentID:t,config:null,oldConfig:n}}),1),n}replaceInstrumentParam(t,n,i){if(t=parseInt(t),!this.data.instruments[t])throw new Error("Invalid instrument ID: "+t);return Array.isArray(n)||(n=[n]),n.unshift(t),n.unshift("instruments"),this.replaceDataPath(n,i)}deleteInstrumentParam(t,n){if(t=parseInt(t),!this.data.instruments[t])throw new Error("Invalid instrument ID: "+t);return Array.isArray(n)||(n=[n]),n.unshift(t),n.unshift("instruments"),this.deleteDataPath(n)}setInstrumentName(t,n){return this.replaceInstrumentParam(t,"name",n)}generateName(){return`Untitled (${(new Date).toJSON().slice(0,10).replace(/-/g,"/")})`}generateGUID(){var t=(new Date).getTime();return"undefined"!=typeof performance&&"function"==typeof performance.now&&(t+=performance.now()),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){var i=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"===n?i:3&i|8).toString(16)})}generateInstructionGroupName(t){const n=this.data;let i;for(let e=99;e>=0;e--){const r=t+"."+e;n.instructions.hasOwnProperty(r)||(i=r)}if(!i)throw new Error("Failed to generate group name");return i}findDataPath(t){if(!Array.isArray(t))throw new Error("Path list must be an array");if("*"===t[0])return{value:this.data,parent:{key:this.data},key:"key"};let n,i=this.data,e=null;for(let r=0;r<t.length;r++){if(e=t[r],/^\d+$/.test(e)&&(e=parseInt(e)),n=i,void 0===i)throw new Error("Invalid path key: "+e);i=i[e]}if(!n)throw new Error("Invalid path: "+t.join("."));return{value:i,parent:n,key:e}}insertDataPath(t,n){const i=this.findDataPath(t);if(n=AudioSourceSong.sanitizeInput(n),"number"!=typeof i.key)throw new Error("Insert action requires numeric key");if(i.parent.length<i.key)throw new Error(`Insert position out of index: ${i.parent.length} < ${i.key} for path: ${t}`);return i.parent.splice(i.key,0,n),this.queueHistoryAction(t,n),null}deleteDataPath(t){const n=this.findDataPath(t),i=n.parent[n.key];if("number"==typeof n.key){if(n.parent.length<n.key)throw new Error(`Delete position out of index: ${n.parent.length} < ${n.key} for path: ${t}`);n.parent.splice(n.key,1)}else delete n.parent[n.key];return this.queueHistoryAction(t,null,i),i}replaceDataPath(t,n){const i=this.findDataPath(t);if(void 0===n)return this.deleteDataPath(t);let e=null;return n=AudioSourceSong.sanitizeInput(n),void 0!==i.parent[i.key]&&(e=i.parent[i.key]),i.parent[i.key]=n,this.queueHistoryAction(t,n,e),e}queueHistoryAction(t,n=null,i=null){const e=[t];return null===n&&null===i||e.push(n),null!==i&&e.push(i),this.history.push(e),this.dispatchEvent(new CustomEvent("song:modified",{detail:e}),1),e}insertInstructionAtPosition(t,n,i){if("string"==typeof n&&(n=SongInstruction.parseDurationAsTicks(n,this.timeDivision)),!Number.isInteger(n))throw new Error("Invalid integer: "+typeof n);if(!i)throw new Error("Invalid insert instruction");const e=SongInstruction.parse(i);let r=this.data.instructions[t];const s=this.getIterator(t);let o;for(;o=s.nextInstruction();){if(s.groupPositionInTicks>n){const i=[n-(s.groupPositionInTicks-o.deltaDuration),s.groupPositionInTicks-n],r=s.groupIndex;return this.replaceInstructionDeltaDuration(t,r,i[1]),e.deltaDuration=i[0],this.insertInstructionAtIndex(t,r,e),r}if(s.groupPositionInTicks===n){let n;for(n=s.groupIndex+1;n<r.length&&!(new SongInstruction(r[n]).deltaDuration>0);n++);return e.deltaDuration=0,this.insertInstructionAtIndex(t,n,e),n}}if(s.groupPositionInTicks>=n)throw new Error("Something went wrong");let a=r.length;return e.deltaDuration=n-s.groupPositionInTicks,this.insertInstructionAtIndex(t,a,e),a}insertInstructionAtIndex(t,n,i){if(!i)throw new Error("Invalid insert instruction");i=SongInstruction.parse(i).data,this.insertDataPath(["instructions",t,n],i)}deleteInstructionAtIndex(t,n){const i=this.getInstruction(t,n);if(i.deltaDuration>0){const e=this.getInstruction(t,n+1,!1);e&&this.replaceInstructionDeltaDuration(t,n+1,e.deltaDuration+i.deltaDuration)}return this.deleteDataPath(["instructions",t,n])}replaceInstructionDeltaDuration(t,n,i){return this.replaceInstructionParam(t,n,0,i)}replaceInstructionCommand(t,n,i){return this.replaceInstructionParam(t,n,1,i)}replaceInstructionInstrument(t,n,i){return this.replaceInstructionParam(t,n,2,i)}replaceInstructionDuration(t,n,i){return this.replaceInstructionParam(t,n,3,i)}replaceInstructionVelocity(t,n,i){if(!Number.isInteger(i))throw new Error("Velocity must be an integer: "+i);if(i<0)throw new Error("Velocity must be a positive integer: "+i);return this.replaceInstructionParam(t,n,4,i)}replaceInstructionParam(t,n,i,e){return null===e?this.deleteDataPath(["instructions",t,n,i]):this.replaceDataPath(["instructions",t,n,i],e)}addInstructionGroup(t,n){if(this.data.instructions.hasOwnProperty(t))throw new Error("New group already exists: "+t);this.replaceDataPath(["instructions",t],n||[])}removeInstructionGroup(t){if("root"===t)throw new Error("Cannot remove root instruction group, n00b");if(!this.data.instructions.hasOwnProperty(t))throw new Error("Existing group not found: "+t);return this.replaceDataPath(["instructions",t])}renameInstructionGroup(t,n){if("root"===t)throw new Error("Cannot rename root instruction group, n00b");if(!this.data.instructions.hasOwnProperty(t))throw new Error("Existing group not found: "+t);if(this.data.instructions.hasOwnProperty(n))throw new Error("New group already exists: "+n);const i=this.replaceDataPath(["instructions",t]);this.replaceDataPath(["instructions",n],i)}applyHistoryActions(t){for(let n=0;n<t.length;n++){const i=t[n];switch(i.action){case"reset":Object.assign(this.data,i.data);break;case"insert":this.insertDataPath(i.path,i.data);break;case"delete":this.deleteDataPath(i.path);break;case"replace":this.replaceDataPath(i.path,i.data)}}this.history=[],this.processAllInstructionData()}static sanitizeInput(t){if(Array.isArray(t)){for(let n=0;n<t.length;n++)t[n]=AudioSourceSong.sanitizeInput(t[n]);return t}if("object"==typeof t){for(const n in t)t.hasOwnProperty(n)&&(t[n]=AudioSourceSong.sanitizeInput(t[n]));return t}if("string"!=typeof t)return t;if("undefined"!=typeof require){var n=new(require("bad-words"));if(n.isProfane(t))throw new Error("Swear words are forbidden");t=n.clean(t)}var i={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};return t.replace(/[&<>'"]/g,function(t){return i[t]})}onInput(t){t.defaultPrevented||t.type}}AudioSourceSong.DEFAULT_VOLUME=.7;class AudioSourceInstructionPlayback{constructor(t,n,i=null,e=1){i=i||t.getAudioContext().currentTime,this.song=t,this.groupName=n,this.seekLength=e,this.iterator=null,this.subGroups=[],this.startTime=i,this.quantizationInTicks=t.timeDivision}get groupPositionInTicks(){return this.iterator.groupPositionInTicks}get isPlaybackActive(){return!!this.iterator}async playGroup(){const t=this.song.getIterator(this.groupName);for(this.iterator=t,this.song.dispatchEvent(new CustomEvent("group:play",{detail:{playback:this,iterator:t}}));this.isPlaybackActive;)await this.playNextInstructionRow();this.song.dispatchEvent(new CustomEvent("group:end",{detail:{playback:this,iterator:t}}));let n=this.song.getAudioContext().currentTime-this.startTime;console.info("Group finished: ",this.groupName,n)}stopPlayback(t=!0){this.subGroups.forEach(n=>n.stopPlayback(t));const n=this.iterator;if(this.iterator=null,this.song.dispatchEvent(new CustomEvent("group:stop",{detail:{playback:this,iterator:n}})),t){const t=this.song.getInstrumentList();for(let n=0;n<t.length;n++){const t=this.song.getInstrument(n,!1);t&&t.stopPlayback&&t.stopPlayback()}}}async playNextInstructionRow(){if(!this.isPlaybackActive)throw new Error("Playback is not active");const t=this.iterator.nextInstructionQuantizedRow(this.quantizationInTicks);if(this.iterator.hasReachedEnd)return this.stopPlayback(!1),0;const n=this.song.getAudioContext(),i=this.startTime+this.iterator.groupPlaybackTime,e=i-n.currentTime;if(e>0&&await new Promise((t,n)=>setTimeout(t,1e3*e)),!this.isPlaybackActive)return;for(let n=0;n<t.length;n++){const e=t[n];if(e.isGroupCommand()){let t=e.getGroupFromCommand();if(t===this.iterator.groupName)return void console.error("Recursive group call. Skipping group '"+t+"'");const n=new AudioSourceInstructionPlayback(this.song,t,i);this.subGroups.push(n),n.playGroup()}else this.song.playInstruction(e,i)}const r={position:this.iterator.groupPlaybackTime,positionInTicks:this.iterator.groupPositionInTicks};this.song.dispatchEvent(new CustomEvent("group:seek",{detail:r}))}}class AudioSourceInstructionIterator{constructor(t,n,i=null,e=0){if(!t.data.instructions[n])throw new Error("Song group not found: "+n);this.song=t,this.groupName=n,this.currentBPM=i||t.startingBeatsPerMinute,this.groupPositionInTicks=e,this.lastInstructionGroupPositionInTicks=e,this.nextQuantizationBreakInTicks=0,this.groupPlaybackTime=0,this.groupIndex=-1}get hasReachedEnd(){return this.groupIndex>=this.instructionList.length}get instructionList(){return this.song.data.instructions[this.groupName]}getInstruction(t,n=!0){const i=this.instructionList[t];if(!i){if(n)throw new Error("");return null}const e=new SongInstruction(i);return e.index=t,e.positionInTicks=this.groupPositionInTicks,e}currentInstruction(){const t=-1===this.groupIndex?0:this.groupIndex;return this.getInstruction(t,!1)}nextInstruction(){if(this.groupIndex++,!this.instructionList[this.groupIndex])return null;const t=this.instructionList[this.groupIndex],n=new SongInstruction(t);if(n.deltaDuration){this.groupPositionInTicks=this.lastInstructionGroupPositionInTicks+n.deltaDuration,this.lastInstructionGroupPositionInTicks=this.groupPositionInTicks;const t=n.deltaDuration/this.song.timeDivision/(this.currentBPM/60);this.groupPlaybackTime+=t}return this.getInstruction(this.groupIndex)}nextInstructionRow(t=null){let n=this.nextInstruction();if(!n)return null;let i=[];for(n&&i.push(n);;){let t=this.getInstruction(this.groupIndex+1,!1);if(!t)break;if(t.deltaDuration)break;t=this.nextInstruction(),i.push(t)}return null!==t&&(i=i.filter(n=>n.instrument===t)),i}nextInstructionQuantizedRow(t,n=null){let i=this.getInstruction(this.groupIndex+1,!1);if(!i)return null;let e=this.lastInstructionGroupPositionInTicks+i.deltaDuration;if(-1!==this.groupIndex)for(;this.nextQuantizationBreakInTicks<=this.groupPositionInTicks;)this.nextQuantizationBreakInTicks+=t;if(e>this.nextQuantizationBreakInTicks){const n=this.nextQuantizationBreakInTicks-this.groupPositionInTicks;this.groupPositionInTicks=this.nextQuantizationBreakInTicks;const i=n/this.song.timeDivision/(this.currentBPM/60);return this.groupPlaybackTime+=i,this.nextQuantizationBreakInTicks+=t,[]}return this.nextInstructionRow(n)}*[Symbol.iterator](){let t;for(;t=this.nextInstruction();)yield t}}class SongInstruction{constructor(t,n=null,i=null){this.data=t||[0,"",0],this.index=n,this.positionInTicks=i}get deltaDuration(){return this.data[0]}set deltaDuration(t){this.data[0]=SongInstruction.parseDurationAsTicks(t)}get command(){return this.data[1]||null}set command(t){this.data[1]=t}get instrument(){return void 0===this.data[2]?null:this.data[2]}set instrument(t){if(t=parseInt(t),Number.isNaN(t))throw new Error("Invalid Instrument ID");this.data[2]=t}get duration(){return void 0===this.data[3]?null:this.data[3]}set duration(t){if(t=parseFloat(t),Number.isNaN(t))throw new Error("Invalid Duration");this.data[3]=t}getDurationAsTicks(t){return SongInstruction.parseDurationAsTicks(this.duration,t)}get velocity(){return void 0===this.data[4]?null:this.data[4]}set velocity(t){if(t=parseInt(t),Number.isNaN(t))throw new Error("Invalid Velocity");this.data[4]=t}get panning(){return void 0===this.data[5]?null:this.data[5]}set panning(t){if(t=parseInt(t),Number.isNaN(t))throw new Error("Invalid Panning");this.data[5]=t}isGroupCommand(){return this.command&&"@"===this.command[0]}getGroupFromCommand(){return this.command.substr(1)}static parse(t){return t instanceof SongInstruction?t:("number"==typeof t?t=[t]:"string"==typeof t&&(t=t.split(":")).length>=2&&(t[1]=parseInt(t[1])),"string"==typeof t[0]&&t.unshift(0),new SongInstruction(t))}static parseDurationAsTicks(t,n){if(null===t||"number"==typeof t)return t;switch(t[t.length-1].toLowerCase()){case"t":return parseInt(t.substr(0,t.length-1));case"b":return n*parseFloat(t.substr(0,t.length-1))}throw new Error("Invalid Duration: "+t)}}if("undefined"!=typeof module&&(module.exports={AudioSourceSong:AudioSourceSong,AudioSourceInstructionIterator:AudioSourceInstructionIterator,AudioSourceInstructionPlayback:AudioSourceInstructionPlayback}),"undefined"!=typeof global&&void 0===global.CustomEvent){class t{constructor(t,n){}}global.CustomEvent=t}class AudioSourceStorage{constructor(){}async getRecentSongList(){return await this.decodeForStorage(localStorage.getItem("song-recent-list")||"[]")}generateName(){return`Untitled (${(new Date).toJSON().slice(0,10).replace(/-/g,"/")})`}generateGUID(){var e=(new Date).getTime();return"undefined"!=typeof performance&&"function"==typeof performance.now&&(e+=performance.now()),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var o=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?o:3&o|8).toString(16)})}generateDefaultSong(e=null){const t={name:this.generateName(),guid:this.generateGUID(),version:"0.0.1",root:"root",created:(new Date).getTime(),timeDivision:384,beatsPerMinute:120,beatsPerMeasure:4,instruments:[],instructions:{root:[]}};return e&&t.instruments.push({url:e}),t}async encodeForStorage(e,t=null,o=null){let r=JSON.stringify(e,t,o);const n=new AudioSourceLibraries;return(await n.getLZString()).compress(r)}async decodeForStorage(e){if(!e)return null;const t=new AudioSourceLibraries;return e=(await t.getLZString()).decompress(e)||e,JSON.parse(e)}async saveSongToMemory(e,t){e.guid||(e.guid=this.generateGUID());let o=[];try{o=await this.decodeForStorage(localStorage.getItem("song-recent-list")||"[]")}catch(e){console.error(e)}(o=o.filter(t=>t.guid!==e.guid)).unshift({guid:e.guid,title:e.name}),localStorage.setItem("song-recent-list",await this.encodeForStorage(o)),localStorage.setItem("song:"+e.guid,await this.encodeForStorage(e)),localStorage.setItem("song-history:"+e.guid,await this.encodeForStorage(t)),console.info("Song saved to memory: "+e.guid,e)}saveSongToFile(e,t=!0){const o="/** INSTRUCTIONS-"+this.generateGUID()+" **/";let r=JSON.stringify(e.instructions),n=JSON.stringify(Object.assign({},e,{instructions:o}),null,"\t");n=n.replace('"'+o+'"',r);const a="data:text/json;charset=utf-8,"+encodeURIComponent(n),i=document.createElement("a");i.setAttribute("href",a);let s=(e.name||"untitled").replace(/\s+/g,"_")+".json";if(t&&(s=window.prompt("Download as file?",s)),!s)return console.warn("Download canceled");i.setAttribute("download",s),document.body.appendChild(i),i.click(),i.remove()}async loadSongFromMemory(e){let t=localStorage.getItem("song:"+e);if(!t)throw new Error("Song Data not found for guid: "+e);let o=await this.decodeForStorage(t);if(!o)throw new Error("Invalid Song Data: "+t);return o}async loadSongHistoryFromMemory(e){let t=localStorage.getItem("song-history:"+e);return t?await this.decodeForStorage(t):null}async loadJSONFile(e){const t=await new Promise((t,o)=>{let r=new FileReader;r.readAsText(e),r.onload=(e=>{t(e.target.result)})});return JSON.parse(t)}}"undefined"!=typeof module&&(module.exports={AudioSourceStorage:AudioSourceStorage});class MIDISupport{constructor(){}loadMIDIInterface(e){navigator.requestMIDIAccess&&navigator.requestMIDIAccess().then(t=>{console.info("MIDI initialized",t);const o=[];t.inputs.forEach(t=>{o.push(t),t.addEventListener("midimessage",e)}),console.log("MIDI input devices detected: "+o.map(e=>e.name).join(", "))},e=>{throw new Error("error initializing MIDI: "+e)})}getCommandFromMIDINote(e){const t=Math.floor(e/12),o=e%12;return(new AudioSourceValues).noteFrequencies[o]+t}async loadMIDIFile(e){const t=new AudioSourceLibraries,o=await t.getMidiParser(),n=await new Promise((t,o)=>{let n=new FileReader;n.readAsArrayBuffer(e),n.onload=(e=>{t(e.target.result)})}),a=o.parse(new Uint8Array(n));return console.info("MIDI Data Loaded: ",a),a}async loadSongFromMidiFile(e,t=null){const o=await this.loadMIDIFile(e);return this.loadSongFromMIDIData(o,t)}loadSongFromMIDIData(e,t=null){const o={root:[]};let n=(new AudioSourceStorage).generateDefaultSong();n.instructions=o,n.timeDivision=e.timeDivision;const a=new AudioSourceSong(n);let r=0;for(let o=0;o<e.track.length;o++){const i="root",s={},c=e.track[o].event;let l=0,d=0,u=!1,I="Track "+o;for(let e=0;e<c.length;e++){const t=c[e];switch(t.type){case 8:case 9:u=!0;break;case 255:switch(t.metaType){case 3:I=t.data.trim()}}}if(!u){console.info("Skipping empty track: ",o,c);continue}const m=r++;t&&(n.instruments[m]={url:t+"",name:I});for(let e=0;e<c.length;e++){const t=c[e];switch(l+=t.deltaTime,t.type){case 8:let e=this.getCommandFromMIDINote(t.data[0]);if(s[e]){const o=s[e][0],n=s[e][1];let r=l-o;delete s[e],a.replaceInstructionDuration(i,n,r),console.log("OFF",o,t.deltaTime,e,r)}break;case 9:let o=this.getCommandFromMIDINote(t.data[0]),n=t.data[1];if(0===n&&s[o]){s[e][0];const n=s[e][1];let r=l-d;a.replaceInstructionDuration(i,n,r),console.log("OFF",d,t.deltaTime,o,r),delete s[o];break}d=l;const r=[0,o,m,0,n],c=a.insertInstructionAtPosition(i,l,r);s[o]=[l,c],console.log("ON ",l,o,n)}}}return a.data}}})();